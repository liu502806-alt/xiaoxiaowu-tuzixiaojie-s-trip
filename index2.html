<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è§å°äº”/å…”å­å°å§ã®å¥‡å¦™æ—…é€” - ä¸»é¡µé¢</title>
<style>
body {
  margin: 0;
  font-family: "Hiragino Maru Gothic Pro", "PingFang SC", sans-serif;
  background: linear-gradient(180deg, #ffe7ef, #def6ff);
  min-height: 100vh;               /* æ”¹ä¸º min-height ä»¥å…è®¸å†…å®¹è¶…å‡ºå¹¶æ»šåŠ¨ */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;    /* ä»å‚ç›´å±…ä¸­æ”¹ä¸ºé ä¸Šï¼Œé¡µé¢å¯è‡ªç„¶æ‹“å±•å¹¶æ»šåŠ¨ */
  align-items: center;
  text-align: center;
  padding: 48px 18px;             /* ç»™é¡¶éƒ¨å’Œåº•éƒ¨ç•™å‡ºç©ºé—´ */
  box-sizing: border-box;
  overflow-y: auto;               /* ç¡®ä¿çºµå‘å¯æ»šåŠ¨ */
}
/* æ–°å¢ï¼šé¡µé¢åˆå§‹çŠ¶æ€ï¼ˆæ ‡é¢˜å‚ç›´å±…ä¸­ï¼‰ */
body.home {
  justify-content: center;
  padding-top: 0;
  padding-bottom: 0;
}
.title { font-size: 2.3rem; color: #ff6ca8; text-shadow: 0 2px 6px rgba(255,150,180,0.35); animation: fadeIn 1s; margin-bottom: 30px; }
.button-group { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; }
.button-group button { background: rgba(255,255,255,0.75); border: none; padding: 14px 28px; border-radius: 20px; font-size: 1.15rem; cursor: pointer; box-shadow: 0 6px 12px rgba(255, 170, 200, 0.3); transition: .2s; }
.button-group button:hover { background: #ffe3f0; transform: scale(1.07); }
canvas { border-radius: 12px; width: 100%; }
@keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
.modeBtn { width:45px; height:45px; border-radius:50%; border:none; background:#ffffffcc; box-shadow:0 3px 8px rgba(0,0,0,0.15); font-size:20px; cursor:pointer; transition:0.25s; }
.modeBtn:hover { transform:scale(1.08); background:#ffe6f2; }
.modeBtn.active { background:#ff8fb7; color:white; }

/* é¡¶éƒ¨éŸ³é¢‘æ§åˆ¶ï¼ˆæ’­æ”¾ / é™éŸ³ï¼‰ */
#topAudioControls {
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  z-index: 99999;
}
#globalPlayBtn, #muteButton {
  width:44px;
  height:44px;
  border-radius:10px;
  border:none;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 3px 6px rgba(0,0,0,0.12);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  transition:0.18s;
}
#globalPlayBtn:hover, #muteButton:hover { transform: scale(1.06); background: rgba(255,255,255,0.95); }

/* è°ƒæ•´ playerControls å¸ƒå±€ï¼šç»¿è‰²æŒ‰é’®å±…ä¸­ï¼Œæ¨¡å¼æŒ‰é’®æ¨ªå‘å¹¶é å³ */
#playerControls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
  width: 100%;
  box-sizing: border-box;
}

/* å±…ä¸­åŒºåŸŸï¼ˆæ”¾ç»¿è‰²æŒ‰é’®ï¼‰ */
.player-controls-center {
  flex: 1 1 0%;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* æ¨¡å¼æŒ‰é’®æ¨ªå‘æ’åˆ—å¹¶é å³ */
#modeRow {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto; /* æ¨åˆ°å³ä¾§ï¼ˆåœ¨ playerControls å†…ï¼‰ */
}

/* ä¿æŒæŒ‰é’®é«˜åº¦ä¸€è‡´ */
.modeBtn { width:46px; height:46px; }

/* é™éŸ³æŒ‰é’®æ ·å¼ */
#muteButton {
  position: fixed;
  top: 15px;
  right: 15px;
  font-size: 28px;
  cursor: pointer;
  z-index: 9999;
  background: rgba(255,255,255,0.7);
  padding: 6px 10px;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
#muteButton:hover { transform: scale(1.1); background: rgba(255,255,255,0.9); }

/* é™„åŠ ï¼šé™åˆ¶ä¸»å†…å®¹å®½åº¦å¹¶å…è®¸å…¶æ’‘å¼€é¡µé¢é«˜åº¦ */
#content {
  width: 100%;
  max-width: 900px;
  box-sizing: border-box;
}

/* æ–°å¢ï¼šcover æ¡†ä¸å†…éƒ¨åœ†å½¢å›¾ç‰‡ï¼ˆä»…å†…éƒ¨åœ†æ—‹è½¬ï¼‰ */
.cover-frame {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  overflow: hidden;               /* è£åˆ‡æˆåœ†è§’æ–¹æ¡†ï¼Œå†…éƒ¨å›¾ç‰‡å¯è¶…å‡ºå¹¶è¢«é®ç›– */
  position: relative;
  margin-right: 15px;
  flex: 0 0 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.6); /* å¯è‡ªå®šä¹‰è¡¨æ¡†æ ·å¼ */
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  background: #fff;
}

/* å†…éƒ¨åœ†å½¢å›¾ç‰‡ï¼šé™åˆ¶ä¸ºä¸è¶…è¿‡æ¡†è¾¹é•¿ä¸”åªæ—‹è½¬å›¾ç‰‡æœ¬èº« */
.cover-circle {
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
  position: relative;
  left: auto;
  top: auto;
  transform: none;
  border-radius: 50%; /* åœ†å½¢ï¼Œç›´å¾„ä¸è¶…è¿‡å¤–æ¡† */
  transition: transform 0.3s;
}

/* æ—‹è½¬ä»…ä½œç”¨åœ¨å†…éƒ¨çš„ .cover-circle */
.cover-circle.rotating {
  animation: spin 6s linear infinite;
  transform-origin: 50% 50%;
}

/* å¤ç”¨å·²æœ‰ spin keyframes */
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
/* Dream è¯¦ç»†å±•å¼€æ ·å¼ */
.dream-line{ display:flex; align-items:flex-start; gap:12px; padding:8px 6px; border-bottom:1px dashed rgba(0,0,0,0.04); }
.dream-short{ flex:1; color:#444; white-space:pre-wrap; }
.detail-toggle{ background:#ffe6f2; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:6px; }
.dream-detail{ width:100%; display:none; margin-top:8px; background:rgba(255,255,255,0.96); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow:auto }
.detail-left{ width:70%; float:left; }
.detail-text{ min-height:80px; border:1px dashed #eee; padding:10px; border-radius:8px; background:#fff; color:#333; }
.detail-controls{ margin-top:8px; display:flex; gap:8px; align-items:center }
.detail-play{ background:#1DB954; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer }
.detail-right{ width:28%; float:right; display:flex; align-items:flex-start; justify-content:center }
.lang-box{ width:100%; border-left:1px solid rgba(0,0,0,0.04); padding-left:10px; color:#333 }
.dot{ width:10px; height:10px; border-radius:50%; background:#ddd; display:inline-block; margin:0 6px; }
.dream-line + .dream-detail{ margin-left:0 }

/* detail button label/icon parts */
.detail-label{ font-size:14px; color:#333; }
.detail-icon{ font-size:14px; color:#333; }
.dream-detail-btn{ display:flex; align-items:center; gap:6px; }
/* per-line wechat voice play button (green) */
.wv-play{ background:#1DB954; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
.wv-play:hover{ transform:translateY(-1px); }
</style>
</head>
<body class="home">

<h1 class="title">ğŸ±è§å°äº”/å…”å­å°å§ğŸ° ã®å¥‡å¦™æ—…é€” ğŸµ</h1>

<div class="button-group">
  <button onclick="openPage('piano')">ğŸ¹ åˆè¯ç¤¼èµ</button>
  <button class="next-btn" onclick="location.href='page2.html'">ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</button>
  <button onclick="openPage('dream')">ğŸ’­ æ€å¿µçµ®è¯­</button>
</div>

<div id="content"></div>

<!-- èƒŒæ™¯éŸ³ä¹ï¼ˆåªä¿ç•™ä¸€ä¸ªï¼‰ -->
<audio id="bgm" src="audio2.mp3" loop></audio>
<!-- æŠŠæ’­æ”¾æ›²ç›®çš„éŸ³é¢‘å…ƒç´ ç§»åˆ°é¡µé¢é™æ€ä½ç½®ï¼Œé¿å…åˆ‡æ¢é¡µé¢æ—¶è¢«ç§»é™¤ -->
<audio id="musicPlayer"></audio>

<!-- é¡¶éƒ¨å…¨å±€éŸ³é¢‘æ§åˆ¶ï¼ˆæ’­æ”¾/é™éŸ³ï¼‰ -->
<div id="topAudioControls">
  <button id="globalPlayBtn">â–¶</button>
  <button id="muteButton">ğŸ”Š</button>
</div>

<script>
/* å½“å‰é¡µé¢æ ‡è¯†ï¼ˆç”¨äºé‡å¤ç‚¹å‡»è¿”å›é¦–é¡µï¼‰ */
let currentPage = null;

/* openPage å‡½æ•°ï¼šæ ¹æ®å‚æ•°å¡«å…… #content */
function openPage(page) {
  const content = document.getElementById("content");

  // å¦‚æœé‡å¤ç‚¹å‡»å½“å‰å·²æ‰“å¼€çš„é¡µé¢ï¼Œå›åˆ°åˆå§‹é¦–é¡µçŠ¶æ€
  if (currentPage === page) {
    document.body.classList.add('home');
    content.innerHTML = "";
    currentPage = null;
    return;
  }

  // åˆ‡æ¢åˆ°ä»»æ„é¡µé¢æ—¶æŠŠé¦–é¡µå±…ä¸­çŠ¶æ€ç§»é™¤ï¼Œä½¿æ ‡é¢˜å‘ä¸Šå¹¶æ˜¾ç¤ºå†…å®¹
  document.body.classList.remove('home');
  currentPage = page;

  content.innerHTML = ""; // æ¸…ç©º

  if (page === "piano") {
    // æ ‡è®°å½“å‰é¡µé¢
    // ï¼ˆopenPage å¼€å¤´å·²ç»è®¾ç½® currentPage â€” è§åé¢ä¿®æ”¹ï¼‰
    content.innerHTML = `
     <h2>ğŸ¶ åˆè¯ç¤¼èµ</h2>
      <p>ç‚¹å¼€ä¸‹æ–¹æ›²ç›®å³å¯é¢„è§ˆé’¢ç´æ›²ã€‚</p>

      <div id="playerControls">
        <div class="player-controls-center">
          <button id="playAllBtn" style="
            height:46px;
            background:#1DB954;
            border:none;
            padding:10px 22px;
            border-radius:30px;
            color:white;
            font-size:16px;
            cursor:pointer;
            box-shadow:0 4px 10px rgba(0,0,0,0.3);
          ">â–¶ å¼€å§‹æ’­æ”¾</button>
        </div>

        <div id="modeRow">
          <button class="modeBtn" data-mode="repeat-one">ğŸ”‚</button>
          <button class="modeBtn" data-mode="repeat-all">ğŸ”</button>
          <button class="modeBtn" data-mode="shuffle">ğŸ”€</button>
        </div>
      </div>

      <div id="musicList" style="margin-top:20px;"></div>
    `;

    const musicData = [
      { name: "çº¦å®šä¹‹åˆ", file: "audio1.mp3", img: "audio1cover.jpg" },
      { name: "å½¼æ—¶çš„å¤©ç©º", file: "audio2.mp3", img: "audio2cover.jpg" },
      { name: "æ€ªè¯æ›²", file: "audio3.mp3", img: "audio3cover.jpg" },
      { name: "æ—¥æ—¥å¤œå¤œ", file: "audio4.mp3", img: "audio4cover.jpg" },
      { name: "åˆ°æ˜å¤©å»", file: "audio5.mp3", img: "audio5cover.jpg" }, 
      { name: "æ€å¿µçµ®è¯­bgm", file: "audio6.mp3", img: "audio6cover.jpg" }
    ];

    const list = document.getElementById("musicList");
    const player = document.getElementById("musicPlayer");

    // ------- moved/added: ensure currentIndex exists before any restore/bind -------
    let playMode = 'repeat-all';
    let currentIndex = -1;

    musicData.forEach((m, index) => {
      const item = document.createElement("div");
      item.className = "music-item";
      item.style.cssText = `
        display:flex; align-items:center; margin-bottom:15px; padding:12px; border-radius:14px;
        background: rgba(255, 255, 255, 0.7); box-shadow:0 3px 8px rgba(0,0,0,0.2); cursor:pointer; transition:0.25s;
      `;
      item.innerHTML = `
        <div class="cover-frame">
          <img id="cover${index}" class="cover-circle" src="${m.img}">
        </div>
        <div style="flex:1;">
          <div style="font-size:17px; font-weight:600; color:#333;">${m.name}</div>
          <div class="progress-bar" id="bar${index}" style="width:100%; height:10px; background:#eee; border-radius:6px; margin-top:10px; overflow:hidden;">
            <div id="fill${index}" style="width:0%; height:100%; background:#ff8fb7; transition:0.1s linear;"></div>
          </div>
        </div>
      `;
      item.onclick = () => playIndex(index);
      list.appendChild(item);
    });

    // persistent element reference (only once)
    const musicPlayerEl = document.getElementById('musicPlayer');

    // å¦‚æœæ’­æ”¾å™¨å½“å‰å·²ç»åœ¨æ’­æ”¾æˆ–æœ‰ srcï¼Œæ‰¾åˆ°å¯¹åº”é¡¹å¹¶æ¢å¤ rotating / progress
    function restorePlaybackUIFromPlayer() {
      // æ¸…é™¤æ—§çš„ rotating çŠ¶æ€
      document.querySelectorAll('.cover-circle').forEach(img => img.classList.remove('rotating'));

      // è®¡ç®—å½“å‰æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶åï¼ˆåªæ¯”è¾ƒå°¾éƒ¨ä»¥é¿å…ç»å¯¹ URL é—®é¢˜ï¼‰
      let currentFile = "";
      try {
        if (musicPlayerEl && musicPlayerEl.src) {
          const src = musicPlayerEl.src;
          // å…¼å®¹ä¸åŒç¯å¢ƒï¼šåªå–æœ€åä¸€æ®µï¼ˆå« query/hashï¼‰
          currentFile = src.substring(src.lastIndexOf('/') + 1);
        }
      } catch (e) { currentFile = ""; }

      // æ›´ç¨³å¥çš„åŒ¹é…ï¼šå¦‚æœæ–‡ä»¶åå°¾éƒ¨åŒ…å« musicData.file å³è§†ä¸ºåŒ¹é…
      const playingIndex = musicData.findIndex(m => currentFile && currentFile.indexOf(m.file) !== -1);
      if (playingIndex !== -1) {
        currentIndex = playingIndex;
        const img = document.getElementById('cover' + playingIndex);
        if (img) img.classList.add('rotating');
        const fillEl = document.getElementById('fill' + playingIndex);
        if (fillEl && musicPlayerEl.duration) {
          const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100 || 0;
          fillEl.style.width = pct + '%';
        }
      } else {
        currentIndex = -1;
      }
    }

    // ç»‘å®š/æ¢å¤æ’­æ”¾å™¨äº‹ä»¶ï¼ˆæ¯æ¬¡é‡å»º piano å†…å®¹éƒ½è¦ç»‘ä¸€æ¬¡ï¼‰
    function bindMusicPlayerEvents() {
      if (!musicPlayerEl) return;
      musicPlayerEl.onended = () => playNext();
      musicPlayerEl.ontimeupdate = () => {
        if (!musicPlayerEl.duration || currentIndex < 0) return;
        const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
      musicPlayerEl.addEventListener('play', () => {
        if (currentIndex >= 0) {
          const img = document.getElementById('cover' + currentIndex);
          if (img) img.classList.add('rotating');
        }
      });
      // ä¿æŒæ—‹è½¬çŠ¶æ€åœ¨ pause æ—¶ä¸è¢«ç§»é™¤ï¼ˆæŒ‰éœ€å¯å–æ¶ˆï¼‰
    }

    // æ‰§è¡Œæ¢å¤ä¸ç»‘å®šï¼ˆç°åœ¨ currentIndex å·²å£°æ˜ï¼Œrestore ä¸ä¼šæŠ›é”™ï¼‰
    bindMusicPlayerEvents();
    restorePlaybackUIFromPlayer();
    // --- ç»“æŸä¿®æ”¹ ---
    // (å·²åœ¨ä¸Šæ–¹å£°æ˜ playMode / currentIndexï¼Œç§»é™¤é‡å¤å£°æ˜)
    
    const playAllBtnEl = document.getElementById('playAllBtn');
    const modeBtnEls = Array.from(document.querySelectorAll('.modeBtn'));
    modeBtnEls.forEach(b => b.style.opacity = 0.6);
    function updateModeUI(){
      modeBtnEls.forEach(b => {
        const active = b.dataset.mode === playMode;
        b.style.opacity = active ? 1 : 0.6;
        b.style.transform = active ? 'scale(1.08)' : 'scale(1)';
        b.style.boxShadow = active ? '0 6px 14px rgba(255,140,180,0.25)' : 'none';
        b.classList.toggle('active', active);
      });
    }
    updateModeUI();
    modeBtnEls.forEach(b => b.addEventListener('click', ()=>{ playMode = b.dataset.mode; updateModeUI(); }));

    // å½“ç”¨æˆ·åœ¨ piano é¡µé¢ç‚¹å‡»å¼€å§‹æ’­æ”¾æ—¶ï¼ŒåŒæ—¶æ›´æ–° top å…¨å±€æ’­æ”¾æŒ‰é’®ä¸ºæš‚åœçŠ¶æ€
    function setGlobalPlayState(isPlaying) {
      const gp = document.getElementById('globalPlayBtn');
      if (!gp) return;
      gp.textContent = isPlaying ? 'â¸' : 'â–¶';
    }

    function playIndex(i){
      if(i < 0 || i >= musicData.length) return;
      currentIndex = i;
      const m = musicData[i];
      const bgm = document.getElementById("bgm");
      if (bgm && !bgm.paused) bgm.pause();
      player.src = m.file;
      player.play().catch(()=>{});
      // æ›´æ–°å…¨å±€æ’­æ”¾æŒ‰é’® â€” å½“å‰æœ‰éŸ³ä¹åœ¨æ’­æ”¾
      setGlobalPlayState(true);

      // åˆ‡æ¢ï¼šåªæœ‰å½“å‰æ’­æ”¾é¡¹å†…éƒ¨çš„ .cover-circle å¸¦ rotatingï¼ˆè‹¥ä½¿ç”¨äº† cover-frame å®ç°ï¼‰
      document.querySelectorAll('.music-cover, .cover-circle').forEach((img, idx) => {
        img.classList.toggle('rotating', idx === i);
      });
      document.querySelectorAll("[id^=fill]").forEach((f, idx) => {
        f.style.width = idx === i ? (player.currentTime && player.duration ? (player.currentTime/player.duration*100)+'%' : '0%') : "0%";
      });
      player.ontimeupdate = () => {
        if (!player.duration || currentIndex < 0) return;
        const pct = (player.currentTime / player.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
    }

    function playNext(){
      if(musicData.length === 0) return;
      if(playMode === 'repeat-one'){ playIndex(currentIndex); }
      else if(playMode === 'shuffle'){
        let next = Math.floor(Math.random() * musicData.length);
        if(musicData.length > 1){ while(next === currentIndex) next = Math.floor(Math.random() * musicData.length); }
        playIndex(next);
      } else {
        let next = (currentIndex + 1) % musicData.length;
        playIndex(next);
      }
    }

    // å·²åœ¨ä¸Šæ–¹å–å¾— musicPlayerElï¼Œé¿å…é‡å¤å£°æ˜
    if (typeof musicPlayerEl !== 'undefined' && musicPlayerEl) musicPlayerEl.onended = () => playNext();
    playAllBtnEl.addEventListener('click', () => { if(currentIndex === -1) playIndex(0); else playNext(); });
    document.querySelectorAll('.music-item').forEach((node, idx) => node.addEventListener('click', () => playIndex(idx)));
  }

  if (page === "dream") {
    content.innerHTML = `
      <h2 class="dream-title">ğŸŒ™ æ€å¿µçµ®è¯­</h2>

      <!-- ç« èŠ‚ 1 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">é»‘çŒ«</span>
          <!-- header: icon first, then label (â–¾) -->
          <button class="dream-detail-btn" onclick="toggleDream(0)"><span class="detail-icon">â–¾</span><span class="detail-label"></span></button>
        </div>
        <div class="dream-content" id="dreamContent0">
          <p class="dream-text">ã€€ã€€-æˆ‘æ·±ä¿¡è¿™é‚ªå¿µæ˜¯æ¥è‡ªäººæœ¬èƒ½çš„å†²åŠ¨â€”â€”ä¸€ç§ç»†å¾®çš„åŸå§‹åŠŸèƒ½...

 -æˆ–è®¸ä»æ­¤ä»¥åï¼Œæˆ‘å°±åªèƒ½è€å»¶æ®‹å–˜äº†â€”â€”éš¾é“æˆ‘çš„å‘½è¿ç«Ÿç„¶

 -æ­£å› ä¸ºæˆ‘æ·±çŸ¥å®ƒæ›¾æ·±çˆ±æˆ‘ã€æ­£å› ä¸ºæˆ‘çŸ¥æ™“æˆ‘æ— æ³•æ”¹å˜è‡ªå·±çš„æ¶å¿µ

 -å¯æ˜¯ï¼Œç¥ä¼¼ä¹ç»ˆäºæƒ³èµ·è¦è§£æ•‘æ»¡èº«ç½ªæ¶ã€è¢«æ¶é­”ç‰µç»Šçš„æˆ‘äº†â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 2 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">æ™®ç½—ç±³ä¿®æ–¯</span>
          <!-- header: icon first, then label (â–¾) -->
          <button class="dream-detail-btn" onclick="toggleDream(1)"><span class="detail-icon">â–¾</span><span class="detail-label"></span></button>
        </div>
        <div class="dream-content" id="dreamContent1">
          <p class="dream-text">ã€€ã€€-åœ¨è‹¦éš¾ä¹‹å¤–ï¼Œæ—è§‚ä»–äººçš„è‹¦ç—›ï¼Œå´åååˆè¦å¯¾æ·±é™·å…¶ä¸­çš„å—è‹¦è€….....

-å•Šï¼Œçœ‹å‘ï¼Œæœ‹å‹ï¼Œä½ çš„æ©å¾·æ˜¯å¦‚ä½•æ²’æœ‰å›åº”ï¼å‘Šè¯‰æˆ‘ï¼Œè°ä¼šæ¥ä¿æŠ¤ä½ â€¦

-é‚£ä¹ˆï¼Œä½ å°±å´‡æ‹œå§ï¼Œè‡´æ•¬å§ï¼Œæ°¸è¿œå¥‰æ‰¿é‚£æ‡¦å¼±æ®‹æš´çš„å½“æƒè€…â€¦..

-å°±è¿™æ ·ï¼Œè®©é‚£ç”µç«å†²å‡»æˆ‘å§ï¼Œè®©é‚£å¤©ç©¹åœ¨é›·éœ†å’Œé£æš´ä¸­é¢¤æŠ–â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 3 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">è€äººä¸æµ·</span>
          <!-- header: icon first, then label (â–¾) -->
          <button class="dream-detail-btn" onclick="toggleDream(2)"><span class="detail-icon">â–¾</span><span class="detail-label"></span></button>
        </div>
        <div class="dream-content" id="dreamContent2">
          <p class="dream-text">ã€€ã€€-ä»–å¯ä»¥çœ‹è§æµ·æ°´æ·±å¤„ä¸ƒè‰²çš„è™¹å…‰ï¼Œå¯ä»¥çœ‹è§é’“ç´¢å’Œé‚£æµ·é¢ä¸Šå¥‡å¦™çš„æ³¢åŠ¨â€¦â€¦

-å¥½è¿è¿™ç©æ„å„¿ï¼Œå¾€å¾€åœ¨å„ç§æ—¶åˆ»ã€ä»¥ä¸åŒå½¢å¼å‡ºç°ï¼Œè°è¯´å¾—å‡†å•Šâ€¦â€¦

-å…‰æ™¯å¤ªå¥½äº†ï¼Œå› æ­¤ä¸èƒ½å¤ŸæŒä¹…ã€‚ä½†æ„¿æˆ‘æ ¹æœ¬æ²¡æœ‰é’“ä¸Šè¿™æ¡é±¼â€¦â€¦

-ä½†æ˜¯ä½ æ¯«ä¸çŠ¹è±«åœ°æ€æ­»äº†é‚£æ¡ç™»å¤šç´¢é²¨ã€‚å³ä½¿å®ƒè·Ÿä½ ä¸€æ ·ï¼Œé åƒæ´»é±¼ç»´ç”Ÿâ€¦â€¦</p>
        </div>
      </div>
    `;

    const style = document.createElement("style");
    style.textContent = `
      .dream-container {
        width: 90%;
        margin: 0 auto;
        text-align: left;
      }
      .dream-title {
        color: #444;
        margin-bottom: 25px;
        font-size: 26px;
      }
      .dream-item {
        background: rgba(255,255,255,0.75);
        padding: 12px 18px;
        border-radius: 12px;
        margin-bottom: 14px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      }
      .dream-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dream-chapter {
        font-size: 20px;
        font-weight: bold;
      }
      .dream-detail-btn {
        border: none;
        background: #ffe6f2;
        padding: 5px 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
      }
      .dream-detail-btn:hover {
        background: #ffb7d6;
      }
      .dream-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height .35s ease;
        margin-top: 5px;
      }
      .dream-text {
        white-space: pre-wrap;
        line-height: 1.6;
        font-size: 16px;
        color: #444;
      }
    `;
    document.head.appendChild(style);

    // Transform each .dream-text into per-line items where each line has an expand symbol
    // and clicking any line's expand opens a chapter-level article (original short text stays unchanged)
    (function enrichDreamText(){
      const dreamTextEls = content.querySelectorAll('.dream-text');
      dreamTextEls.forEach((el, chapterIdx) => {
        const raw = el.textContent || '';
        const lines = raw.split(/\n+/).map(s => s.replace(/^[-ã€€\s]*/,'').trim()).filter(Boolean);

        // wrapper for lines
        const wrapper = document.createElement('div');
        wrapper.className = 'dream-lines-wrapper';

        // create a single chapter-level article panel (hidden initially)
        const chapterArticle = document.createElement('div');
        chapterArticle.className = 'chapter-article';
        // data-audio å¯ç”¨äºç›´æ¥æŒ‡å®šæœ¬ç« èŠ‚çš„è¯­éŸ³æ–‡ä»¶è·¯å¾„ï¼Œä¾‹å¦‚ï¼šchapterArticle.dataset.audio = 'audio/chapter0.mp3'
        chapterArticle.style.display = 'none';
        chapterArticle.innerHTML = `
          <div class="article-left">
            <div class="article-content" contenteditable="true">åœ¨è¿™é‡Œå¡«å†™ç« èŠ‚æ–‡ç« å†…å®¹ï¼ˆå¯ç›´æ¥ç²˜è´´/ç¼–è¾‘ï¼‰ã€‚</div>
            <div class="article-hint" style="font-size:13px;color:#666;margin-top:8px;"></div>
          </div>
          <div class="article-right">
            <div class="wechat-voice">
              <div class="wv-bubble">ç‚¹å‡»æ’­æ”¾è¯­éŸ³</div>
              <button class="wv-play">â–¶</button>
              <!-- éŸ³é¢‘ï¼šå¯æŠŠ src å†™åœ¨è¿™é‡Œï¼Œæˆ–åœ¨ chapterArticle å…ƒç´ ä¸Šè®¾ç½® data-audio å±æ€§ -->
              <audio class="wv-audio" preload="none"></audio>
            </div>
          </div>`;

        // per-line items: short text + expand symbol button
        // per-line article data (line-specific). ä¾‹å¦‚ï¼šä¸º é»‘çŒ«(ç« èŠ‚0) çš„ç¬¬ 0 è¡Œè®¾å®šæ–‡ç« å’ŒéŸ³é¢‘
        const perLineData = {};
        if (chapterIdx === 0) {
          // é»‘çŒ«ç¬¬ä¸€è¡Œçš„å±•å¼€æ–‡ç« å’ŒéŸ³é¢‘ï¼ˆç”¨æˆ·æä¾›å†…å®¹ï¼‰
          perLineData[0] = {
            text: `æˆ‘æ·±ä¿¡è¿™é‚ªå¿µæ˜¯æ¥è‡ªäººæœ¬èƒ½çš„å†²åŠ¨
â€”ä¸€ç§ç»†å¾®çš„åŸå§‹åŠŸèƒ½ï¼Œå®ƒå’Œäººçš„æœ¬æ€§å¯†ä¸å¯åˆ†ã€‚è°ä¸æ›¾åœ¨æ˜çŸ¥ä¸å¯ä¸ºçš„æƒ…å†µä¸‹ï¼Œä»æ—§çŠ¯ä¸‹æ¶è¡Œï¼Ÿè°ä¸æ˜¯å³ä¾¿æ‹¥æœ‰äººç±»æœ€å¼•ä»¥ä¸ºå‚²çš„ç†æ™ºï¼Œå´ä»å› çŸ¥æ³•ç‡ƒèµ·çŠ¯æ³•çš„æ¸´æœ›ï¼Ÿæ­£æ˜¯è¿™ä»½æ¸´æœ›ä¸€ä¸€æ¸´æœ›é¢ è¦†æœ¬æ€§ã€ä¸ºä½œæ¶è€Œä½œæ¶â€”â€”ç»ˆäºæ–­é€äº†æˆ‘çš„ä¸€ç”Ÿã€‚`,
            audio: 'hm1.mp3'
          };
          // é»‘çŒ«ç¬¬äºŒè¡Œï¼ˆlineIdx = 1ï¼‰æ–‡ç« ä¸éŸ³é¢‘ï¼ˆç”¨æˆ·æä¾›ï¼‰
          perLineData[1] = {
            text: `æˆ–è®¸ä»æ­¤ä»¥åï¼Œæˆ‘å°±åªèƒ½è‹Ÿå»¶æ®‹å˜´äº†
ä¸€ä¸€éš¾é“æˆ‘çš„å‘½è¿ç«Ÿç„¶å°±è¿™æ ·è¢«ä¸€åªåŠ¨ç‰©æŒæ§ã€æŠ˜ç£¨ï¼Ÿè¦çŸ¥é“ï¼Œæˆ‘æ˜¯ä¸Šå¸æŒ‰è‡ªå·±å½¢è±¡åˆ›é€ å‡ºæ¥çš„å´‡é«˜çš„â€œäººâ€å•Šï¼æ€»ä¹‹ï¼Œå¦‚ä»Šæˆ‘å¯¹å®ƒå®åœ¨æ¯«æ— åŠæ³•ï¼Œä¹Ÿå› æ­¤åªèƒ½åœ¨æ°¸æ— å®‰å®çš„é»‘å¤œä¸ç™½å¤©ä¸­è‹Ÿæ´»ã€‚`,
            audio: 'hm2.mp3'
          };
          // é»‘çŒ«ç¬¬ä¸‰è¡Œï¼ˆlineIdx = 2ï¼‰æ–‡ç« ä¸éŸ³é¢‘ï¼ˆç”¨æˆ·æä¾›ï¼‰
          perLineData[2] = {
            text: `æ­£å› ä¸ºæˆ‘æ·±çŸ¥å®ƒæ›¾æ·±çˆ±æˆ‘ã€æ­£å› ä¸ºæˆ‘çŸ¥æ™“æˆ‘æ— æ³•æ”¹å˜è‡ªå·±çš„æ¶å¿µï¼Œäºæ˜¯æˆ‘åŠæ­»äº†å®ƒä¸€ä¸€è¿™æ˜¯è‡´å‘½çš„ã€çœŸå®çš„ç½ªæ¶ï¼Œè¶³ä»¥è®©æˆ‘çš„çµé­‚æ°¸å •ç‚¼ç‹±ã€‚å³ä¾¿æ˜¯æœ€æ€œçˆ±ä¸–äººçš„ç¥æ˜ï¼Œä¹Ÿç»ä¸ä¼šå†å®½æ•æˆ‘`,
            audio: 'hm3.mp3'
          };

          perLineData[3] = {
            text: `å¯æ˜¯ï¼Œç¥ä¼¼ä¹ç»ˆäºæƒ³èµ·è¦è§£æ•‘æ»¡èº«ç½ªæ¶ã€è¢«æ¶é­”ç‰µç»Šçš„æˆ‘äº†ä¸€ä¸€æ•²å¢™çš„å›å“ä¹‹åï¼Œå¢™ä¸­ä¼ æ¥äº†ä¸€é˜µå“­å«ã€‚èµ·åˆï¼Œå£°éŸ³æ¨¡ç³Šè€Œæ–­ç»­ï¼Œåƒæ˜¯å­©ç«¥çš„æŠ½æ³£ï¼Œä½†å¾ˆå¿«ï¼Œé‚£å£°éŸ³å˜æˆäº†æŒç»­ä¸æ–­çš„å‡„å‰å•¸å«.â€¦.ä¼´ç€æƒŠæä¸å¾—æ„ï¼Œåªæœ‰åœ°ç‹±ä¸­å—åˆ‘è€…çš„æ‚²é¸£å’Œé­”é¬¼çš„æ¬¢å‘¼æ‰èƒ½æ··åˆå‡ºè¿™æ ·çš„å£°éŸ³ï¼`,
            audio: 'hm4.mp3'
          };
        } // <- ä¿®å¤ï¼šå…³é—­ chapterIdx === 0 çš„å—

        if (chapterIdx === 1) {
          perLineData[0] = {
            text: `ç«™åœ¨è‹¦éš¾ä¹‹å¤–ï¼Œæ—è§‚ä»–äººçš„è‹¦ç—›ï¼Œå´åååˆè¦å¯¹æ·±é™·å…¶ä¸­çš„å—è‹¦è€…æ–½åŠ ä»–ä»¬çš„è§„è¯«å’ŒåŠå‘Šï¼Œè¿™å®åœ¨æ˜¯ä»¶æ—¢å®¹æ˜“åšåˆ°ï¼Œåˆèƒ½ç»™è‡ªå·±å¸¦æ¥è«å¤§æ»¡è¶³æ„Ÿçš„äº‹æƒ…ã€‚æˆ‘æœ‰ç½ªï¼Œæˆ‘å®Œå…¨çŸ¥é“ï¼›æˆ‘æ˜¯è‡ªæ„¿åœ°ã€è‡ªè§‰åœ°çŠ¯ç½ªçš„ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä¸æ„¿åŒä½ äº‰è¾©ã€‚`,
            audio: 'plmxs1.mp3'
          };
     
          perLineData[1] = {
            text: `å•Šï¼Œçœ‹å‘ï¼Œæœ‹å‹ï¼Œä½ çš„æ©å¾·æ˜¯å¦‚ä½•æ²¡æœ‰å›åº”ï¼å‘Šè¯‰æˆ‘ï¼Œè°ä¼šæ¥ä¿æŠ¤ä½ ï¼Ÿæœç”Ÿæš®æ­»çš„å‡¡äººæ€ä¹ˆå¯èƒ½æ•‘å¾—äº†ä½ ï¼Ÿéš¾é“ä½ çœ‹ä¸å‡ºä»–ä»¬æ˜¯é‚£æ ·è½¯å¼±ï¼Œæœ‰å¦‚è™šæ¸ºçš„æ¢¦å¹»æ³¡å½±ï¼Œå°†é‚£æ˜ç›²çš„åº¸ç¢Œä¼—ç”Ÿåœ¨å…¶ä¸­ç¦é”¢ï¼Ÿâ€”â€”å‡¡äººçš„åŠ›é‡æ°¸è¿œä¸å¯èƒ½ç ´åå®™æ–¯çš„ç§©åºã€‚`,
            audio: 'plmxs2.mp3'
          };
          
          perLineData[2] = {
            text: `é‚£ä¹ˆï¼Œä½ å°±å´‡æ‹œå§ï¼Œè‡´æ•¬å§ï¼Œæ°¸è¿œå¥‰æ‰¿é‚£æ‡¦å¼±æ®‹æš´çš„å½“æƒè€…ï¼Œå‘ä»–å‘å¾®åœ°ç¥ˆç¥·å§ï¼åœ¨æˆ‘çš„çœ¼é‡Œï¼Œå®™æ–¯æ ¹æœ¬ä¸å€¼ä¸€æã€‚å°±è®©ä»–éšå¿ƒæ‰€æ¬²ï¼Œå¦‚æ„¿åœ°ç»Ÿæ²»è¿™ç¨çºµå³é€çš„æ—¶æœŸï¼›å› ä¸ºæˆ‘çŸ¥é“ï¼Œä»–åœ¨ä¼—ç¥ä¸­ä¸ºç‹çš„æ—¥å­å¹¶ä¸èƒ½é•¿ä¹…ã€‚`,
            audio: 'plmxs3.mp3'
          };

          perLineData[3] = {
            text: `å°±è¿™æ ·ï¼Œè®©é‚£ç”µç«å†²å‡»æˆ‘å§ï¼Œè®©é‚£å¤©ç©¹åœ¨é›·éœ†å’Œé£æš´ä¸­éœ‡é¢¤ï¼Œè®©é£“é£åŠ¨æ‘‡è¿™å¤§åœ°çš„æ ¹åŸºï¼Œè®©æµ·ä¸Šç‹‚æ¾œæ¾æ¹ƒï¼Œç›´å†²æ˜Ÿè¾°å¾ªè¡Œçš„è½¨è¿¹ã€‚
å®™æ–¯å®šä¸‹çš„å¿…ç„¶åŠ«æ•°ä¼šå‡­å€ŸçŒ›çƒˆçš„ç‹‚é£™å°†æˆ‘çš„èº¯ä½“å·èµ·ï¼ŒæŠ•å…¥å¹½æš—çš„å¡”å°”å¡”ç½—æ–¯â€”å¯å°½ç®¡å¦‚æ­¤ï¼Œä»–ä»ä¸èƒ½è®©æˆ‘æ­»å»ã€‚.â€¦.ä¼´ç€æƒŠæä¸å¾—æ„ï¼Œåªæœ‰åœ°ç‹±ä¸­å—åˆ‘è€…çš„æ‚²é¸£å’Œé­”é¬¼çš„æ¬¢å‘¼æ‰èƒ½æ··åˆå‡ºè¿™æ ·çš„å£°éŸ³ï¼`,
            audio: 'plmxs4.mp3'
          };
        }
        if (chapterIdx === 2) {
          perLineData[0] = {
            text: `ä»–å¯ä»¥çœ‹è§æµ·æ°´æ·±å¤„ä¸ƒè‰²çš„è™¹å…‰ï¼Œå¯ä»¥çœ‹è§é’“ç´¢å’Œé‚£æµ·é¢ä¸Šå¥‡å¦™çš„æ³¢åŠ¨ã€‚ç”±äºä¿¡é£çš„å¹åˆ®ï¼Œäº‘å—æ­£æ¸æ¸ç§¯èšï¼Œä»–æœ›è§ä¸€ç¾¤é‡ç¦½é£æ æ°´é¢ï¼Œåœ¨å¤©ç©ºä¸‹ï¼Œå®ƒä»¬çš„èº«å½±è¢«åˆ»ç”»å¾—æ¸…æ¥šï¼Œç„¶åæ¨¡ç³Šï¼Œæœ€ååˆæ˜¾ç°â€”â€”äºæ˜¯ä»–æ˜ç™½ï¼Œä¸€ä¸ªäººåœ¨æµ·ä¸Šæ˜¯æ°¸è¿œä¸ä¼šå­¤å•çš„ã€‚`,
            audio: 'lryh1.mp3'
          };
     
          perLineData[1] = {
            text: `å¥½è¿è¿™ç©æ„å„¿ï¼Œå¾€å¾€åœ¨å„ç§æ—¶åˆ»ã€ä»¥ä¸åŒå½¢å¼å‡ºç°ï¼Œè°è¯´å¾—å‡†å•Šï¼Ÿå¯æ˜¯ï¼Œä¸ç®¡ä½•æ—¶ä½•æ ·çš„å¥½è¿ï¼Œéƒ½ç»™æˆ‘ä¸€ç‚¹å„¿å§ï¼Œæˆ‘å¯ä»¥ä»˜å‡ºå®ƒéœ€è¦çš„æ‰€æœ‰ä»£ä»·ï¼Œåªæ±‚çœ‹åˆ°ç¯ç«çš„åå…‰.â€¢æˆ‘çš„æœŸå¾…å¤ªå¤šäº†ï¼Œçœ¼ä¸‹åªæœŸå¾…è¿™ä¸€ä¸ªã€‚ä»–ç«­åŠ›åå¾—èˆ’æœäº›æŒèˆµï¼Œä»–æ„Ÿåˆ°ç–¼ç—›ï¼Œå› æ­¤çŸ¥é“è‡ªå·±æ²¡æœ‰æ­»ã€‚`,
            audio: 'lryh2.mp3'
          };
          
          perLineData[2] = {
            text: `å…‰æ™¯å¤ªå¥½äº†ï¼Œå› æ­¤ä¸èƒ½å¤ŸæŒä¹…ã€‚ä½†æ„¿æˆ‘æ ¹æœ¬æ²¡æœ‰é’“ä¸Šè¿™æ¡é±¼ï¼Œè¿™ä¸€åˆ‡åªæ˜¯ä¸€åœºæ¢¦ï¼Œåªæ˜¯æˆ‘ç‹¬è‡ªèººåœ¨é‚£æ»¡é“ºäº†æ—§æŠ¥çº¸çš„åºŠä¸Šä¼‘æ†©æ—¶çš„æ€€æƒ³ã€‚
â€œç„¶è€Œï¼â€”ç„¶è€Œäººç»ä¸æ˜¯ä¸ºå¤±è´¥è€Œç”Ÿçš„ï¼Œâ€ä»–è¯´ï¼Œâ€œä¸€ä¸ªäººå¯ä»¥è¢«æ¯ç­ï¼Œä½†ä¸èƒ½è¢«æ‰“è´¥ã€‚"`,
            audio: 'lryh3.mp3'
          };

          perLineData[3] = {
            text: `ä½†æ˜¯ä½ æ¯«ä¸çŠ¹è±«åœ°æ€æ­»äº†é‚£æ¡ç™»å¤šç´¢é²¨ã€‚å³ä½¿å®ƒè·Ÿä½ ä¸€æ ·ï¼Œé åƒæ´»é±¼ç»´ç”Ÿã€‚å³ä½¿å®ƒä¸æ˜¯é£Ÿè…åŠ¨ç‰©ï¼Œä¹Ÿä¸åƒæœ‰äº›é²¨é±¼é‚£æ ·æ„šé’ä½åŠ£ä¸€ä¸€å³ä½¿å®ƒæ˜¯ç¾ä¸½ã€å´‡é«˜è€Œæ— ç•çš„ã€‚
â€œæˆ‘æ˜¯ä¸ºäº†è‡ªå«ï¼Œâ€œè€äººè¯´å‡ºå£°æ¥ï¼Œâ€œè€Œä¸”ä¸‹æ‰‹å¾ˆåˆ©ç´¢ã€‚â€å†è¯´ï¼Œæ¯æ ·ä¸œè¥¿éƒ½æ€æ­»åˆ«çš„ä¸œè¥¿ï¼Œåªæ˜¯æ–¹å¼ä¸åŒç½¢äº†ã€‚`,
            audio: 'lryh4.mp3'
          };
        }
        // æ¯è¡Œç‹¬ç«‹çš„ article æ¨¡æ¿ï¼ˆæ³¨é‡Šé‡Œæ ‡æ˜æ–‡ç« å’ŒéŸ³é¢‘æ”¾ç½®ä½ç½®ï¼‰
        const articleHTML = `
          <!-- ARTICLE: æ–‡ç« æ”¾åœ¨ .article-contentï¼ˆå¯ç¼–è¾‘ï¼‰ï¼ŒéŸ³é¢‘æ”¾åœ¨ä¸‹æ–¹ audio çš„ src æˆ–è®¾ç½®åœ¨æœ¬å…ƒç´ çš„ data-audio å±æ€§ -->
          <div class="article-left">
            <div class="article-content" contenteditable="true">åœ¨è¿™é‡Œå¡«å†™ç« èŠ‚æ–‡ç« å†…å®¹ï¼ˆå¯ç›´æ¥ç²˜è´´/ç¼–è¾‘ï¼‰ã€‚</div>
            <div class="article-hint" style="font-size:13px;color:#666;margin-top:8px;"></div>
          </div>
          <div class="article-right">
            <div class="wechat-voice">
              <div class="wv-bubble">ç‚¹å‡»æ’­æ”¾è¯­éŸ³</div>
              <button class="wv-play">â–¶</button>
              <!-- éŸ³é¢‘å…ƒç´ ï¼ˆæ¯è¡Œç‹¬ç«‹ï¼‰ï¼šå°† src æŒ‡å‘ä½ æ”¾ç½®çš„éŸ³é¢‘æ–‡ä»¶ï¼Œä¾‹å¦‚ hm1.mp3 -->
              <audio class="wv-audio" preload="none"></audio>
            </div>
          </div>`;

        lines.forEach((line, lineIdx) => {
          const lineWrap = document.createElement('div');
          lineWrap.className = 'dream-line';

          const short = document.createElement('div');
          short.className = 'dream-short';
          short.textContent = line;

          const btn = document.createElement('button');
          btn.className = 'detail-toggle';
          // per-line: label first, then icon ("è¯¦æƒ… â–¾") â€” swapped order vs header
          btn.innerHTML = '<span class="detail-label">è¯¦æƒ…</span><span class="detail-icon">â–¾</span>';

          // create an independent article panel for this line so multiple lines can be open
          const articleEl = document.createElement('div');
          articleEl.className = 'chapter-article';
          articleEl.style.display = 'none';
          articleEl.innerHTML = articleHTML;

          // toggle per-line article when clicking the button
          btn.addEventListener('click', ()=>{
            const showing = articleEl.style.display === 'block';
            const chapterContentEl = wrapper.parentNode; // this is the .dream-content element
            const bgm = document.getElementById('bgm');
            if (showing) {
              // hide this article only
              articleEl.style.display = 'none';
              const ic = btn.querySelector('.detail-icon'); if(ic) ic.textContent = 'â–¾';
              // stop this article's audio if playing and restore bgm if this audio ducked it
              try {
                const a = articleEl.querySelector('.wv-audio');
                const pb = articleEl.querySelector('.wv-play');
                if (a && !a.paused) {
                  a.pause();
                  if (pb) pb.textContent = 'â–¶';
                  try {
                    const otherMusic = document.getElementById('musicPlayer');
                    if (a.dataset.ducked && bgm && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
                    if (a.dataset.ducked && otherMusic && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
                  } catch(e){}
                  a.dataset.ducked = '';
                }
              } catch(e){}
              // if no other articles open, collapse chapter content
              try {
                const anyOpen = Array.from(wrapper.querySelectorAll('.chapter-article')).some(a=>a.style.display === 'block');
                if (!anyOpen) chapterContentEl.style.maxHeight = '0px';
              } catch(e){}
            } else {
              // populate article content & audio if preset
              try {
                const data = perLineData[lineIdx];
                const ac = articleEl.querySelector('.article-content');
                const aEl = articleEl.querySelector('.wv-audio');
                const pb = articleEl.querySelector('.wv-play');
                if (data && data.text) ac.textContent = data.text; else ac.textContent = 'åœ¨è¿™é‡Œå¡«å†™ç« èŠ‚æ–‡ç« å†…å®¹ï¼ˆå¯ç›´æ¥ç²˜è´´/ç¼–è¾‘ï¼‰ã€‚';
                if (data && data.audio) { articleEl.dataset.audio = data.audio; aEl.src = data.audio; if(pb) pb.textContent = 'â–¶'; }
                else { articleEl.removeAttribute('data-audio'); aEl.removeAttribute('src'); if(pb) pb.textContent = 'â–¶'; }
              } catch (e) {}
              // show this article (it is already in the DOM under the line)
              articleEl.style.display = 'block';
              const ic = btn.querySelector('.detail-icon'); if(ic) ic.textContent = 'â–´';
              // ensure chapter content expands to fit
              try { chapterContentEl.style.maxHeight = chapterContentEl.scrollHeight + 'px'; } catch(e){}
            }

            // update header icon: if any article in this chapter is open, set header to open
            try {
              const item = wrapper.parentNode.closest('.dream-item');
              if (item) {
                const anyOpen = Array.from(wrapper.querySelectorAll('.chapter-article')).some(a=>a.style.display === 'block');
                const headerIcon = item.querySelector('.dream-detail-btn .detail-icon');
                if (headerIcon) headerIcon.textContent = anyOpen ? 'â–´' : 'â–¾';
              }
            } catch(e){}
          });

          lineWrap.appendChild(short);
          lineWrap.appendChild(btn);
          wrapper.appendChild(lineWrap);
          // insert per-line article element (hidden by default)
          wrapper.appendChild(articleEl);

          // wire up play button for this articleEl (per-line)
          (function bindPerLineAudio(aEl){
            const playBtnLocal = aEl.querySelector('.wv-play');
            const audioElLocal = aEl.querySelector('.wv-audio');
            // if data-audio preset exists on the element, apply it
            const dasrcLocal = aEl.getAttribute('data-audio');
            if (dasrcLocal && dasrcLocal.trim()) audioElLocal.src = dasrcLocal;
            playBtnLocal && playBtnLocal.addEventListener('click', ()=>{
              const bgm = document.getElementById('bgm');
              if (!audioElLocal.src) { alert('è¯·ä¸ºæœ¬è¡Œè®¾ç½®éŸ³é¢‘ï¼šåœ¨å¯¹åº”çš„è¡Œå…ƒç´ è®¾ç½® data-audio="path/to/file.mp3" æˆ–æŠŠ src å†™å…¥ <audio>ã€‚'); return; }
              if (audioElLocal.paused) {
                // stop any other playing per-line audios and restore their ducked bgm/music if needed
                document.querySelectorAll('.wv-audio').forEach(o => {
                  try {
                    if (o !== audioElLocal && !o.paused) {
                      // if that other audio had ducked background players, restore volumes
                      if (o.dataset.ducked) {
                        const otherMusic = document.getElementById('musicPlayer');
                        try { if (bgm && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; } } catch(e){}
                        try { if (otherMusic && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; } } catch(e){}
                        o.dataset.ducked = '';
                      }
                      o.pause();
                      const otherBtn = o.closest('.chapter-article')?.querySelector('.wv-play');
                      if (otherBtn) otherBtn.textContent = 'â–¶';
                    }
                  } catch(e){}
                });
                // duck background music and any musicPlayer (store previous volumes if not already stored)
                try {
                  const otherMusic = document.getElementById('musicPlayer');
                  if (bgm && typeof bgm.dataset.prevVolume === 'undefined') bgm.dataset.prevVolume = String(typeof bgm.volume !== 'undefined' ? bgm.volume : 1);
                  if (otherMusic && typeof otherMusic.dataset.prevVolume === 'undefined') otherMusic.dataset.prevVolume = String(typeof otherMusic.volume !== 'undefined' ? otherMusic.volume : 1);
                } catch(e){}
                try { if (bgm) bgm.volume = 0.15; const otherMusic = document.getElementById('musicPlayer'); if (otherMusic) otherMusic.volume = 0.15; } catch(e){}
                audioElLocal.play().catch(()=>{});
                playBtnLocal.textContent = 'â¸';
                audioElLocal.dataset.ducked = 'true';
              } else {
                audioElLocal.pause();
                playBtnLocal.textContent = 'â–¶';
                // restore bgm and musicPlayer only if this audio had ducked them
                try {
                  const otherMusic = document.getElementById('musicPlayer');
                  if (bgm && audioElLocal.dataset.ducked && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
                  if (otherMusic && audioElLocal.dataset.ducked && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
                } catch(e){}
                audioElLocal.dataset.ducked = '';
              }
            });
            audioElLocal.addEventListener('ended', ()=>{
              const bgm = document.getElementById('bgm');
              try {
                const otherMusic = document.getElementById('musicPlayer');
                if (bgm && audioElLocal.dataset.ducked && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
                if (otherMusic && audioElLocal.dataset.ducked && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
              } catch(e){}
              const pb = aEl.querySelector('.wv-play'); if (pb) pb.textContent = 'â–¶';
              audioElLocal.dataset.ducked = '';
            });
          })(articleEl);
        });

  // insert wrapper in place of original element; per-line article panels already appended into wrapper
  el.parentNode.replaceChild(wrapper, el);
    });
    })();
  }

  if (page === "game") {
    startGame(content);
  }
}

/* toggleDream å‡½æ•°ï¼šå±•å¼€/æ”¶èµ·ç« èŠ‚å†…å®¹ */
function toggleDream(i) {
  const content = document.getElementById("dreamContent" + i);

  if (!content) return;

  if (content.style.maxHeight && content.style.maxHeight !== "0px") {
    content.style.maxHeight = "0px";
  } else {
    content.style.maxHeight = content.scrollHeight + "px";
  }

  // åŒæ­¥ header æŒ‰é’®çš„å›¾æ ‡ (icon) æ˜¾ç¤ºï¼šæ‰¾åˆ°å¯¹åº”çš„ .dream-item å¹¶åˆ‡æ¢å…¶ .detail-icon
  try {
    const item = content.closest('.dream-item');
    if (item) {
      const headerIcon = item.querySelector('.dream-detail-btn .detail-icon');
      if (headerIcon) {
        const open = content.style.maxHeight && content.style.maxHeight !== '0px';
        headerIcon.textContent = open ? 'â–´' : 'â–¾';
      }
    }
  } catch (e) { /* ignore if not found */ }
}

/* æ¸¸æˆé€»è¾‘ï¼ˆä¸åŸå§‹ç‰ˆæœ¬ç›¸åŒï¼‰ */
function startGame(container) {
  container.innerHTML = `
    <h2>ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</h2>
    <canvas id="gameCanvas" width="350" height="450" style="border:2px solid #555; border-radius:12px; background:url('background.jpg'); background-size:cover;"></canvas>
    <p>ç”¨ â† â†’ æ§åˆ¶ç¯®å­æ¥é‡‘å¸ï¼</p>
  `;
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const basket = { x: 140, y: 390, width: 80, height: 40, img: new Image() };
  basket.img.src = "basket.png";
  const coin = { x: Math.random() * 310, y: 0, size: 30, img: new Image() };
  coin.img.src = "coin.png";
  let score = 0, rightPressed = false, leftPressed = false;
  document.addEventListener("keydown", e => { if (e.key === "ArrowRight") rightPressed = true; if (e.key === "ArrowLeft") leftPressed = true; });
  document.addEventListener("keyup", e => { if (e.key === "ArrowRight") rightPressed = false; if (e.key === "ArrowLeft") leftPressed = false; });
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(basket.img, basket.x, basket.y, basket.width, basket.height);
    ctx.drawImage(coin.img, coin.x, coin.y, coin.size, coin.size);
    ctx.fillStyle = "white"; ctx.font = "18px Arial"; ctx.fillText("åˆ†æ•°: " + score, 10, 25);
  }
  function update() {
    coin.y += 3;
    if (coin.y + coin.size > basket.y && coin.x + coin.size > basket.x && coin.x < basket.x + basket.width) {
      score++; coin.y = 0; coin.x = Math.random() * 310;
    }
    if (coin.y > canvas.height) { coin.y = 0; coin.x = Math.random() * 310; }
    if (rightPressed && basket.x < canvas.width - basket.width) basket.x += 5;
    if (leftPressed && basket.x > 0) basket.x -= 5;
    draw();
    requestAnimationFrame(update);
  }
  update();
}

/* é¡¶éƒ¨å…¨å±€æ’­æ”¾/é™éŸ³ æ§åˆ¶ï¼šç»Ÿä¸€ç®¡ç† bgm å’Œ musicPlayer */
const globalPlayBtn = document.getElementById('globalPlayBtn');
const muteBtn = document.getElementById('muteButton');
const bgmEl = document.getElementById('bgm');
const musicEl = document.getElementById('musicPlayer');

function anyAudioPlaying() {
  return (musicEl && musicEl.src && !musicEl.paused) || (bgmEl && !bgmEl.paused);
}

globalPlayBtn.addEventListener('click', () => {
  // å¦‚æœä»»æ„éŸ³é¢‘åœ¨æ’­æ”¾ -> æš‚åœå…¨éƒ¨ï¼›å¦åˆ™ä¼˜å…ˆå°è¯•æ¢å¤ musicPlayerï¼ˆè‹¥æœ‰ srcï¼‰ï¼Œå¦åˆ™æ’­æ”¾ bgm
  if (anyAudioPlaying()) {
    if (musicEl && !musicEl.paused) { musicEl.pause(); }
    if (bgmEl && !bgmEl.paused) { bgmEl.pause(); }
    globalPlayBtn.textContent = 'â–¶';
  } else {
    if (musicEl && musicEl.src) {
      musicEl.play().catch(()=>{});
    } else if (bgmEl) {
      bgmEl.play().catch(()=>{});
    }
    globalPlayBtn.textContent = 'â¸';
  }
});

/* é™éŸ³åŒæ—¶ä½œç”¨äºå…¨éƒ¨éŸ³é¢‘ */
muteBtn.addEventListener('click', () => {
  if (!bgmEl && !musicEl) return;
  const muted = !( (bgmEl && bgmEl.muted) || (musicEl && musicEl.muted) );
  if (bgmEl) bgmEl.muted = muted;
  if (musicEl) musicEl.muted = muted;
  muteBtn.textContent = muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
});

/* å½“ä»»æ„æ’­æ”¾å™¨æ’­æ”¾/æš‚åœæ—¶ï¼ŒåŒæ­¥æ›´æ–°å…¨å±€æ’­æ”¾æŒ‰é’®çŠ¶æ€ */
if (musicEl) {
  musicEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  musicEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}
if (bgmEl) {
  bgmEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  bgmEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}

/* ä¿æŒåŸæœ‰è‡ªåŠ¨æ’­æ”¾æ¿€æ´»é€»è¾‘ï¼šé¦–æ¬¡ç‚¹å‡»é¡µé¢æ¿€æ´»èƒŒæ™¯éŸ³ä¹ï¼ˆä¸å½±å“ globalPlayBtn å·²å­˜åœ¨é€»è¾‘ï¼‰ */
document.addEventListener("click", function () {
  if (bgmEl && bgmEl.paused) bgmEl.play().catch(()=>{});
}, { once: true });
</script>
</body>
</html>
