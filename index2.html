<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è§å°äº”/å…”å­å°å§ã®å¥‡å¦™æ—…é€” - ä¸»é¡µé¢</title>
<style>
:root{
  --bg-1: #fff0f6;
  --accent: #ff8fb7;
  --accent-2: #ff70a5;
  --card-bg: rgba(255,255,255,0.75);
  --card-shadow: 0 8px 20px rgba(255, 180, 200, 0.45);
}
body {
  margin: 0;
  font-family: "Hiragino Maru Gothic Pro", "PingFang SC", sans-serif;
  background: linear-gradient(180deg, #ffe7ef, #def6ff);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  text-align: center;
  padding: 48px 18px;
  box-sizing: border-box;
  overflow-y: auto;
}
body.home {
  justify-content: center;
  padding-top: 0;
  padding-bottom: 0;
}
.title { font-size: 2.3rem; color: #ff6ca8; text-shadow: 0 2px 6px rgba(255,150,180,0.35); animation: fadeIn 1s; margin-bottom: 30px; }
.button-group { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; transition: transform .22s; }
.button-group.shift-up { transform: translateY(0); } /* ä¿æŒä¸ title çš„é—´è·ä¸å˜ï¼ˆshift-up ä¸å†ç§»åŠ¨ï¼‰ */
.button-group button { background: rgba(255,255,255,0.75); border: none; padding: 14px 28px; border-radius: 20px; font-size: 1.15rem; cursor: pointer; box-shadow: 0 6px 12px rgba(255, 170, 200, 0.3); transition: .2s; }
.button-group button:hover { background: #ffe3f0; transform: scale(1.07); }
canvas { border-radius: 12px; width: 100%; }
@keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
.modeBtn { width:45px; height:45px; border-radius:50%; border:none; background:#ffffffcc; box-shadow:0 3px 8px rgba(0,0,0,0.15); font-size:20px; cursor:pointer; transition:0.25s; }
.modeBtn:hover { transform:scale(1.08); background:#ffe6f2; }
.modeBtn.active { background:#ff8fb7; color:white; }

#topAudioControls {
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  z-index: 99999;
}
#globalPlayBtn, #muteButton {
  width:44px;
  height:44px;
  border-radius:10px;
  border:none;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 3px 6px rgba(0,0,0,0.12);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  transition:0.18s;
}
#globalPlayBtn:hover, #muteButton:hover { transform: scale(1.06); background: rgba(255,255,255,0.95); }

/* é¡¶éƒ¨éŸ³é¢‘è¿›åº¦æ¡ï¼ˆå°æ¡å½¢ï¼‰ */
.audio-progress{ position: absolute; right: 8px; top: 54px; width: 72px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 999px; overflow:hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
.audio-progress i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, rgba(255,140,170,0.95), rgba(255,110,150,0.95)); transition: width .12s linear; }

#playerControls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
  width: 100%;
  box-sizing: border-box;
}
.player-controls-center {
  flex: 1 1 0%;
  display: flex;
  justify-content: center;
  align-items: center;
}
#modeRow {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto;
}
.modeBtn { width:46px; height:46px; }

#muteButton {
  position: fixed;
  top: 15px;
  right: 15px;
  font-size: 28px;
  cursor: pointer;
  z-index: 9999;
  background: rgba(255,255,255,0.7);
  padding: 6px 10px;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
#muteButton:hover { transform: scale(1.1); background: rgba(255,255,255,0.9); }

#content {
  width: 100%;
  max-width: 900px;
  box-sizing: border-box;
}

/* cover / rotating */
.cover-frame {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  margin-right: 15px;
  flex: 0 0 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  background: #fff;
}
.cover-circle {
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
  position: relative;
  left: auto;
  top: auto;
  transform: none;
  border-radius: 50%;
  transition: transform 0.3s;
}
.cover-circle.rotating {
  animation: spin 6s linear infinite;
  transform-origin: 50% 50%;
}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Dream ç›¸å…³æ ·å¼ï¼ˆåŸæœ‰ + æ–°å¢é€‰æ‹©å¼¹å±‚æ ·å¼ï¼‰ */
.dream-line{ display:flex; align-items:flex-start; gap:12px; padding:8px 6px; border-bottom:1px dashed rgba(0,0,0,0.04); }
.dream-short{ flex:1; color:#444; white-space:pre-wrap; }
.detail-toggle{ background:#ffe6f2; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:6px; }
.dream-detail{ width:100%; display:none; margin-top:8px; background:rgba(255,255,255,0.96); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow:auto }
.detail-left{ width:70%; float:left; }
.detail-text{ min-height:80px; border:1px dashed #eee; padding:10px; border-radius:8px; background:#fff; color:#333; }
.detail-controls{ margin-top:8px; display:flex; gap:8px; align-items:center }
.detail-play{ background:#1DB954; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer }
.detail-right{ width:28%; float:right; display:flex; align-items:flex-start; justify-content:center }
.lang-box{ width:100%; border-left:1px solid rgba(0,0,0,0.04); padding-left:10px; color:#333 }
.dot{ width:10px; height:10px; border-radius:50%; background:#ddd; display:inline-block; margin:0 6px; }
.dream-line + .dream-detail{ margin-left:0 }
.detail-label{ font-size:14px; color:#333; }
.detail-icon{ font-size:14px; color:#333; }
.dream-detail-btn{ display:flex; align-items:center; gap:6px; }
.wv-play{ background:#1DB954; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
.wv-play:hover{ transform:translateY(-1px); }

/* æ–°å¢ï¼šå¼¹å±‚ï¼ˆé€‰æ‹©è§é€¸ / é™†æ²‰ï¼‰ */
.overlay-dream {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.50);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100001; /* above topAudioControls */
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
}
.dream-choice {
  display:flex;
  gap:20px;
  align-items:center;
}
.choice-btn {
  min-width: 220px;
  min-height: 84px;
  padding: 18px 34px;
  border-radius: 16px;
  font-size: 22px;
  border: none;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  transition: transform .15s, box-shadow .15s, background .12s;
  color: #ffd700; /* brighter gold text for choice labels */
}
.choice-btn:hover { transform: translateY(-6px); box-shadow: 0 18px 48px rgba(0,0,0,0.32); }
.choice-xy {
  /* ä½¿ç”¨ç¨å¾®åæ·±ä¸€äº›çš„è‰²è°ƒï¼Œé¿å…å¤ªäº® */
  background: #4fd6b8; /* è¾ƒæ·±çš„é’ç»¿è‰² */
  border: 2px solid rgba(0,0,0,0.06);
  color: #ffd700;
}
.choice-lc {
  /* ä½¿ç”¨ç¨å¾®åæ·±ä¸€äº›çš„è‰²è°ƒï¼Œé¿å…å¤ªäº® */
  background: #ff4f66; /* è¾ƒæ·±çš„çŠç‘š/ç²‰çº¢ */
  border: 2px solid rgba(0,0,0,0.06);
  color: #ffd700;
}

/* å°å±é€‚é… */
@media (max-width:520px){
  .choice-btn { min-width: 140px; min-height: 60px; font-size:18px; padding:12px 18px; }
  .button-group.shift-up { transform: translateY(0); }
}

button {
  transition: transform .18s ease, box-shadow .18s ease;
}
button:active { transform: translateY(1px) scale(.99); }
button::after{
  content: ""; position: absolute; left:0; right:0; top:0; bottom:0;
  border-radius: inherit; pointer-events:none; transition: opacity .28s;
  opacity: 0;
}
button:focus{ outline: none; box-shadow: 0 0 0 6px rgba(255,140,170,0.14); }
</style>
</head>
<body class="home">

<div class="opening-note">å¸Œæœ›ä½ äº«å—è¿™ä¸ªç½‘ç«™ï¼Œæ¬¢è¿æä¾›å®è´µçš„æ„è§ã€‚æ‚¨çš„æ¬¢ä¹å°±æ˜¯æˆ‘çš„åŠ¨åŠ›ã€‚
                                                                         â€”â€”â€”â€” é¤æ¤…å“¥
</div>

<h1 class="title">ğŸ±è§å°äº”/å…”å­å°å§ğŸ° ã®å¥‡å¦™æ—…é€” ğŸµ</h1>

<div class="button-group" id="topButtons">
  <button onclick="openPage('piano')">ğŸ¹ åˆè¯ç¤¼èµ</button>
  <button class="next-btn" onclick="location.href='page2.html'">ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</button>
  <button onclick="openPage('dream')">ğŸ’­ æ€å¿µçµ®è¯­/é›¾åŸä¹¦å£°</button>
</div>

<div id="content"></div>

<audio id="bgm" src="audio2.mp3" loop></audio>
<audio id="musicPlayer"></audio>

<div id="topAudioControls">
  <button id="globalPlayBtn">â–¶</button>
  <button id="muteButton">ğŸ”Š</button>
  <div id="audioProgress" class="audio-progress" aria-hidden="true"><i></i></div>
</div>

<script>
let currentPage = null;
let dreamVariant = null; // 'xy' æˆ– 'lc'ï¼ˆé™†æ²‰ï¼‰
let dreamFirstClickDone = false; // track whether the first dream click has occurred

function openPage(page) {
  const content = document.getElementById("content");

  if (currentPage === page) {
    // å¦‚æœå½“å‰é¡µé¢å°±æ˜¯è¦åˆ‡æ¢åˆ°çš„é¡µé¢ï¼ˆä¾‹å¦‚å†æ¬¡ç‚¹å‡» 'dream'ï¼‰ï¼Œå…ˆç¡®ä¿ä»»ä½•å¼¹çª—è¢«ç§»é™¤åå†å›åˆ°é¦–é¡µ
    try {
      const existingPopover = document.getElementById('dreamPopover');
      if (existingPopover) closeDreamOverlay();
    } catch (e) {}
    document.body.classList.add('home');
    content.innerHTML = "";
    currentPage = null;
    return;
  }

  document.body.classList.remove('home');
  currentPage = page;
  content.innerHTML = "";
if (page === "piano") {
    // æ ‡è®°å½“å‰é¡µé¢
    // ï¼ˆopenPage å¼€å¤´å·²ç»è®¾ç½® currentPage â€” è§åé¢ä¿®æ”¹ï¼‰
    content.innerHTML = `
     <h2>ğŸ¶ åˆè¯ç¤¼èµ</h2>
      <p>ç‚¹å¼€ä¸‹æ–¹æ›²ç›®å³å¯é¢„è§ˆé’¢ç´æ›²ã€‚</p>

      <div id="playerControls">
        <div class="player-controls-center">
          <button id="playAllBtn" style="
            height:46px;
            background:#1DB954;
            border:none;
            padding:10px 22px;
            border-radius:30px;
            color:white;
            font-size:16px;
            cursor:pointer;
            box-shadow:0 4px 10px rgba(0,0,0,0.3);
          ">â–¶ å¼€å§‹æ’­æ”¾</button>
        </div>

        <div id="modeRow">
          <button class="modeBtn" data-mode="repeat-one">ğŸ”‚</button>
          <button class="modeBtn" data-mode="repeat-all">ğŸ”</button>
          <button class="modeBtn" data-mode="shuffle">ğŸ”€</button>
        </div>
      </div>

      <div id="musicList" style="margin-top:20px;"></div>
    `;

    const musicData = [
      { name: "çº¦å®šä¹‹åˆ", file: "audio1.mp3", img: "audio1cover.jpg" },
      { name: "å½¼æ—¶çš„å¤©ç©º", file: "audio2.mp3", img: "audio2cover.jpg" },
      { name: "æ€ªè¯æ›²", file: "audio3.mp3", img: "audio3cover.jpg" },
      { name: "æ—¥æ—¥å¤œå¤œ", file: "audio4.mp3", img: "audio4cover.jpg" },
      { name: "åˆ°æ˜å¤©å»", file: "audio5.mp3", img: "audio5cover.jpg" }, 
      { name: "æ€å¿µçµ®è¯­bgm", file: "audio6.mp3", img: "audio6cover.jpg" },
      { name: "é›¾åŸä¹¦å£°bgm", file: "audio7.mp3", img: "audio7cover.jpg" }
    ];

    const list = document.getElementById("musicList");
    const player = document.getElementById("musicPlayer");

    // ------- moved/added: ensure currentIndex exists before any restore/bind -------
    let playMode = 'repeat-all';
    let currentIndex = -1;

    musicData.forEach((m, index) => {
      const item = document.createElement("div");
      item.className = "music-item";
      item.style.cssText = `
        display:flex; align-items:center; margin-bottom:15px; padding:12px; border-radius:14px;
        background: rgba(255, 255, 255, 0.7); box-shadow:0 3px 8px rgba(0,0,0,0.2); cursor:pointer; transition:0.25s;
      `;
      item.innerHTML = `
        <div class="cover-frame">
          <img id="cover${index}" class="cover-circle" src="${m.img}">
        </div>
        <div style="flex:1;">
          <div style="font-size:17px; font-weight:600; color:#333;">${m.name}</div>
          <div class="progress-bar" id="bar${index}" style="width:100%; height:10px; background:#eee; border-radius:6px; margin-top:10px; overflow:hidden;">
            <div id="fill${index}" style="width:0%; height:100%; background:#ff8fb7; transition:0.1s linear;"></div>
          </div>
        </div>
      `;
      item.onclick = () => playIndex(index);
      list.appendChild(item);
    });

    // persistent element reference (only once)
    const musicPlayerEl = document.getElementById('musicPlayer');

    // å¦‚æœæ’­æ”¾å™¨å½“å‰å·²ç»åœ¨æ’­æ”¾æˆ–æœ‰ srcï¼Œæ‰¾åˆ°å¯¹åº”é¡¹å¹¶æ¢å¤ rotating / progress
    function restorePlaybackUIFromPlayer() {
      // æ¸…é™¤æ—§çš„ rotating çŠ¶æ€
      document.querySelectorAll('.cover-circle').forEach(img => img.classList.remove('rotating'));

      // è®¡ç®—å½“å‰æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶åï¼ˆåªæ¯”è¾ƒå°¾éƒ¨ä»¥é¿å…ç»å¯¹ URL é—®é¢˜ï¼‰
      let currentFile = "";
      try {
        if (musicPlayerEl && musicPlayerEl.src) {
          const src = musicPlayerEl.src;
          // å…¼å®¹ä¸åŒç¯å¢ƒï¼šåªå–æœ€åä¸€æ®µï¼ˆå« query/hashï¼‰
          currentFile = src.substring(src.lastIndexOf('/') + 1);
        }
      } catch (e) { currentFile = ""; }

      // æ›´ç¨³å¥çš„åŒ¹é…ï¼šå¦‚æœæ–‡ä»¶åå°¾éƒ¨åŒ…å« musicData.file å³è§†ä¸ºåŒ¹é…
      const playingIndex = musicData.findIndex(m => currentFile && currentFile.indexOf(m.file) !== -1);
      if (playingIndex !== -1) {
        currentIndex = playingIndex;
        const img = document.getElementById('cover' + playingIndex);
        if (img) img.classList.add('rotating');
        const fillEl = document.getElementById('fill' + playingIndex);
        if (fillEl && musicPlayerEl.duration) {
          const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100 || 0;
          fillEl.style.width = pct + '%';
        }
      } else {
        currentIndex = -1;
      }
    }

    // ç»‘å®š/æ¢å¤æ’­æ”¾å™¨äº‹ä»¶ï¼ˆæ¯æ¬¡é‡å»º piano å†…å®¹éƒ½è¦ç»‘ä¸€æ¬¡ï¼‰
    function bindMusicPlayerEvents() {
      if (!musicPlayerEl) return;
      musicPlayerEl.onended = () => playNext();
      musicPlayerEl.ontimeupdate = () => {
        if (!musicPlayerEl.duration || currentIndex < 0) return;
        const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
      musicPlayerEl.addEventListener('play', () => {
        if (currentIndex >= 0) {
          const img = document.getElementById('cover' + currentIndex);
          if (img) img.classList.add('rotating');
        }
      });
      // ä¿æŒæ—‹è½¬çŠ¶æ€åœ¨ pause æ—¶ä¸è¢«ç§»é™¤ï¼ˆæŒ‰éœ€å¯å–æ¶ˆï¼‰
    }

    // æ‰§è¡Œæ¢å¤ä¸ç»‘å®šï¼ˆç°åœ¨ currentIndex å·²å£°æ˜ï¼Œrestore ä¸ä¼šæŠ›é”™ï¼‰
    bindMusicPlayerEvents();
    restorePlaybackUIFromPlayer();
    // --- ç»“æŸä¿®æ”¹ ---
    // (å·²åœ¨ä¸Šæ–¹å£°æ˜ playMode / currentIndexï¼Œç§»é™¤é‡å¤å£°æ˜)
    
    const playAllBtnEl = document.getElementById('playAllBtn');
    const modeBtnEls = Array.from(document.querySelectorAll('.modeBtn'));
    modeBtnEls.forEach(b => b.style.opacity = 0.6);
    function updateModeUI(){
      modeBtnEls.forEach(b => {
        const active = b.dataset.mode === playMode;
        b.style.opacity = active ? 1 : 0.6;
        b.style.transform = active ? 'scale(1.08)' : 'scale(1)';
        b.style.boxShadow = active ? '0 6px 14px rgba(255,140,180,0.25)' : 'none';
        b.classList.toggle('active', active);
      });
    }
    updateModeUI();
    modeBtnEls.forEach(b => b.addEventListener('click', ()=>{ playMode = b.dataset.mode; updateModeUI(); }));

    // å½“ç”¨æˆ·åœ¨ piano é¡µé¢ç‚¹å‡»å¼€å§‹æ’­æ”¾æ—¶ï¼ŒåŒæ—¶æ›´æ–° top å…¨å±€æ’­æ”¾æŒ‰é’®ä¸ºæš‚åœçŠ¶æ€
    function setGlobalPlayState(isPlaying) {
      const gp = document.getElementById('globalPlayBtn');
      if (!gp) return;
      gp.textContent = isPlaying ? 'â¸' : 'â–¶';
    }

    function playIndex(i){
      if(i < 0 || i >= musicData.length) return;
      currentIndex = i;
      const m = musicData[i];
      const bgm = document.getElementById("bgm");
      if (bgm && !bgm.paused) bgm.pause();
      player.src = m.file;
      player.play().catch(()=>{});
      // æ›´æ–°å…¨å±€æ’­æ”¾æŒ‰é’® â€” å½“å‰æœ‰éŸ³ä¹åœ¨æ’­æ”¾
      setGlobalPlayState(true);

      // åˆ‡æ¢ï¼šåªæœ‰å½“å‰æ’­æ”¾é¡¹å†…éƒ¨çš„ .cover-circle å¸¦ rotatingï¼ˆè‹¥ä½¿ç”¨äº† cover-frame å®ç°ï¼‰
      document.querySelectorAll('.music-cover, .cover-circle').forEach((img, idx) => {
        img.classList.toggle('rotating', idx === i);
      });
      document.querySelectorAll("[id^=fill]").forEach((f, idx) => {
        f.style.width = idx === i ? (player.currentTime && player.duration ? (player.currentTime/player.duration*100)+'%' : '0%') : "0%";
      });
      player.ontimeupdate = () => {
        if (!player.duration || currentIndex < 0) return;
        const pct = (player.currentTime / player.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
    }

    function playNext(){
      if(musicData.length === 0) return;
      if(playMode === 'repeat-one'){ playIndex(currentIndex); }
      else if(playMode === 'shuffle'){
        let next = Math.floor(Math.random() * musicData.length);
        if(musicData.length > 1){ while(next === currentIndex) next = Math.floor(Math.random() * musicData.length); }
        playIndex(next);
      } else {
        let next = (currentIndex + 1) % musicData.length;
        playIndex(next);
      }
    }

    // å·²åœ¨ä¸Šæ–¹å–å¾— musicPlayerElï¼Œé¿å…é‡å¤å£°æ˜
    if (typeof musicPlayerEl !== 'undefined' && musicPlayerEl) musicPlayerEl.onended = () => playNext();
    playAllBtnEl.addEventListener('click', () => { if(currentIndex === -1) playIndex(0); else playNext(); });
    document.querySelectorAll('.music-item').forEach((node, idx) => node.addEventListener('click', () => playIndex(idx)));
  }

  if (page === "dream") {
    // å¦‚æœå¼¹çª—å·²å­˜åœ¨ï¼Œå†æ¬¡ç‚¹å‡»é¡¶éƒ¨çš„ dream æŒ‰é’®åº”å…³é—­å¼¹çª—å¹¶å›åˆ°é¦–é¡µï¼ˆåŒæ—¶ç§»é™¤å¼¹çª—å†…çš„ä¸¤ä¸ªé€‰æ‹©æŒ‰é’®ï¼‰
    const existingPopover = document.getElementById('dreamPopover');
    const contentEl = document.getElementById('content');
    if (existingPopover) {
      // å…³é—­å¼¹çª—å¹¶æ¢å¤é¦–é¡µçŠ¶æ€
      closeDreamOverlay();
      document.body.classList.add('home');
      currentPage = null;
      if (contentEl) contentEl.innerHTML = '';
      return;
    }
    showDreamChoiceOverlay();
    return;
  }

  if (page === "game") {
    startGame(content);
  }
}

/* å¼¹å±‚ / æµ®å±‚ï¼šé€‰æ‹© è§é€¸ / é™†æ²‰ */
function showDreamChoiceOverlay(){
  // ç»Ÿä¸€ä½¿ç”¨æ— æ¨¡ç³Šçš„å±…ä¸­ popoverï¼ˆä¸æ”¹å˜ title ä¸æŒ‰é’®ç»„çš„é—´è·ï¼‰
  const btnGroup = document.getElementById('topButtons');

  // å¦‚æœå·²æœ‰ popoverï¼Œå…ˆç§»é™¤ä»¥é¿å…é‡å¤
  const existing = document.getElementById('dreamPopover');
  if (existing) {
    if (existing._docClickHandler) document.removeEventListener('click', existing._docClickHandler, { capture: true });
    existing.remove();
  }

  const pop = document.createElement('div');
  pop.className = 'dream-popover';
  pop.id = 'dreamPopover';
  pop.innerHTML = `
    <div class="dream-choice" role="dialog" aria-label="é€‰æ‹©è§’è‰²">
      <button class="choice-btn choice-xy" id="btnXY">è§é€¸</button>
      <button class="choice-btn choice-lc" id="btnLC">é™†æ²‰</button>
    </div>
  `;

  // å›ºå®šå±…ä¸­æ˜¾ç¤ºï¼ˆä¸¤æŒ‰é’®ä¿æŒåœ¨é¡µé¢ä¸­é—´ï¼‰ï¼Œä¸ä½¿ç”¨é®ç½©æˆ–æ¨¡ç³Š
  pop.style.position = 'fixed';
  pop.style.top = '50%';
  pop.style.left = '50%';
  pop.style.transform = 'translate(-50%, -50%)';
  pop.style.zIndex = 10000;
  pop.style.background = 'transparent';
  pop.style.padding = '0';
  pop.style.borderRadius = '0';
  pop.style.boxShadow = 'none';
  pop.style.pointerEvents = 'auto';
  document.body.appendChild(pop);

  // ç‚¹å‡»é¡µé¢ä»»æ„é pop åŒºåŸŸæ—¶å…³é—­
  const docClickHandler = (e) => {
    // Ignore clicks inside the popover or the top button group
    if (!pop.contains(e.target) && e.target !== btnGroup && !btnGroup.contains(e.target)) {
      // If the user clicked the mute button, do NOT close the popover
      if (e.target && e.target.closest && e.target.closest('#muteButton')) return;
      closeDreamOverlay();
    }
  };
  pop._docClickHandler = docClickHandler;
  setTimeout(()=> document.addEventListener('click', pop._docClickHandler, { capture: true }), 0);

  // é€‰æ‹©åä»…æ¸²æŸ“å†…å®¹å¹¶å…³é—­ popoverï¼ˆä¸æ”¹å˜é¡¶éƒ¨æŒ‰é’®ä¸æ ‡é¢˜çš„é—´è·ï¼‰
  document.getElementById('btnXY').addEventListener('click', ()=> { chooseDreamVariant('xy'); });
  document.getElementById('btnLC').addEventListener('click', ()=> { chooseDreamVariant('lc'); });
}

function closeDreamOverlay(){
  const overlay = document.getElementById('dreamOverlay');
  if (overlay) overlay.remove();
  const pop = document.getElementById('dreamPopover');
  if (pop) {
    // if a document click handler was stored, remove it
    if (pop._docClickHandler) document.removeEventListener('click', pop._docClickHandler, { capture: true });
    pop.remove();
  }
  const btnGroup = document.getElementById('topButtons');
  btnGroup.classList.remove('shift-up');
  // æ¢å¤é¡¶éƒ¨æŒ‰é’®çš„ marginTopï¼ˆå¦‚æœæˆ‘ä»¬ä¹‹å‰ä¸ºäº† pop è°ƒæ•´è¿‡ï¼‰
  btnGroup.style.marginTop = '';
}

// å¦‚æœç‚¹å‡»äº†é¡¶éƒ¨çš„å…¶ä»–æŒ‰é’®ï¼ˆä¸æ˜¯ dreamï¼‰ï¼Œç«‹å³å…³é—­ popoverï¼Œé¿å…æ®‹ç•™
;(function attachTopButtonsCloseHandler(){
  const topButtons = document.getElementById('topButtons');
  if (!topButtons) return;
  topButtons.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const onclickAttr = btn.getAttribute && btn.getAttribute('onclick');
    // å¦‚æœä¸æ˜¯æ‰“å¼€ dream çš„æŒ‰é’®ï¼Œåˆ™å…³é—­ popoverï¼ˆå…è®¸ dream è‡ªå·±ç»§ç»­è§¦å‘ï¼‰
    if (!(onclickAttr && onclickAttr.includes("openPage('dream')"))) {
      closeDreamOverlay();
    }
  });
})();

/* ç”¨æˆ·é€‰æ‹©åè°ƒç”¨ï¼š'xy' -> ç°æœ‰å†…å®¹ï¼›'lc' -> ç›¸åŒç»“æ„ä½†æ–‡æœ¬/audio ç•™ç™½ */
function chooseDreamVariant(code){
  dreamVariant = code;
  closeDreamOverlay();
  renderDreamContent(); // å°†æ„é€ å¹¶æ’å…¥æ€å¿µé¡µé¢å†…å®¹
}

// å·²ç§»é™¤ï¼šé¡¶éƒ¨æŒ‰é’®ä¸å†æ”¹å˜ä¸æ ‡é¢˜çš„å›ºå®šé—´è·

/* æ¸²æŸ“æ€å¿µé¡µé¢ï¼ˆä¼šæ ¹æ® dreamVariant åŒºåˆ†å†…å®¹ï¼‰ */
function renderDreamContent(){
  const content = document.getElementById('content');
  if (!dreamVariant) dreamVariant = 'xy';

  // æ ¹æ®é€‰æ‹©çš„ variant å†³å®šç« èŠ‚æ ‡é¢˜ä¸æ­£æ–‡ï¼ˆxy ä¿æŒåŸæœ‰å†…å®¹ï¼›lc ä½¿ç”¨æ–°çš„ç« åä¸æ–‡æœ¬ï¼‰
  const chapterTitles = (dreamVariant === 'xy')
    ? ['é»‘çŒ«', 'æ™®ç½—ç±³ä¿®æ–¯', 'è€äººä¸æµ·']
    : ['å±€å¤–äºº', 'çª„é—¨', 'å·²æ•…çš„å¸•æ–¯å¡å°”'];

  const chapterTexts = (dreamVariant === 'xy') ? [
    `ã€€ã€€-æˆ‘æ·±ä¿¡è¿™é‚ªå¿µæ˜¯æ¥è‡ªäººæœ¬èƒ½çš„å†²åŠ¨â€”â€”ä¸€ç§ç»†å¾®çš„åŸå§‹åŠŸèƒ½â€¦â€¦\n\n-æˆ–è®¸ä»æ­¤ä»¥åï¼Œæˆ‘å°±åªèƒ½è€å»¶æ®‹å–˜äº†â€”â€”éš¾é“æˆ‘çš„å‘½è¿ç«Ÿç„¶\n\n-æ­£å› ä¸ºæˆ‘æ·±çŸ¥å®ƒæ›¾æ·±çˆ±æˆ‘ã€æ­£å› ä¸ºæˆ‘çŸ¥æ™“æˆ‘æ— æ³•æ”¹å˜è‡ªå·±çš„æ¶å¿µ\n\n-å¯æ˜¯ï¼Œç¥ä¼¼ä¹ç»ˆäºæƒ³èµ·è¦è§£æ•‘æ»¡èº«ç½ªæ¶ã€è¢«æ¶é­”ç‰µç»Šçš„æˆ‘äº†â€¦`,
    `ã€€ã€€-åœ¨è‹¦éš¾ä¹‹å¤–ï¼Œæ—è§‚ä»–äººçš„è‹¦ç—›ï¼Œå´åååˆè¦å¯¾æ·±é™·å…¶ä¸­çš„å—è‹¦è€…â€¦â€¦\n\n-å•Šï¼Œçœ‹å‘ï¼Œæœ‹å‹ï¼Œä½ çš„æ©å¾·æ˜¯å¦‚ä½•æ²’æœ‰å›åº”ï¼å‘Šè¯‰æˆ‘ï¼Œè°ä¼šæ¥ä¿æŠ¤ä½ â€¦\n\n-é‚£ä¹ˆï¼Œä½ å°±å´‡æ‹œå§ï¼Œè‡´æ•¬å§ï¼Œæ°¸è¿œå¥‰æ‰¿é‚£æ‡¦å¼±æ®‹æš´çš„å½“æƒè€…â€¦â€¦\n\n-å°±è¿™æ ·ï¼Œè®©é‚£ç”µç«å†²å‡»æˆ‘å§ï¼Œè®©é‚£å¤©ç©¹åœ¨é›·éœ†å’Œé£æš´ä¸­é¢¤æŠ–â€¦`,
    `ã€€ã€€-ä»–å¯ä»¥çœ‹è§æµ·æ°´æ·±å¤„ä¸ƒè‰²çš„è™¹å…‰ï¼Œå¯ä»¥çœ‹è§é’“ç´¢å’Œé‚£æµ·é¢ä¸Šå¥‡å¦™çš„æ³¢åŠ¨â€¦â€¦\n\n-å¥½è¿è¿™ç©æ„å„¿ï¼Œå¾€å¾€åœ¨å„ç§æ—¶åˆ»ã€ä»¥ä¸åŒå½¢å¼å‡ºç°ï¼Œè°è¯´å¾—å‡†å•Šâ€¦â€¦\n\n-å…‰æ™¯å¤ªå¥½äº†ï¼Œå› æ­¤ä¸èƒ½å¤ŸæŒä¹…ã€‚ä½†æ„¿æˆ‘æ ¹æœ¬æ²¡æœ‰é’“ä¸Šè¿™æ¡é±¼â€¦â€¦\n\n-ä½†æ˜¯ä½ æ¯«ä¸çŠ¹è±«åœ°æ€æ­»äº†é‚£æ¡ç™»å¤šç´¢é²¨ã€‚å³ä½¿å®ƒè·Ÿä½ ä¸€æ ·ï¼Œé åƒæ´»é±¼ç»´ç”Ÿâ€¦â€¦`
  ] : [
    `ã€€ã€€-æˆ‘å§‹ç»ˆä¸è§£ï¼Œåœ¨ä½•ç§ç¨‹åº¦ä¸Šï¼Œå¯ä»¥è¯´æ—¥å­æ—¢æ¼«é•¿éš¾æ±åˆè‹¦çŸ­æ— å¤šâ€¦â€¦\n\n-äººä»¬é•¿ç¯‡å¤§è®ºã€ç»ˆæ—¥ä¸ä¼‘åœ°è¯„ä»·æˆ‘çš„çµé­‚ï¼Œæˆ‘ä»¿ä½›æ„Ÿåˆ°â€¦â€¦\n\n-å¦ˆå¦ˆåœ¨ä¸´è¿‘æ­»äº¡çš„æ—¶å€™ï¼Œä¸€å®šæ„Ÿåˆ°äº†è§£è„±ï¼Œå¹¶å·²å‡†å¤‡å¥½é‡æ´»ä¸€æ¬¡â€¦â€¦\n\n-æˆ‘æ„Ÿåˆ°è¿™ä¸–ç•Œå……æ»¡å‹å–„ä¸èæ´½ï¼Œä¸æˆ‘æ˜¯é‚£ä¹ˆçš„ç›¸ä¼¼â€¦â€¦`,
    `ã€€ã€€-æˆ‘å¸¸å¸¸æ„Ÿåˆ°ï¼Œçˆ±æƒ…æ˜¯æˆ‘æœ€ç¾å¥½çš„ä¸œè¥¿ï¼Œæ˜¯æˆ‘æ‰€æœ‰ç¾å¾·çš„æ¥æºâ€¦â€¦\n\n-æˆ‘å°†é˜¿è‰èå¡‘é€ æˆæˆ‘å¿ƒç›®ä¸­çš„å¶åƒï¼Œå¯è¿™ç•ªç»è¥å´åªå‰©ä¸‹äº†ç–²ä¹â€¦â€¦\n\n-æˆ‘å†ä¹Ÿä¸ä¼šç»™ä½ å†™ä¿¡äº†â€¦â€¦å› ä¸ºï¼Œæˆ‘ç»ˆäºæ„è¯†åˆ°ï¼Œæˆ‘ä»¬çš„è”ç»œä¸è¿‡æ˜¯å·¨å¤§çš„å¹»è§‰...\n\n-ä½ ä»¬è¦åŠªåŠ›èµ°è¿›çª„é—¨ã€‚å› ä¸ºé€šå‘ç­äº¡çš„é—¨å®½å¤§è€Œæ‹¥æŒ¤ï¼Œé€šå‘æ°¸ç”Ÿçš„é—¨å´çª„å°è€Œå†·åƒ»â€¦â€¦`,
    `ã€€ã€€-æ¯æ¯æ„Ÿåˆ°å›°æƒ‘æˆ–è¿·èŒ«æ—¶ï¼Œæˆ‘éƒ½ä¼šå…³ä¸Šå›¾ä¹¦é¦†çš„é—¨ï¼Œæ²¿ä¸€æ¡å°å¾„åˆ°æµ·è¾¹å»â€¦â€¦\n\n-æˆ‘ååœ¨æµ·è¾¹ï¼Œæ‰‹æŒ‡æ‹¨å¼„ç€æµ·æ°´ï¼ŒåŒæ—¶ä½ä¸‹å¤´å»ï¼Œä»€ä¹ˆéƒ½ä¸å†çœ‹â€¦â€¦\n\n-è¿™æ—¶ï¼Œæˆ‘ä¼šçªç„¶æ„Ÿåˆ°å¿ƒä¸­æ‚¸åŠ¨ï¼Œå¤æ€ªçš„å¿µå¤´ä»è„‘æµ·ä¸­è¹¦è·³è€Œå‡º...\n\n-åœ¨æ„¤æ€’ä¸ç»æœ›ä¹‹ä¸‹ï¼Œæˆ‘æ¡ç´§åŒæ‹³ï¼Œé¢æœç€ç©ºèŒ«çš„å¤§æµ·æ”¾å£°å–Šå»â€¦â€¦`
  ];

  content.innerHTML = `
    <h2 class="dream-title">ğŸŒ™ æ€å¿µçµ®è¯­ â€” ${dreamVariant === 'xy' ? 'è§é€¸' : 'é™†æ²‰'}</h2>
    ${chapterTitles.map((title, idx) => `
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">${title}</span>
          <button class="dream-detail-btn" onclick="toggleDream(${idx})"><span class="detail-icon">â–¾</span><span class="detail-label"></span></button>
        </div>
        <div class="dream-content" id="dreamContent${idx}">
          <p class="dream-text">${chapterTexts[idx]}</p>
        </div>
      </div>
    `).join('')}
    
    <div style="display:flex; justify-content:center; margin-top:18px;">
      ${dreamVariant === 'xy' ?
        '<button id="switchToLc" class="choice-btn choice-lc">è·³è½¬åˆ° é™†æ²‰</button>' :
        '<button id="switchToXy" class="choice-btn choice-xy">è·³è½¬åˆ° è§é€¸</button>'
      }
    </div>
  `;

  // attach handlers for the in-page quick-switch buttons
  setTimeout(()=>{
    const sToLc = document.getElementById('switchToLc');
    if (sToLc) sToLc.addEventListener('click', ()=>{ dreamVariant = 'lc'; renderDreamContent(); });
    const sToXy = document.getElementById('switchToXy');
    if (sToXy) sToXy.addEventListener('click', ()=>{ dreamVariant = 'xy'; renderDreamContent(); });
  }, 0);

  // è¿½åŠ æ ·å¼ï¼ˆåŒåŸå®ç°ï¼‰
  const style = document.createElement("style");
  style.textContent = `
      .dream-container { width: 90%; margin: 0 auto; text-align: left; }
      .dream-title { color: #444; margin-bottom: 25px; font-size: 26px; }
      .dream-item { background: rgba(255,255,255,0.75); padding: 12px 18px; border-radius: 12px; margin-bottom: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); }
      .dream-header { display: flex; justify-content: space-between; align-items: center; }
      .dream-chapter { font-size: 20px; font-weight: bold; }
      .dream-detail-btn { border: none; background: #ffe6f2; padding: 5px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
      .dream-detail-btn:hover { background: #ffb7d6; }
      .dream-content { max-height: 0; overflow: hidden; transition: max-height .35s ease; margin-top: 5px; }
      .dream-text { white-space: pre-wrap; line-height: 1.6; font-size: 16px; color: #444; }
    `;
  document.head.appendChild(style);

  // æ ¹æ® dreamVariant å¡«å…… perLineDataï¼šxy ä½¿ç”¨å·²æœ‰æ–‡æœ¬ä¸éŸ³é¢‘ï¼›lc ç•™ç™½ä»¥ä¾¿ä½ å¡«
  (function enrichDreamText(){
    const dreamTextEls = content.querySelectorAll('.dream-text');
    dreamTextEls.forEach((el, chapterIdx) => {
      const raw = el.textContent || '';
      const lines = raw.split(/\n+/).map(s => s.replace(/^[-ã€€\s]*/,'').trim()).filter(Boolean);
      const wrapper = document.createElement('div');
      wrapper.className = 'dream-lines-wrapper';

      // perLineData ç”± variant å†³å®š
      const perLineData = {};
      if (dreamVariant === 'xy') {
        // åŸæœ‰è§é€¸æ–‡æœ¬ä¸éŸ³é¢‘ï¼ˆä¿ç•™åŸå†…å®¹ï¼‰
        if (chapterIdx === 0) {
          perLineData[0] = { text: `æˆ‘æ·±ä¿¡è¿™é‚ªå¿µæ˜¯æ¥è‡ªäººæœ¬èƒ½çš„å†²åŠ¨\nâ€”ä¸€ç§ç»†å¾®çš„åŸå§‹åŠŸèƒ½ï¼Œå®ƒå’Œäººçš„æœ¬æ€§å¯†ä¸å¯åˆ†ã€‚...`, audio: 'hm1.mp3' };
          perLineData[1] = { text: `æˆ–è®¸ä»æ­¤ä»¥åï¼Œæˆ‘å°±åªèƒ½è‹Ÿå»¶æ®‹å˜´äº†\nä¸€ä¸€éš¾é“æˆ‘çš„å‘½è¿ç«Ÿç„¶å°±è¿™æ ·è¢«ä¸€åªåŠ¨ç‰©æŒæ§ã€æŠ˜ç£¨ï¼Ÿ...`, audio: 'hm2.mp3' };
          perLineData[2] = { text: `æ­£å› ä¸ºæˆ‘æ·±çŸ¥å®ƒæ›¾æ·±çˆ±æˆ‘...`, audio: 'hm3.mp3' };
          perLineData[3] = { text: `å¯æ˜¯ï¼Œç¥ä¼¼ä¹ç»ˆäºæƒ³èµ·è¦è§£æ•‘æ»¡èº«ç½ªæ¶...`, audio: 'hm4.mp3' };
        }
        if (chapterIdx === 1) {
          perLineData[0] = { text: `ç«™åœ¨è‹¦éš¾ä¹‹å¤–ï¼Œæ—è§‚ä»–äººçš„è‹¦ç—›...`, audio: 'plmxs1.mp3' };
          perLineData[1] = { text: `å•Šï¼Œçœ‹å‘ï¼Œæœ‹å‹ï¼Œä½ çš„æ©å¾·æ˜¯å¦‚ä½•æ²¡æœ‰å›åº”ï¼...`, audio: 'plmxs2.mp3' };
          perLineData[2] = { text: `é‚£ä¹ˆï¼Œä½ å°±å´‡æ‹œå§ï¼Œè‡´æ•¬å§...`, audio: 'plmxs3.mp3' };
          perLineData[3] = { text: `å°±è¿™æ ·ï¼Œè®©é‚£ç”µç«å†²å‡»æˆ‘å§...`, audio: 'plmxs4.mp3' };
        }
        if (chapterIdx === 2) {
          perLineData[0] = { text: `ä»–å¯ä»¥çœ‹è§æµ·æ°´æ·±å¤„ä¸ƒè‰²çš„è™¹å…‰...`, audio: 'lryh1.mp3' };
          perLineData[1] = { text: `å¥½è¿è¿™ç©æ„å„¿ï¼Œå¾€å¾€åœ¨å„ç§æ—¶åˆ»ã€ä»¥ä¸åŒå½¢å¼å‡ºç°...`, audio: 'lryh2.mp3' };
          perLineData[2] = { text: `å…‰æ™¯å¤ªå¥½äº†ï¼Œå› æ­¤ä¸èƒ½å¤ŸæŒä¹…...`, audio: 'lryh3.mp3' };
          perLineData[3] = { text: `ä½†æ˜¯ä½ æ¯«ä¸çŠ¹è±«åœ°æ€æ­»äº†é‚£æ¡ç™»å¤šç´¢é²¨...`, audio: 'lryh4.mp3' };
        }
      } else {
        // lcï¼šä¸ºé™†æ²‰åˆ†æ”¯å¡«å……é»˜è®¤æ–‡æœ¬ï¼ˆå¯åœ¨é¡µé¢ä¸­ç¼–è¾‘ï¼‰
        if (chapterIdx === 0) {
          perLineData[0] = { text: 'æˆ‘å§‹ç»ˆä¸è§£ï¼Œåœ¨ä½•ç§ç¨‹åº¦ä¸Šï¼Œå¯ä»¥è¯´æ—¥å­æ—¢æ¼«é•¿éš¾æ±åˆè‹¦çŸ­æ— å¤šã€‚æ—¥å­è¿‡èµ·æ¥è‡ªç„¶æ˜¯æ¼«é•¿çš„ï¼Œå¯å¦‚æ­¤ä¸€æ—¥ä¸€æ—¥åœ°æ‹–æ‹‰ç€ï¼Œæœ€ç»ˆä¾¿å…¨éƒ½æ··ä½œä¸€ç‰‡ï¼Œæ¯ä¸€å¤©éƒ½ä¸å†æ‹¥æœ‰è‡ªå·±çš„åå­ã€‚äºæˆ‘è€Œè¨€ï¼Œåªæœ‰â€æ˜¨å¤©â€ä¸â€æ˜å¤©â€œè¿™æ ·çš„å­—çœ¼æ‰æœ‰ä¸€å®šæ„ä¹‰ã€‚', audio: 'jwr1.mp3' };
          perLineData[1] = { text: 'äººä»¬é•¿ç¯‡å¤§è®ºã€ç»ˆæ—¥ä¸ä¼‘åœ°è¯„ä»·æˆ‘çš„çµé­‚ï¼Œæˆ‘ä»¿ä½›æ„Ÿåˆ°ï¼Œæ‰€æœ‰çš„ä¸€åˆ‡éƒ½å˜æˆäº†ä¸€ç‰‡ä»¤æˆ‘å¤´æ™•ç›®çœ©çš„æ— è‰²ä¹‹æ°´â‹¯çªç„¶ï¼Œè¿‡å»ç”Ÿæ´»çš„è®°å¿†æ¶Œå…¥è„‘æµ·ã€‚å®ƒä»¬å·²ä¸å†å±äºæˆ‘ï¼Œå´çš„ç¡®æ›¾ç»™äºˆæˆ‘æœ€å¯æ€œè€Œéš¾å¿˜çš„å¿«ä¹ã€‚', audio: 'jwr2.mp3' };
          perLineData[2] = { text: 'å¦ˆå¦ˆåœ¨ä¸´è¿‘æ­»äº¡çš„æ—¶å€™ï¼Œä¸€å®šæ„Ÿåˆ°äº†è§£è„±ï¼Œå¹¶å·²å‡†å¤‡å¥½é‡æ´»ä¸€æ¬¡ã€‚åœ¨è¿™ä¸–ä¸Šï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªäººæœ‰æƒä¸ºå¥¹æµæ³ªã€‚æˆ‘ä¹Ÿä¸€æ ·ï¼Œä»¿ä½›å…¨éƒ¨çš„è‹¦ç—›å’Œå¸Œæœ›éƒ½åœ¨é‚£åœºæš´æ€’ä¸­å¤±å»ï¼›åœ¨å¸ƒæ»¡é¢„å…†çš„æ˜Ÿç©ºä¸‹ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ•å¼€å¿ƒæ‰‰ï¼Œæ¬£ç„¶æ¥å—ä¸–ç•Œæ¸©æŸ”çš„å†·æ¼ ã€‚', audio: 'jwr3.mp3' };
          perLineData[2] = { text: 'æˆ‘æ„Ÿåˆ°è¿™ä¸–ç•Œå……æ»¡å‹å–„ä¸èæ´½ï¼Œä¸æˆ‘æ˜¯é‚£ä¹ˆçš„ç›¸ä¼¼ï¼›æˆ‘çš„äººç”Ÿæ— è®ºæ˜¯è¿‡å»è¿˜æ˜¯ç°åœ¨ï¼Œéƒ½æ— æ¯”å¹¸ç¦ã€‚ä¸ºäº†å°½å–„å°½ç¾ï¼Œä¸ºäº†ä¸å†å­¤ç‹¬ï¼Œæˆ‘å¸Œæœ›è‡ªå·±è¢«å¤„å†³çš„é‚£å¤©ï¼Œä¼šæœ‰å¾ˆå¤šäººæ¥å›´è§‚ï¼Œå¹¶çº·çº·å‘æˆ‘å‘å‡ºä»‡æ¨çš„å‘å–Šã€‚', audio: 'jwr4.mp3' };
        }
        if (chapterIdx === 1) {
          perLineData[0] = { text: 'æˆ‘å¸¸å¸¸æ„Ÿåˆ°ï¼Œçˆ±æƒ…æ˜¯æˆ‘æœ€ç¾å¥½çš„ä¸œè¥¿ï¼Œæ˜¯æˆ‘æ‰€æœ‰ç¾å¾·çš„æ¥æºï¼Œæ˜¯è®©æˆ‘è¶…è¶Šè‡ªå·±çš„åŠ›é‡ã€‚å¦‚æœæ²¡æœ‰ä½ ï¼Œæˆ‘çš„å¤©æ€§ä¼šå •è½åˆ°å’Œä»å‰ä¸€æ ·çš„å¹³åº¸ã€‚æ­£æ˜¯å› ä¸ºå¿ƒæ€€ç€ä¸ä½ ç›¸è§çš„å¸Œæœ›ï¼Œæˆ‘æ‰æ°¸è¿œå°†å´å²–å°å¾„çœ‹æˆåº·åº„å¤§é“ã€‚', audio: 'zm1.mp3' };
          perLineData[1] = { text: 'æˆ‘å°†é˜¿è‰èå¡‘é€ æˆæˆ‘å¿ƒç›®ä¸­çš„å¶åƒï¼Œå¯è¿™ç•ªç»è¥å´åªå‰©ä¸‹äº†ç–²ä¹ã€‚ä¸€æ—¦æ”¾ä»»è‡ªæµï¼Œå¥¹å°±ä¼šå˜å›å¹³åº¸ï¼Œå¯ä¸€æ—¦å¦‚æ­¤ï¼Œæˆ‘å°±ä¸ä¼šçˆ±å¥¹â€¦â€¦å¦‚æœæˆ‘ä»¬å½“åˆéƒ½èƒ½å°‘ä¸€äº›è‡ªå¤§ï¼Œè¿™åœºçˆ±æƒ…æœ¬è¯¥å¾ˆç®€å•â€¦ä»ä»Šå¤©èµ·ï¼ŒåšæŒç€ä¸€ä»½æ²¡æœ‰å¯¹è±¡çš„çˆ±æƒ…æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿè¿™æ˜¯é¡½å›ºï¼Œè€Œéå¿ è¯šã€‚', audio: 'zm2.mp3' };
          perLineData[2] = { text: 'æˆ‘å†ä¹Ÿä¸ä¼šç»™ä½ å†™ä¿¡äº†â€¦â‹¯å› ä¸ºï¼Œæˆ‘ç»ˆäºæ„è¯†åˆ°ï¼Œæˆ‘ä»¬çš„è”ç»œä¸è¿‡æ˜¯å·¨å¤§çš„å¹»è§‰ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬æ¯ä¸ªäººéƒ½ä¸è¿‡æ˜¯åœ¨ç»™è‡ªå·±å†™ä¿¡â€¦æˆ‘æ¯«æ— ç–‘é—®åœ°æ·±æ·±çˆ±ç€ä½ ï¼Œä½†æˆ‘åˆç»æœ›åœ°å‘ç°ï¼Œå½“ä½ è¿œç¦»æˆ‘æ—¶ï¼Œæˆ‘çˆ±ä½ æ›´æ·±ã€‚', audio: 'zm3.mp3' };
          perLineData[2] = { text: 'ä½ ä»¬è¦åŠªåŠ›èµ°è¿›çª„é—¨ã€‚å› ä¸ºé€šå‘ç­äº¡çš„é—¨å®½å¤§è€Œæ‹¥æŒ¤ï¼Œé€šå‘æ°¸ç”Ÿçš„é—¨å´çª„å°è€Œå†·åƒ»ã€‚â€.æˆ‘æµ®æƒ³è”ç¿©ï¼Œä»¿ä½›è¿™æ‰‡é—¨æˆäº†ä¸€å°è½§é’¢æœºï¼Œæˆ‘è€—è´¹å·¨å¤§çš„åŠªåŠ›æ‰è·»èº«å…¶ä¸­ï¼Œä¸€è¾¹æ„Ÿåˆ°ç—›è‹¦ï¼Œä¸€è¾¹äº«å—æ°¸ç”Ÿä¹‹ä¹ã€‚å®ƒåˆæˆäº†é˜¿è‰èçš„æˆ¿é—¨ï¼Œæˆ‘éœ€è¦å°†è‡ªå·±ç¼©æˆä¸€å›¢ï¼Œå½»åº•æŠ›å¼ƒæ®‹å­˜çš„è‡ªç§å¿ƒæ‰é’»å¾—è¿›å»ã€‚', audio: 'zm4.mp3' };
        }
        if (chapterIdx === 2) {
          perLineData[0] = { text: 'æ¯æ¯æ„Ÿåˆ°å›°æƒ‘æˆ–è¿·èŒ«æ—¶ï¼Œæˆ‘éƒ½ä¼šå…³ä¸Šå›¾ä¹¦é¦†çš„é—¨ï¼Œæ²¿ä¸€æ¡å°å¾„åˆ°æµ·è¾¹å»ã€‚æœ›ç€èŒ«èŒ«å¤§æµ·ï¼Œä¸€ç§æ•¬ç•æ„Ÿä¼šä»æˆ‘å¿ƒé‡Œé™¡ç„¶è€Œç”Ÿï¼Œå¹¶æ…¢æ…¢åœ°å¢å¼ºï¼Œç›´åˆ°è¦†ç›–äº†æˆ‘å…¶ä»–æ‰€æœ‰æƒ…ç»ªã€‚', audio: 'ygdpske1.mp3' };
          perLineData[1] = { text: 'æˆ‘ååœ¨æµ·è¾¹ï¼Œæ‰‹æŒ‡æ‹¨å¼„ç€æµ·æ°´ï¼ŒåŒæ—¶ä½ä¸‹å¤´å»ï¼Œä»€ä¹ˆéƒ½ä¸å†çœ‹ã€‚ä½†æˆ‘èƒ½å¬è§ï¼Œå¬é‚£æµ·æµªæ‹å²¸ã€æ³¢æ¶›æ±¹æ¶Œã€‚â€œæ‰€ä»¥æˆ‘ä¼šä¸€ç›´è¿™æ ·ã€‚â€œæˆ‘å–ƒå–ƒè‡ªè¯­ï¼Œâ€œä¸€æˆä¸å˜ï¼Œç›´åˆ°æ­»äº¡åˆ°æ¥ã€‚â€', audio: 'ygdpske2.mp3' };
          perLineData[2] = { text: 'è¿™æ—¶ï¼Œæˆ‘ä¼šçªç„¶æ„Ÿåˆ°å¿ƒä¸­æ‚¸åŠ¨ï¼Œå¤æ€ªçš„å¿µå¤´ä»è„‘æµ·ä¸­è¹¦è·³è€Œå‡ºã€‚æˆ‘å¥½åƒå¿½ç„¶ç€äº†é­”ï¼ŒçŒ›åœ°è·³èµ·æ¥ï¼Œèº«ä½“æ‘‡æ™ƒï¼Œä»¿ä½›æœ‰ä»€ä¹ˆå°†æˆ‘ç´§ç´§æŸç¼šï¼Œè€Œæˆ‘è¦ç«­åŠ›æŒ£è„±å®ƒã€‚å¯æ˜¯ï¼Œæµ·ä»æ—§æ˜¯é‚£æµ·ï¼Œå¹³é™æˆ–æ±¹æ¶Œï¼Œæ²¡æœ‰ä¸æ¯«æ”¹å˜ã€‚', audio: 'ygdpske3.mp3' };
          perLineData[2] = { text: '"åœ¨æ„¤æ€’ä¸ç»æœ›ä¹‹ä¸‹ï¼Œæˆ‘æ¡ç´§åŒæ‹³ï¼Œé¢æœç€ç©ºèŒ«çš„å¤§æµ·æ”¾å£°å–Šå»ï¼šâ€œä¸ºä»€ä¹ˆä¸€å®šè¦è¿™æ ·ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼â€œå·¨æµªè¢­æ¥ï¼Œæ‹èµ·ä¸‡ä¸ˆæµªèŠ±ï¼Œæ‰“æ¹¿äº†æˆ‘çš„åŒè„šã€‚è€Œæˆ‘ä¹Ÿå› æ­¤é¢†æ‚Ÿï¼Œå¤§æµ·è¯´çš„ä»¿ä½›æ˜¯ï¼Œâ€œå› ä¸ºä½ å¼€å§‹æ¢å¯»äº‹ç‰©èƒŒåçš„åŸå› ã€‚"', audio: 'ygdpske4.mp3' };
        }
      }

      // article æ¨¡æ¿
      const articleHTML = `
        <div class="article-left">
          <div class="article-content" contenteditable="true">åœ¨è¿™é‡Œå¡«å†™ç« èŠ‚æ–‡ç« å†…å®¹ï¼ˆå¯ç›´æ¥ç²˜è´´/ç¼–è¾‘ï¼‰ã€‚</div>
          <div class="article-hint" style="font-size:13px;color:#666;margin-top:8px;"></div>
        </div>
        <div class="article-right">
          <div class="wechat-voice">
            <div class="wv-bubble">ç‚¹å‡»æ’­æ”¾è¯­éŸ³</div>
            <button class="wv-play">â–¶</button>
            <audio class="wv-audio" preload="none"></audio>
          </div>
        </div>`;

      lines.forEach((line, lineIdx) => {
        const lineWrap = document.createElement('div');
        lineWrap.className = 'dream-line';

        const short = document.createElement('div');
        short.className = 'dream-short';
        short.textContent = line;

        const btn = document.createElement('button');
        btn.className = 'detail-toggle';
        btn.innerHTML = '<span class="detail-label">è¯¦æƒ…</span><span class="detail-icon">â–¾</span>';

        const articleEl = document.createElement('div');
        articleEl.className = 'chapter-article';
        articleEl.style.display = 'none';
        articleEl.innerHTML = articleHTML;

        btn.addEventListener('click', ()=>{
          const showing = articleEl.style.display === 'block';
          const chapterContentEl = wrapper.parentNode;
          const bgm = document.getElementById('bgm');
          if (showing) {
            articleEl.style.display = 'none';
            const ic = btn.querySelector('.detail-icon'); if(ic) ic.textContent = 'â–¾';
            try {
              const a = articleEl.querySelector('.wv-audio');
              const pb = articleEl.querySelector('.wv-play');
              if (a && !a.paused) {
                a.pause();
                if (pb) pb.textContent = 'â–¶';
                try {
                  const otherMusic = document.getElementById('musicPlayer');
                  if (a.dataset.ducked && bgm && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
                  if (a.dataset.ducked && otherMusic && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
                } catch(e){}
                a.dataset.ducked = '';
              }
            } catch(e){}
            try {
              const anyOpen = Array.from(wrapper.querySelectorAll('.chapter-article')).some(a=>a.style.display === 'block');
              if (!anyOpen) chapterContentEl.style.maxHeight = '0px';
            } catch(e){}
          } else {
            try {
              const data = perLineData[lineIdx];
              const ac = articleEl.querySelector('.article-content');
              const aEl = articleEl.querySelector('.wv-audio');
              const pb = articleEl.querySelector('.wv-play');
              if (data && data.text) ac.textContent = data.text; else ac.textContent = 'åœ¨è¿™é‡Œå¡«å†™ç« èŠ‚æ–‡ç« å†…å®¹ï¼ˆå¯ç›´æ¥ç²˜è´´/ç¼–è¾‘ï¼‰ã€‚';
              if (data && data.audio) { articleEl.dataset.audio = data.audio; aEl.src = data.audio; if(pb) pb.textContent = 'â–¶'; }
              else { articleEl.removeAttribute('data-audio'); aEl.removeAttribute('src'); if(pb) pb.textContent = 'â–¶'; }
            } catch (e) {}
            articleEl.style.display = 'block';
            const ic = btn.querySelector('.detail-icon'); if(ic) ic.textContent = 'â–´';
            try { chapterContentEl.style.maxHeight = chapterContentEl.scrollHeight + 'px'; } catch(e){}
          }
          try {
            const item = wrapper.parentNode.closest('.dream-item');
            if (item) {
              const anyOpen = Array.from(wrapper.querySelectorAll('.chapter-article')).some(a=>a.style.display === 'block');
              const headerIcon = item.querySelector('.dream-detail-btn .detail-icon');
              if (headerIcon) headerIcon.textContent = anyOpen ? 'â–´' : 'â–¾';
            }
          } catch(e){}
        });

        lineWrap.appendChild(short);
        lineWrap.appendChild(btn);
        wrapper.appendChild(lineWrap);
        wrapper.appendChild(articleEl);

        // per-line audio binding
        (function bindPerLineAudio(aEl){
          const playBtnLocal = aEl.querySelector('.wv-play');
          const audioElLocal = aEl.querySelector('.wv-audio');
          const dasrcLocal = aEl.getAttribute('data-audio');
          if (dasrcLocal && dasrcLocal.trim()) audioElLocal.src = dasrcLocal;
          playBtnLocal && playBtnLocal.addEventListener('click', ()=>{
            const bgm = document.getElementById('bgm');
            if (!audioElLocal.src) { alert('è¯·ä¸ºæœ¬è¡Œè®¾ç½®éŸ³é¢‘ï¼šåœ¨å¯¹åº”çš„è¡Œå…ƒç´ è®¾ç½® data-audio="path/to/file.mp3" æˆ–æŠŠ src å†™å…¥ <audio>ã€‚'); return; }
            if (audioElLocal.paused) {
              document.querySelectorAll('.wv-audio').forEach(o => {
                try {
                  if (o !== audioElLocal && !o.paused) {
                    if (o.dataset.ducked) {
                      const otherMusic = document.getElementById('musicPlayer');
                      try { if (bgm && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; } } catch(e){}
                      try { if (otherMusic && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; } } catch(e){}
                      o.dataset.ducked = '';
                    }
                    o.pause();
                    const otherBtn = o.closest('.chapter-article')?.querySelector('.wv-play');
                    if (otherBtn) otherBtn.textContent = 'â–¶';
                  }
                } catch(e){}
              });
              try {
                const otherMusic = document.getElementById('musicPlayer');
                if (bgm && typeof bgm.dataset.prevVolume === 'undefined') bgm.dataset.prevVolume = String(typeof bgm.volume !== 'undefined' ? bgm.volume : 1);
                if (otherMusic && typeof otherMusic.dataset.prevVolume === 'undefined') otherMusic.dataset.prevVolume = String(typeof otherMusic.volume !== 'undefined' ? otherMusic.volume : 1);
              } catch(e){}
              try { if (bgm) bgm.volume = 0.15; const otherMusic = document.getElementById('musicPlayer'); if (otherMusic) otherMusic.volume = 0.15; } catch(e){}
              audioElLocal.play().catch(()=>{});
              playBtnLocal.textContent = 'â¸';
              audioElLocal.dataset.ducked = 'true';
            } else {
              audioElLocal.pause();
              playBtnLocal.textContent = 'â–¶';
              try {
                const otherMusic = document.getElementById('musicPlayer');
                if (bgm && audioElLocal.dataset.ducked && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
                if (otherMusic && audioElLocal.dataset.ducked && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
              } catch(e){}
              audioElLocal.dataset.ducked = '';
            }
          });
          audioElLocal.addEventListener('ended', ()=>{
            const bgm = document.getElementById('bgm');
            try {
              const otherMusic = document.getElementById('musicPlayer');
              if (bgm && audioElLocal.dataset.ducked && typeof bgm.dataset.prevVolume !== 'undefined') { bgm.volume = parseFloat(bgm.dataset.prevVolume); delete bgm.dataset.prevVolume; }
              if (otherMusic && audioElLocal.dataset.ducked && typeof otherMusic.dataset.prevVolume !== 'undefined') { otherMusic.volume = parseFloat(otherMusic.dataset.prevVolume); delete otherMusic.dataset.prevVolume; }
            } catch(e){}
            const pb = aEl.querySelector('.wv-play'); if (pb) pb.textContent = 'â–¶';
            audioElLocal.dataset.ducked = '';
          });
        })(articleEl);
      });

      el.parentNode.replaceChild(wrapper, el);
    });
  })();
}

/* å±•å¼€/æ”¶èµ·ç« èŠ‚ */
function toggleDream(i) {
  const content = document.getElementById("dreamContent" + i);
  if (!content) return;
  if (content.style.maxHeight && content.style.maxHeight !== "0px") {
    content.style.maxHeight = "0px";
  } else {
    content.style.maxHeight = content.scrollHeight + "px";
  }
  try {
    const item = content.closest('.dream-item');
    if (item) {
      const headerIcon = item.querySelector('.dream-detail-btn .detail-icon');
      if (headerIcon) {
        const open = content.style.maxHeight && content.style.maxHeight !== '0px';
        headerIcon.textContent = open ? 'â–´' : 'â–¾';
      }
    }
  } catch (e) {}
}

/* æ¸¸æˆé€»è¾‘ï¼ˆä¸å˜ï¼‰ */
function startGame(container) {
  container.innerHTML = `
    <h2>ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</h2>
    <canvas id="gameCanvas" width="350" height="450" style="border:2px solid #555; border-radius:12px; background:url('background.jpg'); background-size:cover;"></canvas>
    <p>ç”¨ â† â†’ æ§åˆ¶ç¯®å­æ¥é‡‘å¸ï¼</p>
  `;
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const basket = { x: 140, y: 390, width: 80, height: 40, img: new Image() };
  basket.img.src = "basket.png";
  const coin = { x: Math.random() * 310, y: 0, size: 30, img: new Image() };
  coin.img.src = "coin.png";
  let score = 0, rightPressed = false, leftPressed = false;
  document.addEventListener("keydown", e => { if (e.key === "ArrowRight") rightPressed = true; if (e.key === "ArrowLeft") leftPressed = true; });
  document.addEventListener("keyup", e => { if (e.key === "ArrowRight") rightPressed = false; if (e.key === "ArrowLeft") leftPressed = false; });
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(basket.img, basket.x, basket.y, basket.width, basket.height);
    ctx.drawImage(coin.img, coin.x, coin.y, coin.size, coin.size);
    ctx.fillStyle = "white"; ctx.font = "18px Arial"; ctx.fillText("åˆ†æ•°: " + score, 10, 25);
  }
  function update() {
    coin.y += 3;
    if (coin.y + coin.size > basket.y && coin.x + coin.size > basket.x && coin.x < basket.x + basket.width) {
      score++; coin.y = 0; coin.x = Math.random() * 310;
    }
    if (coin.y > canvas.height) { coin.y = 0; coin.x = Math.random() * 310; }
    if (rightPressed && basket.x < canvas.width - basket.width) basket.x += 5;
    if (leftPressed && basket.x > 0) basket.x -= 5;
    draw();
    requestAnimationFrame(update);
  }
  update();
}

/* é¡¶éƒ¨éŸ³é¢‘æ§åˆ¶ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰ */
const globalPlayBtn = document.getElementById('globalPlayBtn');
const muteBtn = document.getElementById('muteButton');
const bgmEl = document.getElementById('bgm');
const musicEl = document.getElementById('musicPlayer');

function anyAudioPlaying() {
  return (musicEl && musicEl.src && !musicEl.paused) || (bgmEl && !bgmEl.paused);
}

globalPlayBtn.addEventListener('click', () => {
  if (anyAudioPlaying()) {
    if (musicEl && !musicEl.paused) { musicEl.pause(); }
    if (bgmEl && !bgmEl.paused) { bgmEl.pause(); }
    globalPlayBtn.textContent = 'â–¶';
  } else {
    if (musicEl && musicEl.src) {
      musicEl.play().catch(()=>{});
    } else if (bgmEl) {
      bgmEl.play().catch(()=>{});
    }
    globalPlayBtn.textContent = 'â¸';
  }
});

muteBtn.addEventListener('click', () => {
  if (!bgmEl && !musicEl) return;
  const muted = !( (bgmEl && bgmEl.muted) || (musicEl && musicEl.muted) );
  if (bgmEl) bgmEl.muted = muted;
  if (musicEl) musicEl.muted = muted;
  muteBtn.textContent = muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
});

if (musicEl) {
  musicEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  musicEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}
if (bgmEl) {
  bgmEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  bgmEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}

document.addEventListener("click", function () {
  if (bgmEl && bgmEl.paused) bgmEl.play().catch(()=>{});
}, { once: true });

// é¡¶éƒ¨éŸ³é¢‘è¿›åº¦æ›´æ–°ï¼ˆæ˜¾ç¤ºæ­£åœ¨æ’­æ”¾çš„æºï¼šä¼˜å…ˆ musicElï¼Œå…¶æ¬¡ bgmElï¼‰
const audioProgress = document.getElementById('audioProgress');
function rafAudioProgress(){
  try{
    const target = (musicEl && musicEl.src && !musicEl.paused) ? musicEl : (bgmEl ? bgmEl : null);
    if(audioProgress && audioProgress.firstElementChild){
      const inner = audioProgress.firstElementChild;
      if(target && target.duration && !isNaN(target.duration)){
        const pct = (target.currentTime / target.duration) * 100;
        inner.style.width = pct + '%';
      } else {
        inner.style.width = '0%';
      }
    }
  }catch(e){}
  requestAnimationFrame(rafAudioProgress);
}
requestAnimationFrame(rafAudioProgress);
</script>
</body>
</html>
