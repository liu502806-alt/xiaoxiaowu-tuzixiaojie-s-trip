<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è§å°äº”/å…”å­å°å§ã®å¥‡å¦™æ—…é€” - ä¸»é¡µé¢</title>
<style>
body {
  margin: 0;
  font-family: "Hiragino Maru Gothic Pro", "PingFang SC", sans-serif;
  background: linear-gradient(180deg, #ffe7ef, #def6ff);
  min-height: 100vh;               /* æ”¹ä¸º min-height ä»¥å…è®¸å†…å®¹è¶…å‡ºå¹¶æ»šåŠ¨ */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;    /* ä»å‚ç›´å±…ä¸­æ”¹ä¸ºé ä¸Šï¼Œé¡µé¢å¯è‡ªç„¶æ‹“å±•å¹¶æ»šåŠ¨ */
  align-items: center;
  text-align: center;
  padding: 48px 18px;             /* ç»™é¡¶éƒ¨å’Œåº•éƒ¨ç•™å‡ºç©ºé—´ */
  box-sizing: border-box;
  overflow-y: auto;               /* ç¡®ä¿çºµå‘å¯æ»šåŠ¨ */
}
/* æ–°å¢ï¼šé¡µé¢åˆå§‹çŠ¶æ€ï¼ˆæ ‡é¢˜å‚ç›´å±…ä¸­ï¼‰ */
body.home {
  justify-content: center;
  padding-top: 0;
  padding-bottom: 0;
}
.title { font-size: 2.3rem; color: #ff6ca8; text-shadow: 0 2px 6px rgba(255,150,180,0.35); animation: fadeIn 1s; margin-bottom: 30px; }
.button-group { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; }
.button-group button { background: rgba(255,255,255,0.75); border: none; padding: 14px 28px; border-radius: 20px; font-size: 1.15rem; cursor: pointer; box-shadow: 0 6px 12px rgba(255, 170, 200, 0.3); transition: .2s; }
.button-group button:hover { background: #ffe3f0; transform: scale(1.07); }
canvas { border-radius: 12px; width: 100%; }
@keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
.modeBtn { width:45px; height:45px; border-radius:50%; border:none; background:#ffffffcc; box-shadow:0 3px 8px rgba(0,0,0,0.15); font-size:20px; cursor:pointer; transition:0.25s; }
.modeBtn:hover { transform:scale(1.08); background:#ffe6f2; }
.modeBtn.active { background:#ff8fb7; color:white; }

/* é¡¶éƒ¨éŸ³é¢‘æ§åˆ¶ï¼ˆæ’­æ”¾ / é™éŸ³ï¼‰ */
#topAudioControls {
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  z-index: 99999;
}
#globalPlayBtn, #muteButton {
  width:44px;
  height:44px;
  border-radius:10px;
  border:none;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 3px 6px rgba(0,0,0,0.12);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  transition:0.18s;
}
#globalPlayBtn:hover, #muteButton:hover { transform: scale(1.06); background: rgba(255,255,255,0.95); }

/* è°ƒæ•´ playerControls å¸ƒå±€ï¼šç»¿è‰²æŒ‰é’®å±…ä¸­ï¼Œæ¨¡å¼æŒ‰é’®æ¨ªå‘å¹¶é å³ */
#playerControls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
  width: 100%;
  box-sizing: border-box;
}

/* å±…ä¸­åŒºåŸŸï¼ˆæ”¾ç»¿è‰²æŒ‰é’®ï¼‰ */
.player-controls-center {
  flex: 1 1 0%;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* æ¨¡å¼æŒ‰é’®æ¨ªå‘æ’åˆ—å¹¶é å³ */
#modeRow {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto; /* æ¨åˆ°å³ä¾§ï¼ˆåœ¨ playerControls å†…ï¼‰ */
}

/* ä¿æŒæŒ‰é’®é«˜åº¦ä¸€è‡´ */
.modeBtn { width:46px; height:46px; }

/* é™éŸ³æŒ‰é’®æ ·å¼ */
#muteButton {
  position: fixed;
  top: 15px;
  right: 15px;
  font-size: 28px;
  cursor: pointer;
  z-index: 9999;
  background: rgba(255,255,255,0.7);
  padding: 6px 10px;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
#muteButton:hover { transform: scale(1.1); background: rgba(255,255,255,0.9); }

/* é™„åŠ ï¼šé™åˆ¶ä¸»å†…å®¹å®½åº¦å¹¶å…è®¸å…¶æ’‘å¼€é¡µé¢é«˜åº¦ */
#content {
  width: 100%;
  max-width: 900px;
  box-sizing: border-box;
}

/* æ–°å¢ï¼šcover æ¡†ä¸å†…éƒ¨åœ†å½¢å›¾ç‰‡ï¼ˆä»…å†…éƒ¨åœ†æ—‹è½¬ï¼‰ */
.cover-frame {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  overflow: hidden;               /* è£åˆ‡æˆåœ†è§’æ–¹æ¡†ï¼Œå†…éƒ¨å›¾ç‰‡å¯è¶…å‡ºå¹¶è¢«é®ç›– */
  position: relative;
  margin-right: 15px;
  flex: 0 0 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.6); /* å¯è‡ªå®šä¹‰è¡¨æ¡†æ ·å¼ */
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  background: #fff;
}

/* å†…éƒ¨åœ†å½¢å›¾ç‰‡ï¼šæ”¾å¤§ä¸€ç‚¹ä»¥ä¾¿åšâ€œåœ†å½¢è£åˆ‡â€æ•ˆæœï¼ˆåªæ—‹è½¬å›¾ç‰‡æœ¬èº«ï¼‰ */
.cover-circle {
  width: 120%;
  height: 120%;
  object-fit: cover;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  border-radius: 50%; /* ä¿è¯çœ‹èµ·æ¥æ˜¯åœ† */
  transition: transform 0.3s;
}

/* æ—‹è½¬ä»…ä½œç”¨åœ¨å†…éƒ¨çš„ .cover-circle */
.cover-circle.rotating {
  animation: spin 6s linear infinite;
  transform-origin: 50% 50%;
}

/* å¤ç”¨å·²æœ‰ spin keyframes */
@keyframes spin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to   { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>
</head>
<body class="home">

<h1 class="title">ğŸ±è§å°äº”/å…”å­å°å§ğŸ° ã®å¥‡å¦™æ—…é€” ğŸµ</h1>

<div class="button-group">
  <button onclick="openPage('piano')">ğŸ¹ åˆè¯ç¤¼èµ</button>
  <button class="next-btn" onclick="location.href='page2.html'">ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</button>
  <button onclick="openPage('dream')">ğŸ’­ æ€å¿µçµ®è¯­</button>
</div>

<div id="content"></div>

<!-- èƒŒæ™¯éŸ³ä¹ï¼ˆåªä¿ç•™ä¸€ä¸ªï¼‰ -->
<audio id="bgm" src="audio2.mp3" loop></audio>
<!-- æŠŠæ’­æ”¾æ›²ç›®çš„éŸ³é¢‘å…ƒç´ ç§»åˆ°é¡µé¢é™æ€ä½ç½®ï¼Œé¿å…åˆ‡æ¢é¡µé¢æ—¶è¢«ç§»é™¤ -->
<audio id="musicPlayer"></audio>

<!-- é¡¶éƒ¨å…¨å±€éŸ³é¢‘æ§åˆ¶ï¼ˆæ’­æ”¾/é™éŸ³ï¼‰ -->
<div id="topAudioControls">
  <button id="globalPlayBtn">â–¶</button>
  <button id="muteButton">ğŸ”Š</button>
</div>

<script>
/* å½“å‰é¡µé¢æ ‡è¯†ï¼ˆç”¨äºé‡å¤ç‚¹å‡»è¿”å›é¦–é¡µï¼‰ */
let currentPage = null;

/* openPage å‡½æ•°ï¼šæ ¹æ®å‚æ•°å¡«å…… #content */
function openPage(page) {
  const content = document.getElementById("content");

  // å¦‚æœé‡å¤ç‚¹å‡»å½“å‰å·²æ‰“å¼€çš„é¡µé¢ï¼Œå›åˆ°åˆå§‹é¦–é¡µçŠ¶æ€
  if (currentPage === page) {
    document.body.classList.add('home');
    content.innerHTML = "";
    currentPage = null;
    return;
  }

  // åˆ‡æ¢åˆ°ä»»æ„é¡µé¢æ—¶æŠŠé¦–é¡µå±…ä¸­çŠ¶æ€ç§»é™¤ï¼Œä½¿æ ‡é¢˜å‘ä¸Šå¹¶æ˜¾ç¤ºå†…å®¹
  document.body.classList.remove('home');
  currentPage = page;

  content.innerHTML = ""; // æ¸…ç©º

  if (page === "piano") {
    // æ ‡è®°å½“å‰é¡µé¢
    // ï¼ˆopenPage å¼€å¤´å·²ç»è®¾ç½® currentPage â€” è§åé¢ä¿®æ”¹ï¼‰
    content.innerHTML = `
     <h2>ğŸ¶ åˆè¯ç¤¼èµ</h2>
      <p>ç‚¹å¼€ä¸‹æ–¹æ›²ç›®å³å¯é¢„è§ˆé’¢ç´æ›²ã€‚</p>

      <div id="playerControls">
        <div class="player-controls-center">
          <button id="playAllBtn" style="
            height:46px;
            background:#1DB954;
            border:none;
            padding:10px 22px;
            border-radius:30px;
            color:white;
            font-size:16px;
            cursor:pointer;
            box-shadow:0 4px 10px rgba(0,0,0,0.3);
          ">â–¶ å¼€å§‹æ’­æ”¾</button>
        </div>

        <div id="modeRow">
          <button class="modeBtn" data-mode="repeat-one">ğŸ”</button>
          <button class="modeBtn" data-mode="repeat-all">ğŸ”‚</button>
          <button class="modeBtn" data-mode="shuffle">ğŸ”€</button>
        </div>
      </div>

      <div id="musicList" style="margin-top:20px;"></div>
    `;

    const musicData = [
      { name: "çº¦å®šä¹‹åˆ", file: "audio1.mp3", img: "audio1cover.jpg" },
      { name: "å½¼æ—¶çš„å¤©ç©º", file: "audio2.mp3", img: "audio2cover.jpg" },
      { name: "æ€ªè¯æ›²", file: "audio3.mp3", img: "audio3cover.jpg" },
      { name: "æ—¥æ—¥å¤œå¤œ", file: "audio4.mp3", img: "audio4cover.jpg" },
      { name: "åˆ°æ˜å¤©å»", file: "audio5.mp3", img: "audio5cover.jpg" }, 
      { name: "æ€å¿µçµ®è¯­bgm", file: "audio6.mp3", img: "audio6cover.jpg" }
    ];

    const list = document.getElementById("musicList");
    const player = document.getElementById("musicPlayer");

    // ------- moved/added: ensure currentIndex exists before any restore/bind -------
    let playMode = 'repeat-all';
    let currentIndex = -1;

    musicData.forEach((m, index) => {
      const item = document.createElement("div");
      item.className = "music-item";
      item.style.cssText = `
        display:flex; align-items:center; margin-bottom:15px; padding:12px; border-radius:14px;
        background: rgba(255, 255, 255, 0.7); box-shadow:0 3px 8px rgba(0,0,0,0.2); cursor:pointer; transition:0.25s;
      `;
      item.innerHTML = `
        <div class="cover-frame">
          <img id="cover${index}" class="cover-circle" src="${m.img}" style="border-radius:12px; margin-right:15px;">
        </div>
        <div style="flex:1;">
          <div style="font-size:17px; font-weight:600; color:#333;">${m.name}</div>
          <div class="progress-bar" id="bar${index}" style="width:100%; height:10px; background:#eee; border-radius:6px; margin-top:10px; overflow:hidden;">
            <div id="fill${index}" style="width:0%; height:100%; background:#ff8fb7; transition:0.1s linear;"></div>
          </div>
        </div>
      `;
      item.onclick = () => playIndex(index);
      list.appendChild(item);
    });

    // persistent element reference (only once)
    const musicPlayerEl = document.getElementById('musicPlayer');

    // å¦‚æœæ’­æ”¾å™¨å½“å‰å·²ç»åœ¨æ’­æ”¾æˆ–æœ‰ srcï¼Œæ‰¾åˆ°å¯¹åº”é¡¹å¹¶æ¢å¤ rotating / progress
    function restorePlaybackUIFromPlayer() {
      // æ¸…é™¤æ—§çš„ rotating çŠ¶æ€
      document.querySelectorAll('.cover-circle').forEach(img => img.classList.remove('rotating'));

      // è®¡ç®—å½“å‰æ­£åœ¨æ’­æ”¾çš„æ–‡ä»¶åï¼ˆåªæ¯”è¾ƒå°¾éƒ¨ä»¥é¿å…ç»å¯¹ URL é—®é¢˜ï¼‰
      let currentFile = "";
      try {
        if (musicPlayerEl && musicPlayerEl.src) {
          const src = musicPlayerEl.src;
          // å…¼å®¹ä¸åŒç¯å¢ƒï¼šåªå–æœ€åä¸€æ®µï¼ˆå« query/hashï¼‰
          currentFile = src.substring(src.lastIndexOf('/') + 1);
        }
      } catch (e) { currentFile = ""; }

      // æ›´ç¨³å¥çš„åŒ¹é…ï¼šå¦‚æœæ–‡ä»¶åå°¾éƒ¨åŒ…å« musicData.file å³è§†ä¸ºåŒ¹é…
      const playingIndex = musicData.findIndex(m => currentFile && currentFile.indexOf(m.file) !== -1);
      if (playingIndex !== -1) {
        currentIndex = playingIndex;
        const img = document.getElementById('cover' + playingIndex);
        if (img) img.classList.add('rotating');
        const fillEl = document.getElementById('fill' + playingIndex);
        if (fillEl && musicPlayerEl.duration) {
          const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100 || 0;
          fillEl.style.width = pct + '%';
        }
      } else {
        currentIndex = -1;
      }
    }

    // ç»‘å®š/æ¢å¤æ’­æ”¾å™¨äº‹ä»¶ï¼ˆæ¯æ¬¡é‡å»º piano å†…å®¹éƒ½è¦ç»‘ä¸€æ¬¡ï¼‰
    function bindMusicPlayerEvents() {
      if (!musicPlayerEl) return;
      musicPlayerEl.onended = () => playNext();
      musicPlayerEl.ontimeupdate = () => {
        if (!musicPlayerEl.duration || currentIndex < 0) return;
        const pct = (musicPlayerEl.currentTime / musicPlayerEl.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
      musicPlayerEl.addEventListener('play', () => {
        if (currentIndex >= 0) {
          const img = document.getElementById('cover' + currentIndex);
          if (img) img.classList.add('rotating');
        }
      });
      // ä¿æŒæ—‹è½¬çŠ¶æ€åœ¨ pause æ—¶ä¸è¢«ç§»é™¤ï¼ˆæŒ‰éœ€å¯å–æ¶ˆï¼‰
    }

    // æ‰§è¡Œæ¢å¤ä¸ç»‘å®šï¼ˆç°åœ¨ currentIndex å·²å£°æ˜ï¼Œrestore ä¸ä¼šæŠ›é”™ï¼‰
    bindMusicPlayerEvents();
    restorePlaybackUIFromPlayer();
    // --- ç»“æŸä¿®æ”¹ ---
    // (å·²åœ¨ä¸Šæ–¹å£°æ˜ playMode / currentIndexï¼Œç§»é™¤é‡å¤å£°æ˜)
    
    const playAllBtnEl = document.getElementById('playAllBtn');
    const modeBtnEls = Array.from(document.querySelectorAll('.modeBtn'));
    modeBtnEls.forEach(b => b.style.opacity = 0.6);
    function updateModeUI(){
      modeBtnEls.forEach(b => {
        const active = b.dataset.mode === playMode;
        b.style.opacity = active ? 1 : 0.6;
        b.style.transform = active ? 'scale(1.08)' : 'scale(1)';
        b.style.boxShadow = active ? '0 6px 14px rgba(255,140,180,0.25)' : 'none';
        b.classList.toggle('active', active);
      });
    }
    updateModeUI();
    modeBtnEls.forEach(b => b.addEventListener('click', ()=>{ playMode = b.dataset.mode; updateModeUI(); }));

    // å½“ç”¨æˆ·åœ¨ piano é¡µé¢ç‚¹å‡»å¼€å§‹æ’­æ”¾æ—¶ï¼ŒåŒæ—¶æ›´æ–° top å…¨å±€æ’­æ”¾æŒ‰é’®ä¸ºæš‚åœçŠ¶æ€
    function setGlobalPlayState(isPlaying) {
      const gp = document.getElementById('globalPlayBtn');
      if (!gp) return;
      gp.textContent = isPlaying ? 'â¸' : 'â–¶';
    }

    function playIndex(i){
      if(i < 0 || i >= musicData.length) return;
      currentIndex = i;
      const m = musicData[i];
      const bgm = document.getElementById("bgm");
      if (bgm && !bgm.paused) bgm.pause();
      player.src = m.file;
      player.play().catch(()=>{});
      // æ›´æ–°å…¨å±€æ’­æ”¾æŒ‰é’® â€” å½“å‰æœ‰éŸ³ä¹åœ¨æ’­æ”¾
      setGlobalPlayState(true);

      // åˆ‡æ¢ï¼šåªæœ‰å½“å‰æ’­æ”¾é¡¹å†…éƒ¨çš„ .cover-circle å¸¦ rotatingï¼ˆè‹¥ä½¿ç”¨äº† cover-frame å®ç°ï¼‰
      document.querySelectorAll('.music-cover, .cover-circle').forEach((img, idx) => {
        img.classList.toggle('rotating', idx === i);
      });
      document.querySelectorAll("[id^=fill]").forEach((f, idx) => {
        f.style.width = idx === i ? (player.currentTime && player.duration ? (player.currentTime/player.duration*100)+'%' : '0%') : "0%";
      });
      player.ontimeupdate = () => {
        if (!player.duration || currentIndex < 0) return;
        const pct = (player.currentTime / player.duration) * 100;
        const el = document.getElementById('fill' + currentIndex);
        if (el) el.style.width = pct + '%';
      };
    }

    function playNext(){
      if(musicData.length === 0) return;
      if(playMode === 'repeat-one'){ playIndex(currentIndex); }
      else if(playMode === 'shuffle'){
        let next = Math.floor(Math.random() * musicData.length);
        if(musicData.length > 1){ while(next === currentIndex) next = Math.floor(Math.random() * musicData.length); }
        playIndex(next);
      } else {
        let next = (currentIndex + 1) % musicData.length;
        playIndex(next);
      }
    }

    // å·²åœ¨ä¸Šæ–¹å–å¾— musicPlayerElï¼Œé¿å…é‡å¤å£°æ˜
    if (typeof musicPlayerEl !== 'undefined' && musicPlayerEl) musicPlayerEl.onended = () => playNext();
    playAllBtnEl.addEventListener('click', () => { if(currentIndex === -1) playIndex(0); else playNext(); });
    document.querySelectorAll('.music-item').forEach((node, idx) => node.addEventListener('click', () => playIndex(idx)));
  }

  if (page === "dream") {
    content.innerHTML = `
      <h2 class="dream-title">ğŸŒ™ æ€å¿µçµ®è¯­</h2>

      <!-- ç« èŠ‚ 1 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">é»‘çŒ«</span>
          <button class="dream-detail-btn" onclick="toggleDream(0)">è¯¦æƒ…</button>
        </div>
        <div class="dream-content" id="dreamContent0">
          <p class="dream-text">ã€€ã€€-æˆ‘æ·±ä¿¡è¿™é‚ªå¿µæ˜¯æ¥è‡ªäººæœ¬èƒ½çš„å†²åŠ¨â€”â€”ä¸€ç§ç»†å¾®çš„åŸå§‹åŠŸèƒ½...

 -æˆ–è®¸ä»æ­¤ä»¥åï¼Œæˆ‘å°±åªèƒ½è€å»¶æ®‹å–˜äº†â€”â€”éš¾é“æˆ‘çš„å‘½è¿ç«Ÿç„¶

 -æ­£å› ä¸ºæˆ‘æ·±çŸ¥å®ƒæ›¾æ·±çˆ±æˆ‘ã€æ­£å› ä¸ºæˆ‘çŸ¥æ™“æˆ‘æ— æ³•æ”¹å˜è‡ªå·±çš„æ¶å¿µ

 -å¯æ˜¯ï¼Œç¥ä¼¼ä¹ç»ˆäºæƒ³èµ·è¦è§£æ•‘æ»¡èº«ç½ªæ¶ã€è¢«æ¶é­”ç‰µç»Šçš„æˆ‘äº†â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 2 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">æ™®ç½—ç±³ä¿®æ–¯</span>
          <button class="dream-detail-btn" onclick="toggleDream(1)">è¯¦æƒ…</button>
        </div>
        <div class="dream-content" id="dreamContent1">
          <p class="dream-text">ã€€ã€€-åœ¨è‹¦éš¾ä¹‹å¤–ï¼Œæ—è§‚ä»–äººçš„è‹¦ç—›ï¼Œå´åååˆè¦å¯¾æ·±é™·å…¶ä¸­çš„å—è‹¦è€….....

-å•Šï¼Œçœ‹å‘ï¼Œæœ‹å‹ï¼Œä½ çš„æ©å¾·æ˜¯å¦‚ä½•æ²’æœ‰å›åº”ï¼å‘Šè¯‰æˆ‘ï¼Œè°ä¼šæ¥ä¿æŠ¤ä½ â€¦

-é‚£ä¹ˆï¼Œä½ å°±å´‡æ‹œå§ï¼Œè‡´æ•¬å§ï¼Œæ°¸è¿œå¥‰æ‰¿é‚£æ‡¦å¼±æ®‹æš´çš„å½“æƒè€…â€¦..

-å°±è¿™æ ·ï¼Œè®©é‚£ç”µç«å†²å‡»æˆ‘å§ï¼Œè®©é‚£å¤©ç©¹åœ¨é›·éœ†å’Œé£æš´ä¸­é¢¤æŠ–â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 3 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">è€äººä¸æµ·</span>
          <button class="dream-detail-btn" onclick="toggleDream(2)">è¯¦æƒ…</button>
        </div>
        <div class="dream-content" id="dreamContent2">
          <p class="dream-text">ã€€ã€€-ä»–å¯ä»¥çœ‹è§æµ·æ°´æ·±å¤„ä¸ƒè‰²çš„è™¹å…‰ï¼Œå¯ä»¥çœ‹è§é’“ç´¢å’Œé‚£æµ·é¢ä¸Šå¥‡å¦™çš„æ³¢åŠ¨â€¦â€¦

-å¥½è¿è¿™ç©æ„å„¿ï¼Œå¾€å¾€åœ¨å„ç§æ—¶åˆ»ã€ä»¥ä¸åŒå½¢å¼å‡ºç°ï¼Œè°è¯´å¾—å‡†å•Šâ€¦â€¦

-å…‰æ™¯å¤ªå¥½äº†ï¼Œå› æ­¤ä¸èƒ½å¤ŸæŒä¹…ã€‚ä½†æ„¿æˆ‘æ ¹æœ¬æ²¡æœ‰é’“ä¸Šè¿™æ¡é±¼â€¦â€¦

-ä½†æ˜¯ä½ æ¯«ä¸çŠ¹è±«åœ°æ€æ­»äº†é‚£æ¡ç™»å¤šç´¢é²¨ã€‚å³ä½¿å®ƒè·Ÿä½ ä¸€æ ·ï¼Œé åƒæ´»é±¼ç»´ç”Ÿâ€¦â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 4 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">æ·±å¤œåˆ—è½¦</span>
          <button class="dream-detail-btn" onclick="toggleDream(3)">è¯¦æƒ…</button>
        </div>
        <div class="dream-content" id="dreamContent3">
          <p class="dream-text">ã€€ã€€è¿™é‡Œå†™ã€Šæ·±å¤œåˆ—è½¦ã€‹çš„å†…å®¹â€¦â€¦</p>
        </div>
      </div>

      <!-- ç« èŠ‚ 5 -->
      <div class="dream-item">
        <div class="dream-header">
          <span class="dream-chapter">æœªå¯„å‡ºçš„ä¿¡</span>
          <button class="dream-detail-btn" onclick="toggleDream(4)">è¯¦æƒ…</button>
        </div>
        <div class="dream-content" id="dreamContent4">
          <p class="dream-text">ã€€ã€€è¿™é‡Œå†™ã€Šæœªå¯„å‡ºçš„ä¿¡ã€‹çš„å†…å®¹â€¦â€¦</p>
        </div>
      </div>
    `;

    const style = document.createElement("style");
    style.textContent = `
      .dream-container {
        width: 90%;
        margin: 0 auto;
        text-align: left;
      }
      .dream-title {
        color: #444;
        margin-bottom: 25px;
        font-size: 26px;
      }
      .dream-item {
        background: rgba(255,255,255,0.75);
        padding: 12px 18px;
        border-radius: 12px;
        margin-bottom: 14px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      }
      .dream-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dream-chapter {
        font-size: 20px;
        font-weight: bold;
      }
      .dream-detail-btn {
        border: none;
        background: #ffe6f2;
        padding: 5px 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
      }
      .dream-detail-btn:hover {
        background: #ffb7d6;
      }
      .dream-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height .35s ease;
        margin-top: 5px;
      }
      .dream-text {
        white-space: pre-wrap;
        line-height: 1.6;
        font-size: 16px;
        color: #444;
      }
    `;
    document.head.appendChild(style);
  }

  if (page === "game") {
    startGame(content);
  }
}

/* toggleDream å‡½æ•°ï¼šå±•å¼€/æ”¶èµ·ç« èŠ‚å†…å®¹ */
function toggleDream(i) {
  const content = document.getElementById("dreamContent" + i);

  if (!content) return;

  if (content.style.maxHeight && content.style.maxHeight !== "0px") {
    content.style.maxHeight = "0px";
  } else {
    content.style.maxHeight = content.scrollHeight + "px";
  }
}

/* æ¸¸æˆé€»è¾‘ï¼ˆä¸åŸå§‹ç‰ˆæœ¬ç›¸åŒï¼‰ */
function startGame(container) {
  container.innerHTML = `
    <h2>ğŸ’° æŒ¥é‡‘ä¹‹å¤œ</h2>
    <canvas id="gameCanvas" width="350" height="450" style="border:2px solid #555; border-radius:12px; background:url('background.jpg'); background-size:cover;"></canvas>
    <p>ç”¨ â† â†’ æ§åˆ¶ç¯®å­æ¥é‡‘å¸ï¼</p>
  `;
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const basket = { x: 140, y: 390, width: 80, height: 40, img: new Image() };
  basket.img.src = "basket.png";
  const coin = { x: Math.random() * 310, y: 0, size: 30, img: new Image() };
  coin.img.src = "coin.png";
  let score = 0, rightPressed = false, leftPressed = false;
  document.addEventListener("keydown", e => { if (e.key === "ArrowRight") rightPressed = true; if (e.key === "ArrowLeft") leftPressed = true; });
  document.addEventListener("keyup", e => { if (e.key === "ArrowRight") rightPressed = false; if (e.key === "ArrowLeft") leftPressed = false; });
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(basket.img, basket.x, basket.y, basket.width, basket.height);
    ctx.drawImage(coin.img, coin.x, coin.y, coin.size, coin.size);
    ctx.fillStyle = "white"; ctx.font = "18px Arial"; ctx.fillText("åˆ†æ•°: " + score, 10, 25);
  }
  function update() {
    coin.y += 3;
    if (coin.y + coin.size > basket.y && coin.x + coin.size > basket.x && coin.x < basket.x + basket.width) {
      score++; coin.y = 0; coin.x = Math.random() * 310;
    }
    if (coin.y > canvas.height) { coin.y = 0; coin.x = Math.random() * 310; }
    if (rightPressed && basket.x < canvas.width - basket.width) basket.x += 5;
    if (leftPressed && basket.x > 0) basket.x -= 5;
    draw();
    requestAnimationFrame(update);
  }
  update();
}

/* é¡¶éƒ¨å…¨å±€æ’­æ”¾/é™éŸ³ æ§åˆ¶ï¼šç»Ÿä¸€ç®¡ç† bgm å’Œ musicPlayer */
const globalPlayBtn = document.getElementById('globalPlayBtn');
const muteBtn = document.getElementById('muteButton');
const bgmEl = document.getElementById('bgm');
const musicEl = document.getElementById('musicPlayer');

function anyAudioPlaying() {
  return (musicEl && musicEl.src && !musicEl.paused) || (bgmEl && !bgmEl.paused);
}

globalPlayBtn.addEventListener('click', () => {
  // å¦‚æœä»»æ„éŸ³é¢‘åœ¨æ’­æ”¾ -> æš‚åœå…¨éƒ¨ï¼›å¦åˆ™ä¼˜å…ˆå°è¯•æ¢å¤ musicPlayerï¼ˆè‹¥æœ‰ srcï¼‰ï¼Œå¦åˆ™æ’­æ”¾ bgm
  if (anyAudioPlaying()) {
    if (musicEl && !musicEl.paused) { musicEl.pause(); }
    if (bgmEl && !bgmEl.paused) { bgmEl.pause(); }
    globalPlayBtn.textContent = 'â–¶';
  } else {
    if (musicEl && musicEl.src) {
      musicEl.play().catch(()=>{});
    } else if (bgmEl) {
      bgmEl.play().catch(()=>{});
    }
    globalPlayBtn.textContent = 'â¸';
  }
});

/* é™éŸ³åŒæ—¶ä½œç”¨äºå…¨éƒ¨éŸ³é¢‘ */
muteBtn.addEventListener('click', () => {
  if (!bgmEl && !musicEl) return;
  const muted = !( (bgmEl && bgmEl.muted) || (musicEl && musicEl.muted) );
  if (bgmEl) bgmEl.muted = muted;
  if (musicEl) musicEl.muted = muted;
  muteBtn.textContent = muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
});

/* å½“ä»»æ„æ’­æ”¾å™¨æ’­æ”¾/æš‚åœæ—¶ï¼ŒåŒæ­¥æ›´æ–°å…¨å±€æ’­æ”¾æŒ‰é’®çŠ¶æ€ */
if (musicEl) {
  musicEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  musicEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}
if (bgmEl) {
  bgmEl.addEventListener('play', ()=> globalPlayBtn.textContent = 'â¸');
  bgmEl.addEventListener('pause', ()=> { if (!anyAudioPlaying()) globalPlayBtn.textContent = 'â–¶'; });
}

/* ä¿æŒåŸæœ‰è‡ªåŠ¨æ’­æ”¾æ¿€æ´»é€»è¾‘ï¼šé¦–æ¬¡ç‚¹å‡»é¡µé¢æ¿€æ´»èƒŒæ™¯éŸ³ä¹ï¼ˆä¸å½±å“ globalPlayBtn å·²å­˜åœ¨é€»è¾‘ï¼‰ */
document.addEventListener("click", function () {
  if (bgmEl && bgmEl.paused) bgmEl.play().catch(()=>{});
}, { once: true });
</script>
</body>
</html>
