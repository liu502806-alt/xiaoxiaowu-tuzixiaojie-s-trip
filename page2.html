<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>æ˜Ÿå…‰æ‹¾æ¢¦ â€” æŒ¥é‡‘ä¹‹å¤œï¼ˆpage2ï¼‰</title>
<style>

/* é¡µé¢å’ŒèƒŒæ™¯ */ /* page and bg set up*/

:root{
  --dialog-bg: rgba(255,255,255,0.78); /* å¯¹è¯æ¡†ä¸é€æ˜åº¦ */
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;width:100%;overflow:hidden;font-family:"PingFang SC","Helvetica Neue",Arial,sans-serif;background:#050014}
body{
  background-image: url('background.jpg');
  background-position: center;
  background-size: cover;
  background-repeat: no-repeat;
  background-attachment: fixed;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ç”»å¸ƒå æ»¡æ•´ä¸ªé¡µé¢ï¼ˆé€æ˜ï¼‰*//* transparent bg */
#gameCanvas{position:fixed;inset:0;z-index:2;display:block}

/* HUDï¼ˆåˆ†æ•° + è¿›åº¦æ¡ï¼‰ç½®é¡¶å±…ä¸­ */ /* HUD Score & progress bar */
.hud{
  position:fixed;top:18px;left:50%;transform:translateX(-50%);
  z-index:8;display:flex;align-items:center;gap:14px;
  background:rgba(0,0,0,0.18);padding:8px 14px;border-radius:999px;backdrop-filter:blur(6px)
}
#score{color:#fff;font-weight:700;font-size:18px}
.progress-wrap{width:180px;height:12px;background:rgba(255,255,255,0.08);border-radius:999px;padding:2px}
.progress-bar{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,#ffd86a,#ff9ad6);box-shadow:0 6px 18px rgba(255,120,190,0.08);transition:width .28s ease}

/* è¿”å›ä¸»é¡µæŒ‰é’® *//* Home bottom*/
#backBtn{position:fixed;left:18px;top:18px;z-index:9;background:rgba(255,255,255,0.08);color:#fff;border:none;border-radius:12px;padding:8px 12px;cursor:pointer;backdrop-filter:blur(4px)}

/* å¼€å§‹è¦†ç›–å±‚ï¼ˆç‚¹å‡»å¼€å§‹åè§¦å‘å¼€åœºç‰¹æ•ˆï¼Œå†éšè—ï¼‰ *//* intro layers */
.start-overlay{
  position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,rgba(5,3,12,0.6),rgba(3,1,9,0.7));
}
.start-card{
  background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
  padding:28px 36px;border-radius:16px;color:#fff;text-align:center;backdrop-filter:blur(6px);
  box-shadow:0 12px 36px rgba(0,0,0,0.6)
}
.start-card h2{font-size:20px;margin-bottom:6px}
.start-btn{margin-top:12px;padding:10px 26px;border-radius:12px;border:none;background:linear-gradient(90deg,#ffb3e6,#ff77c5);color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(255,110,180,0.18)}

/* å¯¹è¯æ¡† *//* dialogbox */
.dialog{
  position:fixed;left:50%;bottom:48px;transform:translateX(-50%);z-index:18;
  display:flex;align-items:center;gap:12px;padding:12px 18px;border-radius:14px;
  background: var(--dialog-bg); 
  backdrop-filter: blur(10px);
  box-shadow:0 12px 40px rgba(0,0,0,0.45);
  color:#1b0a1a; 
  max-width:86vw;
  visibility:hidden;opacity:0;transition:opacity .45s ease, transform .35s ease;
}
.dialog.show{visibility:visible;opacity:1;transform:translateX(-50%) translateY(-6px)}
.dialog img{width:88px;height:88px;border-radius:12px;object-fit:cover;box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); /* æŸ”å…‰å¤–å‘å…‰ */
  backdrop-filter: blur(6px); /* èƒŒæ™¯æŸ”åŒ– */
  border: 2px solid rgba(255, 215, 0, 0.5);}
.dialog .txt{display:flex;flex-direction:column}
.dialog .txt .name{font-weight:800;color:#ffdfe9;margin-bottom:6px}
.dialog .txt .line{font-size:15px;line-height:1.3;color:#fff}

/* çˆ†ç‚¸ç‰¹æ•ˆ */
.explosion{
  position:fixed;left:50%;transform:translateX(-50%);bottom:140px;z-index:99998;pointer-events:none;display:flex;align-items:center;justify-content:center;
}
.explosion .blast{
  width:18px;height:18px;border-radius:50%;background:radial-gradient(circle, rgba(255,240,200,0.95) 0%, rgba(255,160,60,0.85) 40%, rgba(255,80,30,0.6) 100%);
  box-shadow:0 0 40px rgba(255,150,40,0.6);
  animation:blastPop .45s ease-out forwards;
}
.explosion .shard{position:absolute;width:6px;height:6px;border-radius:50%;background:rgba(255,220,140,0.95);filter:blur(.6px);opacity:0.98;}
@keyframes blastPop{
  0%{transform:scale(0.2);opacity:1}
  60%{transform:scale(1.6);opacity:0.9}
  100%{transform:scale(2.8);opacity:0}
}

/* æ˜Ÿå…‰ç‰¹æ•ˆå®¹å™¨ï¼ˆDOM å†…ç”Ÿæˆï¼‰*/ /* Star effectï¼‰*/
.stars-layer{position:fixed;inset:0;pointer-events:none;z-index:15}

/* å•ä¸ªæ˜Ÿå…‰ï¼ˆé€šè¿‡ JS åŠ¨æ€åˆ›å»ºï¼‰ *//* single star*/
.star{
  position:absolute;
  border-radius:50%;
  pointer-events:none;
  opacity:0;transform:
  scale(0.6);
  filter:blur(.4px);
  mix-blend-mode:screen;
  animation:starRise 2.2s ease forwards;
}
@keyframes starRise{
  0%{opacity:0;transform:translateY(0) scale(0.6)}
  30%{opacity:0.85;transform:translateY(-24px) scale(1)}
  100%{opacity:0;transform:translateY(-80px) scale(0.8)}
}

/* å°å±ä¼˜åŒ– *//* small screen optimization */
@media (max-width:420px){
  .hud{gap:10px;padding:6px 10px}
  .progress-wrap{width:120px}
  .dialog img{width:56px;height:56px}
}
</style>
</head>
<body>
  <!-- è¿”å›æŒ‰é’® --> <!-- back bottom -->
  <button id="backBtn" onclick="location.href='index.html'">è¿”å›ä¸»é¡µ</button>
  <button id="resetStartBtn" style="position:fixed;left:18px;top:60px;z-index:9;background:rgba(255,255,255,0.06);color:#fff;border:none;border-radius:12px;padding:6px 10px;cursor:pointer;backdrop-filter:blur(4px);font-size:12px;">é‡ç½®å¼€å§‹é¡µ</button>

  <!-- é¡¶éƒ¨ HUDï¼šåˆ†æ•°ä¸è¿›åº¦ --><!-- Top HUDï¼šScore & progress bar -->
  <div class="hud" role="status" aria-live="polite">
  <div id="score">ğŸ’° 0</div>
<!-- è¿å‡»æ•°æ˜¾ç¤ºåœ¨å·¦ä¸Šè§’ï¼ŒéŸ³é‡æŒ‰é’®ä¸‹æ–¹ -->
<div id="combo" style="position:fixed;left:18px;top:54px;z-index:9999;color:#fffa;font-weight:900;font-size:20px;letter-spacing:1px;user-select:none;pointer-events:none;text-shadow:0 2px 8px #0008,0 0 2px #fff;">è¿å‡» Ã—1</div>
    <div class="progress-wrap" title="è¿›åº¦ï¼ˆæ”¶é›† 5 ä¸ªè§¦å‘ä¸€å¥è¯ï¼‰">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <!-- ç”»å¸ƒï¼šç»˜åˆ¶é‡‘å¸ã€ç¯®å­ã€å…‰æ•ˆ -->  <!-- Elements drown in Canvas-->
  <canvas id="gameCanvas"></canvas>

  <!-- æ˜Ÿå…‰ DOM å±‚ï¼šå¼€åœºæ—¶åˆ›å»ºè‹¥å¹²æ˜Ÿå…‰å…ƒç´ å¹¶æ’­æ”¾åŠ¨ç”» --> <!-- Start Elements drown in Canvas-->
  <div class="stars-layer" id="starsLayer" aria-hidden="true"></div>

  <!-- å¼€å§‹è¦†ç›–ï¼ˆå¿…é¡»çš„ç”¨æˆ·äº¤äº’ï¼Œç”¨äºè§¦å‘éŸ³é¢‘ä¸å¼€åœºç‰¹æ•ˆï¼‰ -->  <!-- Start (interact is needed to activate the audioï¼‰ -->
  <div class="start-overlay" id="startOverlay" role="dialog" aria-modal="true">
    <div class="start-card">
      <h2>æ˜Ÿå…‰æ‹¾æ¢¦ Â· æŒ¥é‡‘ä¹‹å¤œ</h2>
      <div style="color:#ffeef9;font-size:14px;margin-top:6px">ç”¨é¼ æ ‡ / æ‰‹æŒ‡ç§»åŠ¨å¤´å† ï¼Œæ¥ä½ä¸‹è½çš„æ˜Ÿå…‰</div>
      <button class="start-btn" id="startBtn">å¼€å§‹</button>

  <!-- å¯¹è¯æ¡†ï¼šåªä¿ç•™ä¸€ä»½ï¼Œé¿å…é‡å¤ id --> 
  <div class="dialog" id="dialogBox" aria-hidden="true">
    <img id="dialogPic" src="lc1.jpg" alt="å¤´åƒ">
    <div class="txt">
      <div class="name" id="dialogName">è§å°äº”</div>
      <div class="line" id="dialogLine">â€”â€”</div>
    </div>
  </div>

    </div>
  </div>
<script>

/* ================== é…ç½®åŒºï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰ ================== *//* === Set up === */
const CONFIG = {
  imagesPath: '',                  // è‹¥å›¾ç‰‡å’Œ HTML åœ¨åŒä¸€ç›®å½•ï¼Œç•™ç©ºï¼›è‹¥åœ¨ ./images/ åˆ™æ”¹ä¸º './images/'
  coinFiles: ['coin.png', 'coin2.png'],
  basketFile: 'basket.png',
  pic1Files: ['xy1.jpg', 'xy2.jpg', 'xy3.jpg'],
  pic2Files: ['lc1.jpg', 'lc2.jpg', 'lc3.jpg'],
  neededPerDialogue: 10,
  spawnInterval: 900,
  starMin: 15,
  starMax: 20,
  introDuration: 2000,
  // æ–°å¢æ‰è½ç‰©æ–‡ä»¶åä¸é…ç½®
  fallingTypes: [
    { type: 'bomb', file: 'bomb.png', score: -1, weight: 3 },
    { type: 'xxxz', file: 'xxxz.png', score: 5, weight: 1 },
    { type: 'chxz', file: 'chxz.png', score: 5, weight: 1 }
  ],
  maxCoins: 24,
  maxFalling: 8
};

/* ========== å°è¯ï¼ˆæ ¹æ®é€‰æ‹©çš„å¤´åƒæ˜¾ç¤ºä¸åŒæ–‡æœ¬ï¼‰ ========== */
const DIALOGUES = {
  pic1: {
    name: "è§å°äº”",
    lines: [
      "ä½ ä»Šå¤©ä¹Ÿå¾ˆå¥½çœ‹ã€‚",
      "é è¿‘ä¸€ç‚¹ï¼Œè®©æˆ‘çœ‹çœ‹ä½ ã€‚"
    ]
  },
  pic2: {
    name: "å…”å­å°å§",
    lines: [
      "ä½ æ¥å•¦ï¼Œæˆ‘å°±çŸ¥é“ä½ ä¼šæ¥ã€‚",
      "æƒ³æˆ‘äº†å—ï¼Ÿ"
    ]
  }
};

const PHOTO_DIALOGUES = {
  'xy1.jpg': 'æˆ‘çš„çˆ±äººï¼Œå¸Œæœ›æˆ‘èƒ½é€è¿‡å±å¹•å»è§¦æ‘¸ä½ ',
  'xy2.jpg': 'æƒå’Œé’±è¿™ä¸€å—è¿˜å¾—è®ºå“¥',
  'xy3.jpg': 'ä¸‹é›¨äº†å¿«ç‚¹è·‘ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªäººå†…å¿ƒåˆåœ¨å“­ï¼Œä¸è¿‡æˆ‘ä¿è¯ä½ è‚¯å®šä¸ä¼šè¿™æ ·çš„',
  'lc1.jpg': 'çœ¼ç†Ÿä¸ï¼ŒæŠŠæœ¬æ€»è£å½“å±ä¿è¿™ä¹ˆä¹…åº”è¯¥ä¼šæœ‰å°è±¡äº†å§',
  'lc2.jpg': 'å¥½chillçš„åˆåï¼Œå’Œå…”å­å°å§',
  'lc3.jpg': 'ç†Šç†Šæ¥æ‰“å·¥å•¦ï¼Œcosplayè­¦å¯Ÿã€‚å°æ ·ï¼Œè¿·å€’ä½ äº†å§'
};

/* ================== ç”»å¸ƒä¸èµ„æºåˆå§‹åŒ– ================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

/* HUD å…ƒç´  */
const scoreEl = document.getElementById('score');
const progressBar = document.getElementById('progressBar');
const dialogBox = document.getElementById('dialogBox');
const dialogPic = document.getElementById('dialogPic');
const dialogName = document.getElementById('dialogName');
const dialogLine = document.getElementById('dialogLine');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const starsLayer = document.getElementById('starsLayer');

// å¼€å§‹é¡µé»˜è®¤æ˜¾ç¤ºï¼ˆä¸è‡ªåŠ¨éšè—ï¼‰

/* ========== éŸ³æ•ˆä¸æŒ¯åŠ¨ï¼ˆSFXï¼‰ ========== */
const SFX_VOLUME = 0.6; // æ‰€æœ‰éŸ³æ•ˆç»Ÿä¸€éŸ³é‡ï¼ˆ0.0 - 1.0ï¼‰
const bgmEl = document.getElementById('bgm');
try{ if (bgmEl) bgmEl.volume = 0.45; } catch(e){}

const sfx = {
  coin: new Audio(CONFIG.imagesPath + 'coin1.mp3'),
  coin2: new Audio(CONFIG.imagesPath + 'coin2.mp3'),
  bomb: new Audio(CONFIG.imagesPath + 'bomb.mp3')
};
Object.values(sfx).forEach(a=>{ a.preload = 'auto'; a.volume = SFX_VOLUME; a.crossOrigin = 'anonymous'; });

// Combo ç³»ç»Ÿï¼ˆåªç»Ÿè®¡è¿ç»­æ”¶é‡‘å¸ï¼Œç‚¸å¼¹æ¸…é›¶ï¼‰
let combo = 0;
let comboTimer = null;
const COMBO_TIMEOUT = 1500; // ms
const comboEl = document.getElementById('combo');
function increaseCombo(){
  combo++;
  if(comboEl) comboEl.textContent = 'è¿å‡» Ã—' + combo;
  clearTimeout(comboTimer);
  comboTimer = setTimeout(()=>{ combo = 0; if(comboEl) comboEl.textContent = 'è¿å‡» Ã—1'; }, COMBO_TIMEOUT);
}
function resetCombo(){ combo = 0; clearTimeout(comboTimer); if(comboEl) comboEl.textContent = 'è¿å‡» Ã—1'; }

function getMultiplier(){
  // multiplier grows with combo but caps to 5x
  return Math.max(1, Math.min(5, Math.floor(combo/3) + 1));
}

// éœ‡åŠ¨å°è£…ï¼ˆå…¼å®¹æ€§ï¼‰
function tryVibrate(ms){ if (navigator && navigator.vibrate) try{ navigator.vibrate(ms); } catch(e){} }

/* æ¸¸æˆçŠ¶æ€ */
let coins = [];
let particles = [];
let fallingItems = []; // æ–°å¢ï¼šé€šç”¨æ‰è½ç‰©ï¼ˆbomb / xxxz / chxzï¼‰
let score = 0;
let dialogVisible = false;
let progress = 0;
let running = false;
let spawnTimer = null;
let itemSpawnTimer = null;
let animReq = null;
let logicTimer = null;
let rafId = null; // <- æ–°å¢ï¼šç”¨äº requestAnimationFrame å¾ªç¯æ ‡è¯†
let paused = false; // æ–°å¢ï¼šæš‚åœå¼€å…³
// è®°å½•ç”¨äºæ£€æµ‹æ¯10åˆ†è§¦å‘ä¸€æ¬¡å¯¹è¯çš„çŠ¶æ€ï¼ˆä½¿ç”¨ prev/current tick è®¡ç®—ï¼‰
let lastScoreTick = Math.floor(score / 10);

/* ç¯®å­ */
const basket = {
  x: W/2 - 80,
  y: H - 140,
  w: 160,
  h: 90,
  img: null
};

/* å°è¯•åŠ è½½ç¯®å­å›¾ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™ä½¿ç”¨çŸ©å½¢ï¼‰ */
const basketImg = new Image();
basketImg.src = CONFIG.imagesPath + CONFIG.basketFile;
basketImg.onload = ()=> basket.img = basketImg;
basketImg.onerror = ()=> basket.img = null;

/* é¢„åŠ è½½é‡‘å¸å›¾ï¼ˆå¯é€‰ï¼‰ */
const randomCoin = CONFIG.coinFiles[Math.floor(Math.random() * CONFIG.coinFiles.length)];
const coin = document.createElement("img");
coin.src = CONFIG.imagesPath + randomCoin;

/* ========== å·¥å…·å‡½æ•° ========== */
function rand(min,max){ return Math.random()*(max-min)+min }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)) }

/* ========== é‡‘å¸ç”Ÿæˆä¸ç²’å­æ•ˆæœ ========== */
function spawnCoin(filename) {
  if (coins.length > CONFIG.maxCoins) return;
  const size = rand(30, 56);
  const x = rand(20, W - 20 - size);
  const y = -size;
  const speed = rand(2.5, 5.0);
  const rot = rand(-0.4, 0.4);

  const file = filename || CONFIG.coinFiles[Math.floor(Math.random() * CONFIG.coinFiles.length)];
  const img = new Image();
  img.src = CONFIG.imagesPath + file;
  img.onerror = () => { /* fallback handled in draw */ };

  // å­˜å‚¨æ–‡ä»¶åä»¥ä¾¿ç»˜åˆ¶ä¸åŒçš„å‘å…‰
  coins.push({ x, y, size, speed, rot, img, file });
}

/* æ–°å¢ï¼šç”Ÿæˆæ‰è½ç‰©ï¼ˆbomb / xxxz / chxzï¼‰ */
function spawnFallingItem() {
  if (fallingItems.length >= CONFIG.maxFalling) return;
  // é€‰æ‹©å¸¦æƒé‡çš„æ‰è½ç‰©ï¼Œå‡å°‘ç¨€æœ‰å¥–åŠ±çš„å‡ºç°æ¦‚ç‡
  const pool = [];
  CONFIG.fallingTypes.forEach(ft => {
    const w = ft.weight || 1;
    for (let i = 0; i < w; i++) pool.push(ft);
  });
  const pick = pool[Math.floor(Math.random() * pool.length)];
  const size = rand(34, 62);
  const x = rand(20, W - 20 - size);
  const y = -size;
  const speed = rand(2.8, 4.8);
  const rot = rand(-0.4, 0.4);
  const img = new Image();
  img.src = CONFIG.imagesPath + pick.file;
  img.onerror = () => {};
  fallingItems.push({
    type: pick.type,
    file: pick.file,
    x, y, size, speed, rot, img,
    score: pick.score
  });
}

function spawnParticles(x,y,color='rgba(255,220,240,0.95)'){
  for(let i=0;i<10;i++){
    particles.push({
      x, y,
      vx: rand(-2.5,2.5),
      vy: rand(-4,-1),
      size: rand(3,8),
      life: rand(500,1100),
      born: Date.now(),
      color
    });
  }
}

/* ========== åˆ†æ•°ç»Ÿä¸€æ›´æ–°ï¼ˆç¡®ä¿æ¯åˆ° 10 åˆ†è§¦å‘ä¸€æ¬¡å¯¹è¯ï¼‰ ========== */
function addScore(delta){
  const prev = score;
  score = Math.max(0, score + (delta || 0));
  // æ›´æ–°æ˜¾ç¤ºä¸å­˜å‚¨
  scoreElUpdate();
  saveScoresToStorage();

  // è‹¥è¶Šè¿‡ 10 çš„åˆ»åº¦ï¼ˆä¾‹å¦‚ 9 -> 11ï¼‰ï¼Œè§¦å‘ä¸€æ¬¡å¯¹è¯
  const prevTick = Math.floor(prev / 10);
  const newTick = Math.floor(score / 10);
  if (newTick > prevTick) {
    const times = newTick - prevTick;
    for (let i = 0; i < times; i++) {
      setTimeout(()=>{ try { triggerDialogue(); } catch (e){} }, 220 * i);
    }
  }
}

/* ========== è¿›åº¦ç»Ÿä¸€æ›´æ–°ï¼šæ”¯æŒæº¢å‡ºä¿ç•™å¹¶æŒ‰é˜ˆå€¼è§¦å‘å¯¹è¯ï¼ˆcarry-overï¼‰ ========== */
function addProgress(amount){
  if (!amount || amount <= 0) return;
  progress += amount;
  const needed = CONFIG.neededPerDialogue;
  // è®¡ç®—è§¦å‘æ¬¡æ•°ä¸å‰©ä½™è¿›åº¦
  const triggers = Math.floor(progress / needed);
  progress = progress % needed;
  // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
  progressBar.style.width = (progress / needed * 100) + '%';
  // è‹¥æœ‰è§¦å‘æ¬¡æ•°ï¼ŒæŒ‰é¡ºåºå…¥é˜Ÿè§¦å‘ï¼ˆç¨å¾®é”™å¼€ä»¥ä¾¿é˜Ÿåˆ—æ˜¾ç¤ºï¼‰
  for(let i=0;i<triggers;i++){
    setTimeout(()=>{ triggerDialogue(); }, 220 * i);
  }
}

/* ========== ç»˜åˆ¶å‡½æ•°ï¼ˆå¢å¼ºï¼šä¸ºä¸åŒé‡‘å¸é¢œè‰²åŠ å¤–å‘å…‰ï¼‰ ========== */
function draw(){
  ctx.clearRect(0,0,W,H);

  // ç»˜åˆ¶é‡‘å¸ï¼ˆå¸¦æ¸å˜å¤–å‘å…‰ï¼‰
  coins.forEach(c=>{
    ctx.save();

    // æ ¹æ®æ–‡ä»¶åé€‰æ‹© glow é¢œè‰²
    const fname = (c.file || '').toLowerCase();
    let glow = 'rgba(255,200,240,0.9)'; // fallback
    if (fname.indexOf('coin.png') !== -1 || fname.indexOf('coin') !== -1 && fname.indexOf('coin2') === -1) {
      glow = 'rgba(124,255,211,0.85)'; // #7cffd3
    }
    if (fname.indexOf('coin2') !== -1) {
      glow = 'rgba(255,95,126,0.88)'; // #ff5f7e
    }

    // å…ˆç»˜åˆ¶æ›´å¤§çš„æ¨¡ç³Šåœ†æ¥è¡¨ç°æ¸å˜å‘å…‰
    const gx = c.x + c.size/2;
    const gy = c.y + c.size/2;
    const rg = ctx.createRadialGradient(gx, gy, c.size*0.15, gx, gy, c.size*1.3);    // ...existing code...
    /* start æŒ‰é’®ç»‘å®šï¼ˆåªè§¦å‘å¼€åœºç‰¹æ•ˆä¸å¯åŠ¨ï¼‰ */
    startBtn.addEventListener('click', ()=>{
      startOverlay.style.display = 'none';
      playIntroEffectAndStart();
      // å¯åŠ¨æ‰è½ç‰©å®šæ—¶å™¨
      if (itemSpawnTimer) clearInterval(itemSpawnTimer);
      itemSpawnTimer = setInterval(spawnFallingItem, Math.max(1200, CONFIG.spawnInterval * 1.1));
    });
    // ...existing code...    // ...existing code...
    /* start æŒ‰é’®ç»‘å®šï¼ˆåªè§¦å‘å¼€åœºç‰¹æ•ˆä¸å¯åŠ¨ï¼‰ */
    startBtn.addEventListener('click', ()=>{
      startOverlay.style.display = 'none';
      playIntroEffectAndStart();
      // å¯åŠ¨æ‰è½ç‰©å®šæ—¶å™¨
      if (itemSpawnTimer) clearInterval(itemSpawnTimer);
      itemSpawnTimer = setInterval(spawnFallingItem, Math.max(1200, CONFIG.spawnInterval * 1.1));
    });
    // ...existing code...    // ...existing code...
    /* start æŒ‰é’®ç»‘å®šï¼ˆåªè§¦å‘å¼€åœºç‰¹æ•ˆä¸å¯åŠ¨ï¼‰ */
    startBtn.addEventListener('click', ()=>{
      startOverlay.style.display = 'none';
      playIntroEffectAndStart();
      // å¯åŠ¨æ‰è½ç‰©å®šæ—¶å™¨
      if (itemSpawnTimer) clearInterval(itemSpawnTimer);
      itemSpawnTimer = setInterval(spawnFallingItem, Math.max(1200, CONFIG.spawnInterval * 1.1));
    });
    // ...existing code...
    rg.addColorStop(0, glow);
    rg.addColorStop(0.6, 'rgba(0,0,0,0)');
    ctx.fillStyle = rg;
    ctx.beginPath();
    ctx.ellipse(gx, gy, c.size*1.35, c.size*1.35, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.translate(gx, gy);
    ctx.rotate(c.rot);
    ctx.shadowBlur = 12;
    ctx.shadowColor = glow;

    if (c.img && c.img.complete && c.img.naturalWidth) {
      ctx.drawImage(c.img, -c.size/2, -c.size/2, c.size, c.size);
    } else {
      const g = ctx.createRadialGradient(0,0,c.size*0.1,0,0,c.size*0.9);
      g.addColorStop(0,'#fffdd8'); g.addColorStop(1,'#ffc94a');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(0,0,c.size/2,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  });

  // ç»˜åˆ¶æ‰è½ç‰©ï¼ˆbomb / xxxz / chxzï¼‰
  fallingItems.forEach(it=>{
    ctx.save();
    const gx = it.x + it.size/2;
    const gy = it.y + it.size/2;
    // bomb ä½¿ç”¨çº¢è‰²å¾®å¼±å‘å…‰ï¼Œå¥–åŠ±ç‰©å“ä½¿ç”¨é‡‘è‰²å…‰
    if (it.type === 'bomb') {
      ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(255,90,90,0.9)';
    } else {
      ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(255,220,140,0.9)';
    }
    ctx.translate(gx, gy);
    ctx.rotate(it.rot);
    if (it.img && it.img.complete && it.img.naturalWidth) {
      ctx.drawImage(it.img, -it.size/2, -it.size/2, it.size, it.size);
    } else {
      ctx.fillStyle = it.type === 'bomb' ? 'rgba(200,60,60,0.95)' : 'rgba(255,215,120,0.95)';
      ctx.beginPath(); ctx.arc(0,0,it.size/2,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  });

  // ç»˜åˆ¶ç¯®å­
  if(basket.img){
    ctx.drawImage(basket.img, basket.x, basket.y, basket.w, basket.h);
  }else{
    const grad = ctx.createRadialGradient(basket.x + basket.w/2, basket.y + 20, 10, basket.x + basket.w/2, basket.y + 20, 80);
    grad.addColorStop(0,'rgba(255,200,230,0.12)'); grad.addColorStop(1,'rgba(255,200,230,0)');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.ellipse(basket.x + basket.w/2, basket.y + basket.h - 5, basket.w*0.7, 22, 0, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = 'rgba(255,190,210,0.95)';
    ctx.fillRect(basket.x, basket.y, basket.w, basket.h*0.6);
  }

  // ç²’å­ç»˜åˆ¶
  for(let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    const age = Date.now() - p.born;
    if(age > p.life){ particles.splice(i,1); continue; }
    const a = 1 - age / p.life;
    ctx.globalAlpha = a;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    p.vy += 0.06;
    p.x += p.vx; p.y += p.vy;
  }

  animReq = requestAnimationFrame(draw);
}

/* ========== æ”¶é›†é€»è¾‘ï¼ˆæ‰©å±•ï¼šå¤„ç†æ‰è½ç‰©ä¸æš‚åœï¼‰ ========== */
function onCoinCollected(coin, cx, cy){
  // coin pickup: play sfx, increase combo, award score (with multiplier), add progress
  try{
    // play coin sfx (both coin1/coin2 visuals use coin1.mp3 per config)
    if (sfx && sfx.coin) { try{ sfx.coin.currentTime = 0; sfx.coin.volume = SFX_VOLUME; sfx.coin.play().catch(()=>{}); } catch(e){} }
  }catch(e){}
  tryVibrate(20);

  increaseCombo();
  const mult = getMultiplier();
  addScore(1 * mult);
  // progress counts raw item value (not multiplied)
  addProgress(1);
  spawnParticles(cx, cy);
  showPickupFly((mult > 1 ? ('Ã—' + mult + ' +') : '+') + '1', cx, cy);
}

/* å¤„ç†æ‰è½ç‰©è¢«ç¯®å­æ¥åˆ° */
function onFallingItemCollected(it, cx, cy){
  // falling item pickup: handle bomb vs reward, with sfx, combo and vibration
  if (it.type === 'bomb'){
    // bomb: play bomb sfx, vibrate, reset combo, deduct score and rollback progress
    try{ if (sfx && sfx.bomb) { sfx.bomb.currentTime = 0; sfx.bomb.volume = SFX_VOLUME; sfx.bomb.play().catch(()=>{}); } }catch(e){}
    tryVibrate([60,30]);
    resetCombo();
    // apply negative score (clamped by addScore)
    addScore(it.score || 0);
    // progress decrease by 1
    progress = Math.max(0, progress - 1);
    // show male lead dialogue with explosion effect
    enqueueDialog({
      imgSrc: CONFIG.imagesPath + ([...CONFIG.pic1Files, ...CONFIG.pic2Files][Math.floor(Math.random() * (CONFIG.pic1Files.length + CONFIG.pic2Files.length))]),
      name: 'ç”·ä¸»',
      text: ['ã€ç”·ä¸»Aã€‘â€¦æˆ‘åŠä½ åˆ«å†ä¹±æ¥äº†ã€‚','ã€ç”·ä¸»Bã€‘â€¦ä½ è¿™æ ·æˆ‘ä¼šæ‹…å¿ƒçš„ã€‚','ã€ç”·ä¸»Aã€‘â€¦ç¬¨è›‹ï¼Œç‚¸å¼¹ä¸èƒ½æ¥å•Šã€‚','ã€ç”·ä¸»Bã€‘â€¦è¿‡æ¥ï¼Œæˆ‘æ•™ä½ æ€ä¹ˆç©ã€‚'][Math.floor(Math.random()*4)],
      bg: 'rgba(0,0,0,0.64)',
      nameColor: '#FFD700',
      duration: 2000,
      explosion: true
    }, true);
  } else {
    // reward: play reward sfx, vibrate, increase combo, award score * multiplier, progress by item value
    try{ if (sfx && sfx.coin2) { sfx.coin2.currentTime = 0; sfx.coin2.volume = SFX_VOLUME; sfx.coin2.play().catch(()=>{}); } }catch(e){}
    tryVibrate(30);
    increaseCombo();
    const mult = getMultiplier();
    addScore((it.score || 0) * mult);
    spawnParticles(cx, cy, 'rgba(255,230,170,0.95)');
    showPickupFly((mult > 1 ? ('Ã—' + mult + ' +' ) : '+') + Math.abs(it.score), cx, cy);
    addProgress(Math.abs(it.score || 0));
  }
}

/* é£˜å­—æ•ˆæœ */
function showPickupFly(text, x, y){
  const el = document.createElement('div');
  el.style.position = 'fixed';
  el.style.left = (x - 12) + 'px';
  el.style.top = (y - 20) + 'px';
  el.style.zIndex = 12;
  el.style.pointerEvents = 'none';
  el.style.color = '#fff';
  el.style.fontWeight = '700';
  el.style.textShadow = '0 6px 18px rgba(255,120,200,0.28)';
  el.textContent = text;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.transition = 'transform .9s ease-out, opacity .9s'; el.style.transform = 'translateY(-48px)'; el.style.opacity = '0'; });
  setTimeout(()=>el.remove(),900);
}

/* æ›´æ–° HUD */
function scoreElUpdate(){
  scoreEl.textContent = `ğŸ’° ${score}`;
  const pct = (progress / CONFIG.neededPerDialogue) * 100;
  progressBar.style.width = pct + '%';

  // ä¿å­˜æœ¬æ¬¡åˆ†æ•°ä¸å†å²è®°å½•ï¼ˆlast, best, todayï¼‰
  try {
    localStorage.setItem("lastScore", String(score));
    const best = parseInt(localStorage.getItem("bestScore") || '0', 10) || 0;
    if (score > best) {
      localStorage.setItem("bestScore", String(score));
    }
    const today = new Date().toLocaleDateString();
    const todayKey = "score_" + today;
    const todayBest = parseInt(localStorage.getItem(todayKey) || '0', 10) || 0;
    if (score > todayBest) {
      localStorage.setItem(todayKey, String(score));
    }
  } catch (e) {
    // æœ¬åœ°å­˜å‚¨å¤±è´¥åˆ™å¿½ç•¥
  }
}

/* äº¤äº’ï¼šæŒ‡é’ˆä¸é”®ç›˜ */
let isPointerDown = false;
window.addEventListener('pointerdown', e=>{ isPointerDown = true; moveBasketTo(e.clientX); });
window.addEventListener('pointermove', e=>{ if(isPointerDown) moveBasketTo(e.clientX); });
window.addEventListener('pointerup', e=>{ isPointerDown = false; });

function moveBasketTo(clientX){
  basket.x = clamp(clientX - basket.w/2, 8, W - basket.w - 8);
}

window.addEventListener('keydown', e=>{
  const step = Math.max(24, Math.round(W/30));
  if(e.key === 'ArrowLeft' || e.key === 'a') basket.x = clamp(basket.x - step, 8, W - basket.w - 8);
  if(e.key === 'ArrowRight' || e.key === 'd') basket.x = clamp(basket.x + step, 8, W - basket.w - 8);
});

/* ä¸»å¾ªç¯ï¼ˆé€»è¾‘ + ç»˜åˆ¶ï¼‰ */
function startGameLoops(){
  if (logicTimer) clearInterval(logicTimer);
  logicTimer = setInterval(()=>{
    if (paused) return; // æš‚åœæ—¶è·³è¿‡é€»è¾‘æ›´æ–°

    for(let i = coins.length-1;i>=0;i--){
      const c = coins[i];
      c.y += c.speed;
      c.rot += 0.01;
      if(c.y + c.size > basket.y &&
         c.x + c.size > basket.x &&
         c.x < basket.x + basket.w){
          onCoinCollected(c, c.x + c.size/2, c.y + c.size/2);
        coins.splice(i,1);
      } else if(c.y > H + 80){
        coins.splice(i,1);
      }
    }

    // æ›´æ–°æ‰è½ç‰©ä½ç½®ã€ç¢°æ’åˆ¤å®šï¼ˆæŒ‰ä½ æä¾›çš„é€»è¾‘ï¼‰
    for (let i = fallingItems.length - 1; i >= 0; i--) {
      const it = fallingItems[i];
      it.y += it.speed;
      it.rot += 0.02;

      const hit =
        it.y + it.size > basket.y &&
        it.x + it.size > basket.x &&
        it.x < basket.x + basket.w;

      if (hit) {
        onFallingItemCollected(it, it.x + it.size/2, it.y + it.size/2);
        fallingItems.splice(i, 1);
        continue;
      }

      if (it.y > H + 60) {
        fallingItems.splice(i, 1);
      }
    }
  }, 30);

  if(!animReq) draw();
}

/* å¼€åœºç‰¹æ•ˆå¹¶å¯åŠ¨æ¸¸æˆï¼ˆç”± startBtn è§¦å‘ï¼‰ */
function playIntroEffectAndStart(){
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(5,2,15,0.85)';
  overlay.style.zIndex = 30;
  overlay.style.pointerEvents = 'none';
  document.body.appendChild(overlay);

  const starCount = Math.floor(rand(CONFIG.starMin, CONFIG.starMax+1));
  for(let i=0;i<starCount;i++){
    const s = document.createElement('div');
    s.className = 'star';
    const size = rand(4,10);
    s.style.width = s.style.height = size + 'px';
    s.style.left = (rand(6,94)) + '%';
    s.style.top = (rand(40,84)) + '%';
    s.style.background = Math.random() < 0.6 ? 'rgba(255,230,250,0.95)' : 'rgba(255,245,190,0.95)';
    s.style.animationDuration = (1.8 + Math.random()*1.2) + 's';
    starsLayer.appendChild(s);
    setTimeout(()=>{ if(s.parentNode) s.parentNode.removeChild(s); }, CONFIG.introDuration + 300);
  }

  overlay.animate([{opacity:1},{opacity:0}],{duration:CONFIG.introDuration,fill:'forwards',easing:'ease-out'});
  setTimeout(()=>{ if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, CONFIG.introDuration + 80);

  setTimeout(()=>{
    if(spawnTimer) clearInterval(spawnTimer);
    spawnTimer = setInterval(spawnCoin, CONFIG.spawnInterval);
    startGameLoops();
    running = true;
  }, CONFIG.introDuration);
}

/* ========== å¯¹è¯è§¦å‘å™¨ ========== */ //Dialog trigger//
function triggerDialogue() {
  // æ„å»º dialogue å†…å®¹å¹¶åŠ å…¥é˜Ÿåˆ—ï¼ˆéä¼˜å…ˆï¼‰
  const pick = Math.random() < 0.5 ? 'pic1' : 'pic2';
  const conf = DIALOGUES[pick];
  const poolName = pick + 'Pool';
  const fileList = CONFIG[pick + 'Files'];
  if (!window[poolName] || window[poolName].length === 0) window[poolName] = [...fileList];
  const index = Math.floor(Math.random() * window[poolName].length);
  const chosenFile = window[poolName].splice(index, 1)[0];
  const imgSrc = CONFIG.imagesPath + chosenFile;

  // é€‰æ‹©å°è¯
  const prev = window._lastDialogPrev || "";
  let nextLine = "";
  if (PHOTO_DIALOGUES[chosenFile]) {
    nextLine = PHOTO_DIALOGUES[chosenFile];
  } else {
    nextLine = conf.lines[Math.floor(Math.random() * conf.lines.length)];
    if (conf.lines.length > 1) {
      let tries = 0;
      while (nextLine === prev && tries++ < 6) {
        nextLine = conf.lines[Math.floor(Math.random() * conf.lines.length)];
      }
    }
  }
  window._lastDialogPrev = nextLine;

  // æ ·å¼é€‰æ‹©
  let bg = null;
  let nameColor = '#FFD700';
  let lineColor = '#fff';
  if (pick === 'pic1') {
    bg = "rgba(128,0,0,0.35)";
    nameColor = '#FFD700';
    lineColor = '#7cffd3';
  } else {
    bg = "rgba(0,255,128,0.35)";
    nameColor = '#FFD700';
    lineColor = '#ff5f7e';
  }

  enqueueDialog({ imgSrc, name: conf.name, text: nextLine, bg, nameColor, lineColor, duration: 3000 }, false);
}


/* ========== è½»é‡éé˜»å¡ä¸´æ—¶å¯¹è¯ï¼ˆæ›¿ä»£ alertï¼‰ ========== */
// å¯¹è¯é˜Ÿåˆ—ï¼ˆç¡®ä¿å¯¹è¯é¡ºåºï¼šbomb ä¼˜å…ˆï¼‰
const dialogQueue = [];
let dialogProcessing = false;

function enqueueDialog(options, priority = false){
  if(priority) dialogQueue.unshift(options);
  else dialogQueue.push(options);
  processDialogQueue();
}

function processDialogQueue(){
  if(dialogProcessing) return;
  const next = dialogQueue.shift();
  if(!next) return;
  dialogProcessing = true;
  showDialog(next).then(()=>{
    dialogProcessing = false;
    // proceed to next
    setTimeout(processDialogQueue, 60);
  });
}

function showDialog(opts){
  return new Promise(resolve => {
  const { imgSrc, name, text, bg = null, nameColor = '#FFD700', lineColor = null, duration = 2200 } = opts || {};
    // å¯é€‰çˆ†ç‚¸ç‰¹æ•ˆï¼ˆç”¨äº bombï¼‰
    if (opts && opts.explosion) {
      try{
        const ex = document.createElement('div');
        ex.className = 'explosion';
        const blast = document.createElement('div'); blast.className = 'blast';
        ex.appendChild(blast);
        // create shards
        for(let i=0;i<8;i++){
          const s = document.createElement('div'); s.className='shard';
          const ang = Math.random()*Math.PI*2; const r = 24 + Math.random()*28;
          s.style.left = '50%'; s.style.top='50%';
          s.style.transform = `translate(${Math.cos(ang)*r}px, ${Math.sin(ang)*r}px)`;
          s.style.transition = 'opacity .5s linear, transform .5s linear';
          ex.appendChild(s);
        }
        document.body.appendChild(ex);
        setTimeout(()=>{ if(ex.parentNode) ex.parentNode.removeChild(ex); }, Math.max(700, duration));
      }catch(e){}
    }
    const el = document.createElement('div');
    el.className = 'dialog show';
    el.style.position = 'fixed';
    el.style.left = '50%';
    el.style.transform = 'translateX(-50%)';
    el.style.bottom = (window.innerHeight - (basket.y || (window.innerHeight - 140)) + 20) + 'px';
    el.style.zIndex = 99999;
    if (bg) el.style.background = bg;

    el.innerHTML = `
      <img class="dialog-pic" src="" alt="å¤´åƒ">
      <div class="txt">
        <div class="name"></div>
        <div class="line"></div>
      </div>
    `;

    const imgEl = el.querySelector('.dialog-pic');
    if (imgSrc) {
      imgEl.src = imgSrc;
      imgEl.onerror = () => imgEl.remove();
    } else {
      imgEl.remove();
    }

  const nameEl = el.querySelector('.name');
  const lineEl = el.querySelector('.line');
  nameEl.textContent = name || '';
  nameEl.style.color = nameColor;
  if (lineColor) lineEl.style.color = lineColor;

    // æ‰“å­—æœºæ•ˆæœ
    (function typeWriter(txt, targetEl){
      let i = 0;
      function typing(){
        if(i < txt.length){ targetEl.textContent += txt.charAt(i++); requestAnimationFrame(typing); }
      }
      typing();
    })(text || '', lineEl);

    document.body.appendChild(el);

    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); resolve(); }, 420);
    }, Math.max(900, duration));
  });
}

// å…¼å®¹åŸ showTempDialog APIï¼šå°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼ˆé»˜è®¤éä¼˜å…ˆï¼‰
function showTempDialog(options){ enqueueDialog(options, false); }

/* æ–°å¢ï¼šç”·ä¸»å¯¹ç™½ï¼ˆæ¥åˆ° bomb æ—¶è§¦å‘ï¼‰ */
function showMaleLeadDialogue() {
  const lines = [
    "ã€ç”·ä¸»Aã€‘â€¦æˆ‘åŠä½ åˆ«å†ä¹±æ¥äº†ã€‚",
    "ã€ç”·ä¸»Bã€‘â€¦ä½ è¿™æ ·æˆ‘ä¼šæ‹…å¿ƒçš„ã€‚",
    "ã€ç”·ä¸»Aã€‘â€¦ç¬¨è›‹ï¼Œç‚¸å¼¹ä¸èƒ½æ¥å•Šã€‚",
    "ã€ç”·ä¸»Bã€‘â€¦è¿‡æ¥ï¼Œæˆ‘æ•™ä½ æ€ä¹ˆç©ã€‚"
  ];
  const line = lines[Math.floor(Math.random() * lines.length)];
  // éšæœºå– pic1 æˆ– pic2 æ± é‡Œé¢çš„ä¸€å¼ å›¾ï¼ˆå…¼å®¹åŸé…ç½®ï¼‰
  const allPics = [...CONFIG.pic1Files, ...CONFIG.pic2Files];
  const img = allPics[Math.floor(Math.random() * allPics.length)];
  // bomb å¯¹è¯ä¼˜å…ˆå±•ç°ï¼ˆpriority = trueï¼‰ï¼Œæ˜¾ç¤º 2s
  enqueueDialog({
    imgSrc: CONFIG.imagesPath + img,
    name: 'ç”·ä¸»',
    text: line,
    bg: 'rgba(0,0,0,0.64)',
    nameColor: '#FFD700',
    duration: 2000
  }, true);
}

/* è¿”å›ä¸»é¡µæŒ‰é’®ï¼šæ˜¾ç¤ºç²‰è‰²å¯¹è¯åå†è·³è½¬ï¼ˆæ‰“å­—æœº + éšæœºå›¾ç‰‡ï¼‰ */
const backBtnEl = document.getElementById('backBtn');
backBtnEl.addEventListener('click', (e) => {
  e.preventDefault();
  const lines = [
    "å›åˆ°é¦–é¡µäº†ï¼Œåˆ«å¿˜äº†å†æ¥ç©ã€‚",
    "è¦ä¸è¦å…ˆä¿å­˜ä¸€ä¸‹æˆç»©ï¼Ÿ",
    "ä¸‹æ¬¡æˆ‘è¿˜ç­‰ç€ä½ å“¦ã€‚"
  ];
  const line = lines[Math.floor(Math.random() * lines.length)];
  const allPics = [...CONFIG.pic1Files, ...CONFIG.pic2Files];
  const img = allPics[Math.floor(Math.random() * allPics.length)];
  showTempDialog({
    imgSrc: CONFIG.imagesPath + img,
    name: 'ç³»ç»Ÿ',
    text: line,
    bg: 'rgba(255,150,200,0.22)', // ç²‰è‰²é€æ˜
    nameColor: '#FFD700',
    duration: 1200
  });
  // ç¨åè·³è½¬ï¼Œç»™æ‰“å­—æœºæ•ˆæœæ—¶é—´
  setTimeout(() => { location.href = 'index.html'; }, 1300);
});

/* æ›´æ–° HUD å­˜æ¡£ï¼šä½¿ç”¨ç”¨æˆ·ç»™å‡ºçš„å­˜å‚¨æ–¹å¼ï¼ˆç®€æ´ç‰ˆï¼‰ */
function saveScoresToStorage() {
  try {
    localStorage.setItem("lastScore", score);

    // æœ€é«˜åˆ†
    let best = localStorage.getItem("bestScore") || 0;
    if (score > best) {
      localStorage.setItem("bestScore", score);
    }

    // ä»Šæ—¥æœ€é«˜
    const today = new Date().toLocaleDateString();
    const todayKey = "score_" + today;

    let todayBest = localStorage.getItem(todayKey) || 0;
    if (score > todayBest) {
      localStorage.setItem(todayKey, score);
    }
  } catch (e) { /* ignore */ }
}

/* ç”¨æ–°çš„ update å¾ªç¯æ›¿æ¢æ‰åŸæ¥çš„ setInterval é€»è¾‘ï¼›æŒ‰ç”¨æˆ·è¦æ±‚å¤„ç† fallingItems ç¢°æ’ç‰‡æ®µ */
function update() {
  // paused æ—¶ä»ä¿æŒ loop ä½†è·³è¿‡æ›´æ–°ï¼ˆç¬¦åˆä½ æä¾›çš„ if (paused) return requestAnimationFrame(update);ï¼‰
  if (paused) {
    rafId = requestAnimationFrame(update);
    return;
  }

  // coins æ›´æ–°
  for (let i = coins.length - 1; i >= 0; i--) {
    const c = coins[i];
    c.y += c.speed;
    c.rot += 0.01;
    if (c.y + c.size > basket.y &&
        c.x + c.size > basket.x &&
        c.x < basket.x + basket.w) {
      onCoinCollected(c, c.x + c.size/2, c.y + c.size/2);
      coins.splice(i, 1);
    } else if (c.y > H + 80) {
      coins.splice(i, 1);
    }
  }

  // fallingItems æ›´æ–° â€” ä½¿ç”¨ä½ æä¾›çš„è¡Œä¸ºï¼Œæ³¨æ„ä¿®æ­£ basket.width -> basket.w
  for (let i = fallingItems.length - 1; i >= 0; i--) {
    const it = fallingItems[i];
    // å›ºå®šé€Ÿåº¦ 3ï¼ˆä½ ç¤ºä¾‹ä¸­ç”¨ 3ï¼‰ï¼Œä½†ä¿ç•™åŸ speed å¦‚æœéœ€è¦å¯æ›¿æ¢ä¸º it.speed
    it.y += 3;

    const hit =
      it.y + it.size > basket.y &&
      it.x + it.size > basket.x &&
      it.x < basket.x + basket.w;

    if (hit) {
      // æ›´æ–°åˆ†æ•°ï¼ˆä½¿ç”¨ addScore å¤„ç† 10 åˆ†è§¦å‘ï¼‰
      addScore(it.score || 0);

      if (it.type === "bomb") {
        // bomb ç‰¹æ®Šå¤„ç†ï¼šå›é€€è¿›åº¦å¹¶æ˜¾ç¤ºç”·ä¸»å¯¹ç™½
        progress = Math.max(0, progress - 1);
        showMaleLeadDialogue();
      } else {
        // å…¶ä»–å¥–åŠ±ç‰©å“äº§ç”Ÿæ‹¾å–ç‰¹æ•ˆå¹¶æŒ‰åˆ†å€¼è®¡å…¥è¿›åº¦ï¼ˆæº¢å‡ºä¿ç•™ï¼‰
        spawnParticles(it.x + it.size/2, it.y + it.size/2, 'rgba(255,230,170,0.95)');
        showPickupFly((it.score > 0 ? '+' : '') + it.score, it.x + it.size/2, it.y + it.size/2);
        addProgress(Math.abs(it.score || 0));
      }

      // fallingItems è¢«æ¥æ”¶ï¼Œç§»é™¤
      fallingItems.splice(i, 1);
      continue;
    }

    if (it.y > H + 40) {
      fallingItems.splice(i, 1);
    }
  }

  // è¯·æ±‚ä¸‹ä¸€å¸§
  rafId = requestAnimationFrame(update);
}

/* å°†åŸæ¥çš„å®šæ—¶å™¨å¯åŠ¨æ›¿æ¢ä¸ºï¼šstartGameLoops() ä»å¯åŠ¨ spawnTimer ä¸ itemSpawnTimerï¼Œä½†ä½¿ç”¨ raf update */
const origStartGameLoops = window.startGameLoops;
window.startGameLoops = function() {
  // æ¸…ç†åŸæœ‰å®šæ—¶å™¨ï¼ˆè‹¥å­˜åœ¨ï¼‰
  if (typeof logicTimer !== 'undefined' && logicTimer) { clearInterval(logicTimer); logicTimer = null; }
  // spawnTimer ç”± playIntroEffectAndStart åˆ›å»º/ç®¡ç†ï¼›è¿™é‡Œåªå¯åŠ¨ raf
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(update);
  // ä¿æŒå…¼å®¹ï¼šè°ƒç”¨åŸå‡½æ•°ä»¥ä¿ç•™å…¶å®ƒå‰¯ä½œç”¨ï¼ˆå¦‚æœåŸå‡½æ•°å­˜åœ¨ï¼‰
  if (typeof origStartGameLoops === 'function') {
    try { origStartGameLoops(); } catch (e) { /* ignore */ }
  }
};

/* è¦†ç›– scoreElUpdate ä»¥ç¡®ä¿å†™å…¥ä½ è¦æ±‚çš„ localStorage æ ¼å¼ï¼ˆå¹¶ä¿ç•™è¿›åº¦æ¡æ›´æ–°ï¼‰ */
const origScoreElUpdate = window.scoreElUpdate;
window.scoreElUpdate = function() {
  // åŸæœ‰æ˜¾ç¤ºé€»è¾‘ï¼ˆä¿ç•™ï¼‰
  if (typeof origScoreElUpdate === 'function') {
    try { origScoreElUpdate(); } catch (e) { /* ignore */ }
  } else {
    scoreEl.textContent = `ğŸ’° ${score}`;
    const pct = (progress / CONFIG.neededPerDialogue) * 100;
    progressBar.style.width = pct + '%';
  }
  // ä¿å­˜ç®€æ´ç‰ˆæœ¬
  saveScoresToStorage();
};

/* é¡µé¢ show äº‹ä»¶ï¼šä¿ç•™åŸæœ‰æç¤ºæµç¨‹ï¼ˆè‹¥ lastScore å­˜åœ¨åˆ™å¼¹ä¸€å¥ï¼‰ï¼Œä½†æ”¹ç”¨ä¸´æ—¶å¯¹è¯ï¼ˆä¸ä½¿ç”¨ alertï¼‰ */
window.addEventListener("pageshow", () => {
  try{ if (localStorage.getItem('startClicked') === '1') return; } catch(e){}
  const lastPlayed = localStorage.getItem("lastScore");
  if (lastPlayed) {
    const lines = [
      "ã€ç”·ä¸»Aã€‘â€¦åˆå›æ¥äº†ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºä½ ä¸è¦æˆ‘äº†ã€‚",
      "ã€ç”·ä¸»Bã€‘â€¦è¿™ä¹ˆå¿«å°±å›é¦–é¡µï¼Ÿæˆ‘è¿˜æ²¡è·Ÿä½ ç©å¤Ÿã€‚",
      "ã€ç”·ä¸»Aã€‘â€¦ä½ çš„æ¸¸æˆæˆç»©æˆ‘éƒ½çœ‹åˆ°äº†ï¼Œå¾ˆå¯çˆ±ã€‚",
      "ã€ç”·ä¸»Bã€‘â€¦å›æ¥å°±å¥½ï¼Œæˆ‘è¿˜ä»¥ä¸ºä½ è¿·è·¯äº†ã€‚"
    ];
    const line = lines[Math.floor(Math.random() * lines.length)];
    // éšæœºå›¾ç‰‡
    const allPics = [...CONFIG.pic1Files, ...CONFIG.pic2Files];
    const img = allPics[Math.floor(Math.random() * allPics.length)];
    showTempDialog({
      imgSrc: CONFIG.imagesPath + img,
      name: 'ç”·ä¸»',
      text: line,
      bg: 'rgba(0,0,0,0.55)',
      nameColor: '#FFD700',
      duration: 2200
    });
  }
});

/* å¯åŠ¨æ—¶ç¡®ä¿ startBtn åªæœ‰ä¸€ä¸ª listenerï¼ˆé˜²æ­¢é‡å¤ï¼‰ */
startBtn.removeEventListener && startBtn.removeEventListener('click', playIntroEffectAndStart);
startBtn.addEventListener('click', ()=>{
  startOverlay.style.display = 'none';
  try{ localStorage.setItem('startClicked', '1'); }catch(e){}
  playIntroEffectAndStart();
  if (itemSpawnTimer) clearInterval(itemSpawnTimer);
  itemSpawnTimer = setInterval(spawnFallingItem, Math.max(1200, CONFIG.spawnInterval * 1.1));
});

// resetStartBtn ç”¨æ¥æ¸…é™¤ startClickedï¼Œä½¿å¼€å§‹è¦†ç›–é¡µå†æ¬¡å¯è§ï¼ˆä¾¿äºè°ƒè¯•æˆ–æ¢å¤ï¼‰
const resetStartBtn = document.getElementById('resetStartBtn');
if (resetStartBtn) {
  resetStartBtn.addEventListener('click', ()=>{
    try{ localStorage.removeItem('startClicked'); }catch(e){}
    startOverlay.style.display = 'flex';
    // small visual hint
    resetStartBtn.textContent = 'å·²é‡ç½®';
    setTimeout(()=> resetStartBtn.textContent = 'é‡ç½®å¼€å§‹é¡µ', 1200);
  });
}
</script>
<!-- åœ¨æ­¤å¤„æ’å…¥æš‚åœ/ç»§ç»­æŒ‰é’® -->
<div style="position:fixed;top:66px;left:50%;transform:translateX(-50%);z-index:9;">
  <button id="pauseBtn" style="padding:6px 12px;border-radius:8px;border:none;background:rgba(255,255,255,0.08);color:#fff;margin-right:8px;cursor:pointer;">â¸ æš‚åœ</button>
  <button id="resumeBtn" style="display:none;padding:6px 12px;border-radius:8px;border:none;background:rgba(255,255,255,0.12);color:#fff;cursor:pointer;">â–¶ ç»§ç»­</button>
</div>

<script>
// æš‚åœé€»è¾‘
document.getElementById("pauseBtn").onclick = () => {
  paused = true;
  document.getElementById("pauseBtn").style.display = "none";
  document.getElementById("resumeBtn").style.display = "inline-block";
};

document.getElementById("resumeBtn").onclick = () => {
  paused = false;
  document.getElementById("resumeBtn").style.display = "none";
  document.getElementById("pauseBtn").style.display = "inline-block";
};
</script>
<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="bgm" src="audio4.mp3" autoplay loop></audio>

<!-- é™éŸ³æŒ‰é’® -->
<div id="muteButton">ğŸ”Š</div>

<style>
#muteButton {
  position: fixed;
  top: 15px;
  right: 15px;
  font-size: 28px;
  cursor: pointer;
  z-index: 9999;
  background: rgba(255,255,255,0.7);
  padding: 6px 10px;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
#muteButton:hover {
  transform: scale(1.1);
  background: rgba(255,255,255,0.9);
}
</style>

<script>
// è‡ªåŠ¨æ’­æ”¾ï¼ˆéœ€è¦ä»»æ„ä¸€æ¬¡ç‚¹å‡»å³å¯æ¿€æ´»ï¼‰
document.addEventListener("click", function () {
  const bgm = document.getElementById("bgm");
  if (bgm.paused) bgm.play();
}, { once: true });

const bgm = document.getElementById("bgm");
const muteBtn = document.getElementById("muteButton");
try{ if (bgm) bgm.volume = 0.45; } catch(e){}

muteBtn.addEventListener("click", () => {
  if (bgm.muted) {
    bgm.muted = false;
    muteBtn.textContent = "ğŸ”Š";
  } else {
    bgm.muted = true;
    muteBtn.textContent = "ğŸ”‡";
  }
});
</script>
<!-- é¡µé¢æ˜¾ç¤ºæ—¶çš„æ¬¢è¿ï¼ˆè‹¥å­˜åœ¨ lastScoreï¼‰ -->
<script>
window.addEventListener("pageshow", () => {
  const lastPlayed = localStorage.getItem("lastScore");

  if (lastPlayed) {
    const lines = [
      "ã€ç”·ä¸»Aã€‘â€¦åˆå›æ¥äº†ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºä½ ä¸è¦æˆ‘äº†ã€‚",
      "ã€ç”·ä¸»Bã€‘â€¦è¿™ä¹ˆå¿«å°±å›é¦–é¡µï¼Ÿæˆ‘è¿˜æ²¡è·Ÿä½ ç©å¤Ÿã€‚",
      "ã€ç”·ä¸»Aã€‘â€¦ä½ çš„æ¸¸æˆæˆç»©æˆ‘éƒ½çœ‹åˆ°äº†ï¼Œå¾ˆå¯çˆ±ã€‚",
      "ã€ç”·ä¸»Bã€‘â€¦å›æ¥å°±å¥½ï¼Œæˆ‘è¿˜ä»¥ä¸ºä½ è¿·è·¯äº†ã€‚"
    ];
    // ä½¿ç”¨éé˜»å¡ä¸´æ—¶å¯¹è¯æ›¿ä»£é˜»å¡ alert
    showTempDialog({
      imgSrc: CONFIG.imagesPath + ([...CONFIG.pic1Files, ...CONFIG.pic2Files][Math.floor(Math.random() * (CONFIG.pic1Files.length + CONFIG.pic2Files.length))]),
      name: 'ç”·ä¸»',
      text: lines[Math.floor(Math.random() * lines.length)],
      bg: 'rgba(0,0,0,0.55)',
      duration: 2200
    });
  }
});
</script>
</body>
</html>
