<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>æ˜Ÿå…‰æ‹¾æ¢¦ â€” æŒ¥é‡‘ä¹‹å¤œï¼ˆpage2ï¼‰</title>
<style>
/* ================= å…¨å±€æ ·å¼ï¼ˆä¸­æ–‡æ³¨é‡Šï¼‰ ================= */
/* é¡µé¢å’ŒèƒŒæ™¯ï¼ˆbody èƒŒæ™¯ä½¿ç”¨ images/bg.jpg æˆ– images/background.jpgï¼ŒæŒ‰ä½ æ”¾çš„åå­—ï¼‰ */
:root{
  --dialog-bg: rgba(255,255,255,0.78); /* å¯¹è¯æ¡†ä¸é€æ˜åº¦ */
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:300%;width:300%;overflow:hidden;font-family:"PingFang SC","Helvetica Neue",Arial,sans-serif;background:#050014}
body{
  /* è¯·æŠŠé¡¹ç›®ä¸­çš„èƒŒæ™¯å›¾å‘½åä¸º images/background.jpgï¼ˆæˆ– images/bg.jpgï¼‰ï¼Œè·¯å¾„ç›¸å¯¹ page2.html */
  background: center/cover no-repeat fixed url('images/background.jpg');
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ç”»å¸ƒå æ»¡æ•´ä¸ªé¡µé¢ï¼ˆé€æ˜ï¼‰*/
#gameCanvas{position:fixed;inset:0;z-index:2;display:block}

/* HUDï¼ˆåˆ†æ•° + è¿›åº¦æ¡ï¼‰ç½®é¡¶å±…ä¸­ */
.hud{
  position:fixed;top:18px;left:50%;transform:translateX(-50%);
  z-index:8;display:flex;align-items:center;gap:14px;
  background:rgba(0,0,0,0.18);padding:8px 14px;border-radius:999px;backdrop-filter:blur(6px)
}
#score{color:#fff;font-weight:700;font-size:18px}
.progress-wrap{width:180px;height:12px;background:rgba(255,255,255,0.08);border-radius:999px;padding:2px}
.progress-bar{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,#ffd86a,#ff9ad6);box-shadow:0 6px 18px rgba(255,120,190,0.08);transition:width .28s ease}

/* è¿”å›ä¸»é¡µæŒ‰é’® */
#backBtn{position:fixed;left:18px;top:18px;z-index:9;background:rgba(255,255,255,0.08);color:#fff;border:none;border-radius:12px;padding:8px 12px;cursor:pointer;backdrop-filter:blur(4px)}

/* å¼€å§‹è¦†ç›–å±‚ï¼ˆç‚¹å‡»å¼€å§‹åè§¦å‘å¼€åœºç‰¹æ•ˆï¼Œå†éšè—ï¼‰ */
.start-overlay{
  position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,rgba(5,3,12,0.6),rgba(3,1,9,0.7));
}
.start-card{
  background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
  padding:28px 36px;border-radius:16px;color:#fff;text-align:center;backdrop-filter:blur(6px);
  box-shadow:0 12px 36px rgba(0,0,0,0.6)
}
.start-card h2{font-size:20px;margin-bottom:6px}
.start-btn{margin-top:12px;padding:10px 26px;border-radius:12px;border:none;background:linear-gradient(90deg,#ffb3e6,#ff77c5);color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(255,110,180,0.18)}

/* å¯¹è¯æ¡†ï¼ˆå·²æ”¹ä¸ºæ›´ä¸é€æ˜ï¼‰ */
.dialog{
  position:fixed;left:50%;bottom:48px;transform:translateX(-50%);z-index:18;
  display:flex;align-items:center;gap:12px;padding:12px 18px;border-radius:14px;
  background: var(--dialog-bg); /* åŠé€æ˜ä½†åä¸é€æ˜ */
  backdrop-filter: blur(10px);
  box-shadow:0 12px 40px rgba(0,0,0,0.45);
  color:#1b0a1a; /* å¯¹æ¯”ä¸ºæ·±è‰²æ–‡å­— */
  max-width:86vw;
  visibility:hidden;opacity:0;transition:opacity .45s ease, transform .35s ease;
}
.dialog.show{visibility:visible;opacity:1;transform:translateX(-50%) translateY(-6px)}
.dialog img{width:88px;height:88px;border-radius:12px;object-fit:cover;box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); /* æŸ”å…‰å¤–å‘å…‰ */
  backdrop-filter: blur(6px); /* èƒŒæ™¯æŸ”åŒ– */
  border: 2px solid rgba(255, 215, 0, 0.5);}
.dialog .txt{display:flex;flex-direction:column}
.dialog .txt .name{font-weight:800;color:#ffdfe9;margin-bottom:6px}
.dialog .txt .line{font-size:15px;line-height:1.3;color:#fff}

/* æ˜Ÿå…‰ç‰¹æ•ˆå®¹å™¨ï¼ˆDOM å†…ç”Ÿæˆï¼‰*/
.stars-layer{position:fixed;inset:0;pointer-events:none;z-index:15}

/* å•ä¸ªæ˜Ÿå…‰ï¼ˆé€šè¿‡ JS åŠ¨æ€åˆ›å»ºï¼‰ */
.star{
  position:absolute;
  border-radius:50%;
  pointer-events:none;
  opacity:0;transform:
  scale(0.6);
  filter:blur(.4px);
  mix-blend-mode:screen;
  animation:starRise 2.2s ease forwards;
}
@keyframes starRise{
  0%{opacity:0;transform:translateY(0) scale(0.6)}
  30%{opacity:0.85;transform:translateY(-24px) scale(1)}
  100%{opacity:0;transform:translateY(-80px) scale(0.8)}
}

/* å°å±ä¼˜åŒ– */
@media (max-width:420px){
  .hud{gap:10px;padding:6px 10px}
  .progress-wrap{width:120px}
  .dialog img{width:56px;height:56px}
}
</style>
</head>
<body>
  <!-- è¿”å›æŒ‰é’® -->
  <button id="backBtn" onclick="location.href='index.html'">è¿”å›ä¸»é¡µ</button>

  <!-- é¡¶éƒ¨ HUDï¼šåˆ†æ•°ä¸è¿›åº¦ -->
  <div class="hud" role="status" aria-live="polite">
    <div id="score">ğŸ’° 0</div>
    <div class="progress-wrap" title="è¿›åº¦ï¼ˆæ”¶é›† 5 ä¸ªè§¦å‘ä¸€å¥è¯ï¼‰">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <!-- ç”»å¸ƒï¼šç»˜åˆ¶é‡‘å¸ã€ç¯®å­ã€å…‰æ•ˆï¼ˆcanvas é€æ˜ï¼ŒèƒŒæ™¯ç”± body æä¾›ï¼‰ -->
  <canvas id="gameCanvas"></canvas>

  <!-- æ˜Ÿå…‰ DOM å±‚ï¼šå¼€åœºæ—¶åˆ›å»ºè‹¥å¹²æ˜Ÿå…‰å…ƒç´ å¹¶æ’­æ”¾åŠ¨ç”» -->
  <div class="stars-layer" id="starsLayer" aria-hidden="true"></div>

  <!-- å¼€å§‹è¦†ç›–ï¼ˆå¿…é¡»çš„ç”¨æˆ·äº¤äº’ï¼Œç”¨äºè§¦å‘éŸ³é¢‘ä¸å¼€åœºç‰¹æ•ˆï¼‰ -->
  <div class="start-overlay" id="startOverlay" role="dialog" aria-modal="true">
    <div class="start-card">
      <h2>æ˜Ÿå…‰æ‹¾æ¢¦ Â· æŒ¥é‡‘ä¹‹å¤œ</h2>
      <div style="color:#ffeef9;font-size:14px;margin-top:6px">ç”¨é¼ æ ‡ / æ‰‹æŒ‡ç§»åŠ¨å¤´å† ï¼Œæ¥ä½ä¸‹è½çš„æ˜Ÿå…‰</div>
      <button class="start-btn" id="startBtn">å¼€å§‹</button>
    </div>
  </div>

  <!-- å¯¹è¯æ¡†ï¼šå¤´åƒ + æ–‡æœ¬ï¼ˆshow ç±»æ§åˆ¶æ˜¾ç¤º/éšè—ï¼‰ -->
  <div class="dialog" id="dialogBox" aria-hidden="true">
    <img id="dialogPic" src="images/pic2Files.jpg" alt="å¤´åƒ">
    <div class="txt">
      <div class="name" id="dialogName">è§å°äº”</div>
      <div class="line" id="dialogLine">â€”â€”</div>
    </div>
  </div>
<script>

/* ================== é…ç½®åŒºï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰ ================== */
/* æ³¨æ„ï¼šå›¾ç‰‡è¯·æ”¾åœ¨ images/ æ–‡ä»¶å¤¹ï¼Œåç§°å¿…é¡»åŒ¹é… */
const CONFIG = {
  imagesPath: 'images/',
  coinFiles: ['coin.png', 'coin2.png'],  // â† æ³¨æ„è¿™é‡Œè¦æœ‰é€—å·
  basketFile: 'basket.png',        // ç¯®å­å›¾ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œä¼šç”¨ç®€å•çŸ©å½¢ä»£æ›¿ï¼‰
  pic1Files: ['xy1.jpg', 'xy2.jpg', 'xy3.jpg'],  // è§å°äº”çš„å¤šå¼ å¤´åƒ
  pic2Files: ['lc1.jpg', 'lc2.jpg', 'lc3.jpg'],  // å…”å­å°å§çš„å¤šå¼ å¤´åƒ
  neededPerDialogue: 5,            // æ¯æ”¶é›†å¤šå°‘ä¸ªé‡‘å¸è§¦å‘ä¸€å¥è¯
  spawnInterval: 900,              // æ¯«ç§’ï¼šç”Ÿæˆé‡‘å¸é—´éš”
  starMin: 15,                     // å¼€åœºæ˜Ÿå…‰æœ€å°‘æ•°é‡
  starMax: 20,                     // å¼€åœºæ˜Ÿå…‰æœ€å¤šæ•°é‡
  introDuration: 2000              // å¼€åœºç‰¹æ•ˆæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
};

/* ========== å°è¯ï¼ˆæ ¹æ®é€‰æ‹©çš„å¤´åƒæ˜¾ç¤ºä¸åŒæ–‡æœ¬ï¼‰ ========== */
/* pic1 -> åå­— "è§å°äº”" ; pic2 -> åå­— "å…”å­å°å§" */
/* æ–‡æœ¬ä¸ºå¯¹â€œæˆ‘â€çš„ç§°å‘¼ä¸ç”œè¨€ï¼ˆä½ å¯åœ¨æ­¤å¤„ç»§ç»­å¢åŠ æˆ–ä¿®æ”¹ï¼‰ */
const DIALOGUES = {
  pic1: {
    name: "è§å°äº”",
    lines: [
      "ä½ ä»Šå¤©ä¹Ÿå¾ˆå¥½çœ‹ã€‚",
      "é è¿‘ä¸€ç‚¹ï¼Œè®©æˆ‘çœ‹çœ‹ä½ ã€‚"
    ]
  },
  pic2: {
    name: "å…”å­å°å§",
    lines: [
      "ä½ æ¥å•¦ï¼Œæˆ‘å°±çŸ¥é“ä½ ä¼šæ¥ã€‚",
      "æƒ³æˆ‘äº†å—ï¼Ÿ"
    ]
  }
};

const PHOTO_DIALOGUES = {
  // --- è§å°äº”ï¼ˆpic1Filesï¼‰ ---
  'xy1.jpg': 'æˆ‘çš„çˆ±äººï¼Œå¸Œæœ›æˆ‘èƒ½é€è¿‡å±å¹•å»è§¦æ‘¸ä½ ',
  'xy2.jpg': 'æƒå’Œé’±è¿™ä¸€å—è¿˜å¾—è®ºå“¥',
  'xy3.jpg': 'ä¸‹é›¨äº†å¿«ç‚¹è·‘ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªäººå†…å¿ƒåˆåœ¨å“­ï¼Œä¸è¿‡æˆ‘ä¿è¯ä½ è‚¯å®šä¸ä¼šè¿™æ ·çš„',

  // --- å…”å­å°å§ï¼ˆpic2Filesï¼‰ ---
  'lc1.jpg': 'çœ¼ç†Ÿä¸ï¼ŒæŠŠæœ¬æ€»è£å½“å±ä¿è¿™ä¹ˆä¹…åº”è¯¥ä¼šæœ‰å°è±¡äº†å§',
  'lc2.jpg': 'å¥½chillçš„åˆåï¼Œå’Œå…”å­å°å§',
  'lc3.jpg': 'ç†Šç†Šæ¥æ‰“å·¥å•¦ï¼Œcosplayè­¦å¯Ÿã€‚å°æ ·ï¼Œè¿·å€’ä½ äº†å§'
};

/* ================== ç”»å¸ƒä¸èµ„æºåˆå§‹åŒ– ================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

/* HUD å…ƒç´  */
const scoreEl = document.getElementById('score');
const progressBar = document.getElementById('progressBar');
const dialogBox = document.getElementById('dialogBox');
const dialogPic = document.getElementById('dialogPic');
const dialogName = document.getElementById('dialogName');
const dialogLine = document.getElementById('dialogLine');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const starsLayer = document.getElementById('starsLayer');

/* æ¸¸æˆçŠ¶æ€ */
let coins = [];         // é‡‘å¸æ•°ç»„
let particles = [];     // ç²’å­ï¼ˆæ˜Ÿå°˜ï¼‰
let score = 0;          // åˆ†æ•°
let dialogVisible = false;
let progress = 0;       // å½“å‰è¿›åº¦ï¼ˆ0..neededPerDialogue-1ï¼‰
let running = false;    // æ¸¸æˆæ˜¯å¦è¿è¡Œ
let spawnTimer = null;  // ç”Ÿæˆé‡‘å¸çš„å®šæ—¶å™¨
let animReq = null;     // requestAnimationFrame id

/* ç¯®å­ï¼ˆç”¨å›¾æˆ–çŸ©å½¢ï¼‰ */
const basket = {
  x: W/2 - 80,
  y: H - 140,
  w: 160,
  h: 90,
  img: null
};

/* å°è¯•åŠ è½½ç¯®å­å›¾ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™ä½¿ç”¨çŸ©å½¢ï¼‰ */
const basketImg = new Image();
basketImg.src = CONFIG.imagesPath + CONFIG.basketFile;
basketImg.onload = ()=> basket.img = basketImg;
basketImg.onerror = ()=> basket.img = null; // è‹¥åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç»˜åˆ¶çŸ©å½¢

/* é¢„åŠ è½½é‡‘å¸å›¾ï¼ˆå¯é€‰ï¼‰ */
const randomCoin = CONFIG.coinFiles[Math.floor(Math.random() * CONFIG.coinFiles.length)];
const coin = document.createElement("img");
coin.src = CONFIG.imagesPath + randomCoin;


/* ========== å·¥å…·å‡½æ•° ========== */
function rand(min,max){ return Math.random()*(max-min)+min }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)) }

/* ========== é‡‘å¸ç”Ÿæˆä¸ç²’å­æ•ˆæœ ========== */
function spawnCoin(filename) {
  if (coins.length > 24) return; // å±å¹•ä¸ŠåŒæ—¶å­˜åœ¨é‡‘å¸æ•°é‡ä¸Šé™
  const size = rand(30, 56);
  const x = rand(20, W - 20 - size);
  const y = -size;
  const speed = rand(2.5, 5.0);
  const rot = rand(-0.4, 0.4);

  // é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å
  const file = filename || CONFIG.coinFiles[Math.floor(Math.random() * CONFIG.coinFiles.length)];
  const img = new Image();
  img.src = CONFIG.imagesPath + file;
  img.onerror = () => { /* æ— å›¾æ—¶ fallback ç”± draw() å¤„ç† */ };

  // å°† img é™„åˆ°è¯¥ coin å®ä¾‹ä¸Š
  coins.push({ x, y, size, speed, rot, img });
}
// æ¯éš” 0.8 ç§’ç”Ÿæˆä¸€ä¸ªé‡‘å¸
setInterval(spawnCoin, 800);

function spawnParticles(x,y,color='rgba(255,220,240,0.95)'){
  for(let i=0;i<10;i++){
    particles.push({
      x, y,
      vx: rand(-2.5,2.5),
      vy: rand(-4,-1),
      size: rand(3,8),
      life: rand(500,1100),
      born: Date.now(),
      color
    });
  }
}

/* ========== ç»˜åˆ¶å‡½æ•° ========== */
function draw(){
  // æ¸…ç©ºç”»å¸ƒï¼ˆèƒŒæ™¯ç”± body æ˜¾ç¤ºï¼‰
  ctx.clearRect(0,0,W,H);

  // ç»˜åˆ¶é‡‘å¸ï¼ˆcanvas å±‚ï¼‰
 // ç»˜åˆ¶é‡‘å¸ï¼ˆcanvas å±‚ï¼‰
coins.forEach(c=>{
  ctx.save();
  ctx.translate(c.x + c.size/2, c.y + c.size/2);
  ctx.rotate(c.rot);
  // é˜´å½±å’Œå‘å…‰
  ctx.shadowBlur = 18;
  ctx.shadowColor = 'rgba(255,200,240,0.9)';
  if (c.img && c.img.complete && c.img.naturalWidth) {
    ctx.drawImage(c.img, -c.size/2, -c.size/2, c.size, c.size);
  } else {
    // fallback â€” ç»˜åˆ¶æ¸å˜åœ†å½¢
    const g = ctx.createRadialGradient(0,0,c.size*0.1,0,0,c.size*0.9);
    g.addColorStop(0,'#fffdd8'); g.addColorStop(1,'#ffc94a');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(0,0,c.size/2,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
});

  // ç»˜åˆ¶ç¯®å­ï¼ˆå›¾æˆ–çŸ©å½¢ï¼‰
  if(basket.img){
    ctx.drawImage(basket.img, basket.x, basket.y, basket.w, basket.h);
  }else{
    // å…‰ç¯
    const grad = ctx.createRadialGradient(basket.x + basket.w/2, basket.y + 20, 10, basket.x + basket.w/2, basket.y + 20, 80);
    grad.addColorStop(0,'rgba(255,200,230,0.12)'); grad.addColorStop(1,'rgba(255,200,230,0)');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.ellipse(basket.x + basket.w/2, basket.y + basket.h - 5, basket.w*0.7, 22, 0, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = 'rgba(255,190,210,0.95)';
    ctx.fillRect(basket.x, basket.y, basket.w, basket.h*0.6);
  }

  // ç²’å­ç»˜åˆ¶
  for(let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    const age = Date.now() - p.born;
    if(age > p.life){ particles.splice(i,1); continue; }
    const a = 1 - age / p.life;
    ctx.globalAlpha = a;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    p.vy += 0.06;
    p.x += p.vx; p.y += p.vy;
  }

  // è¯·æ±‚ä¸‹ä¸€å¸§
  animReq = requestAnimationFrame(draw);
}

/* ========== æ”¶é›†é€»è¾‘ ========== */
function onCoinCollected(cx, cy){
  score++; 
  progress++;
  scoreElUpdate();
  spawnParticles(cx, cy);
  showPickupFly('+1', cx, cy);

  if (progress >= CONFIG.neededPerDialogue) {
    progress = 0;
    progressBar.style.width = '0%';
    setTimeout(()=>{ triggerDialogue(); }, 220);
  }
}

/* é£˜å­—æ•ˆæœï¼ˆçŸ­æš‚ï¼‰ */
function showPickupFly(text, x, y){
  const el = document.createElement('div');
  el.style.position = 'fixed';
  el.style.left = (x - 12) + 'px';
  el.style.top = (y - 20) + 'px';
  el.style.zIndex = 12;
  el.style.pointerEvents = 'none';
  el.style.color = '#fff';
  el.style.fontWeight = '700';
  el.style.textShadow = '0 6px 18px rgba(255,120,200,0.28)';
  el.textContent = text;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.transition = 'transform .9s ease-out, opacity .9s'; el.style.transform = 'translateY(-48px)'; el.style.opacity = '0'; });
  setTimeout(()=>el.remove(),900);
}

/* æ›´æ–° HUDï¼ˆåˆ†æ•°ä¸è¿›åº¦ï¼‰ */
function scoreElUpdate(){
  scoreEl.textContent = `ğŸ’° ${score}`;
  const pct = (progress / CONFIG.neededPerDialogue) * 100;
  progressBar.style.width = pct + '%';
}
/* ========== æ§åˆ¶äº¤äº’ï¼ˆæ”¯æŒé¼ æ ‡ã€è§¦æ§ä¸é”®ç›˜ï¼‰ ========== */
let isPointerDown = false;
window.addEventListener('pointerdown', e=>{ isPointerDown = true; moveBasketTo(e.clientX); });
window.addEventListener('pointermove', e=>{ if(isPointerDown) moveBasketTo(e.clientX); });
window.addEventListener('pointerup', e=>{ isPointerDown = false; });

function moveBasketTo(clientX){
  basket.x = clamp(clientX - basket.w/2, 8, W - basket.w - 8);
}

/* é”®ç›˜å·¦å³æ”¯æŒ */
window.addEventListener('keydown', e=>{
  const step = Math.max(24, Math.round(W/30));
  if(e.key === 'ArrowLeft' || e.key === 'a') basket.x = clamp(basket.x - step, 8, W - basket.w - 8);
  if(e.key === 'ArrowRight' || e.key === 'd') basket.x = clamp(basket.x + step, 8, W - basket.w - 8);
});

/* ========== é¿å…é»‘å±çš„ä¸»å¾ªç¯ï¼ˆåˆ†ç¦»ç»˜åˆ¶ä¸é€»è¾‘ï¼‰ ========== */
let logicTimer = null;
function startGameLoops(){
  // é€»è¾‘æ›´æ–°ï¼šé‡‘å¸ä¸‹è½ã€ç¢°æ’æ£€æŸ¥
  logicTimer = setInterval(()=>{
    // æ›´æ–°é‡‘å¸ä½ç½®å¹¶æ£€æµ‹ç¢°æ’
    for(let i = coins.length-1;i>=0;i--){
      const c = coins[i];
      c.y += c.speed;
      c.rot += 0.01;
      // ç¢°æ’ç®€å•AABB
      if(c.y + c.size > basket.y &&
         c.x + c.size > basket.x &&
         c.x < basket.x + basket.w){
        // æˆåŠŸæ”¶å–
        onCoinCollected(c.x + c.size/2, c.y + c.size/2);
        coins.splice(i,1);
      } else if(c.y > H + 80){
        coins.splice(i,1);
      }
    }
    // æ›´æ–°ç²’å­ä½ç½®ï¼ˆåœ¨ draw ä¸­å¤„ç†äº†å®é™…æ¸²æŸ“ï¼Œä½†å¯åœ¨æ­¤æ¸…ç†ï¼‰
  }, 30);

  // ç»˜åˆ¶å¾ªç¯ï¼ˆé«˜ä¼˜å…ˆï¼‰
  if(!animReq) draw();
}

/* ========== å¼€åœºç‰¹æ•ˆï¼ˆæ¯æ¬¡ç‚¹å‡» start æ‰§è¡Œï¼‰ ========== */
/* 1) äº®åº¦æ¸å˜ï¼ˆç”¨é®ç½©å±‚ï¼‰ 2) DOM æ˜Ÿå…‰æ¼‚æµ®åŠ¨ç”» 3) æŒç»­ CONFIG.introDuration æ¯«ç§’ */
function playIntroEffectAndStart(){
  // åˆ›å»ºçŸ­æš‚é®ç½©å®ç°ä»æš—åˆ°äº®çš„æ·¡å…¥
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(5,2,15,0.85)';
  overlay.style.zIndex = 30;
  overlay.style.pointerEvents = 'none';
  document.body.appendChild(overlay);

  // ç”Ÿæˆè‹¥å¹²æ˜Ÿå…‰å…ƒç´ åˆ° starsLayerï¼ˆéšæœºä½ç½®ã€å°å¹…ä¸Šå‡ï¼‰
  const starCount = Math.floor(rand(CONFIG.starMin, CONFIG.starMax+1));
  for(let i=0;i<starCount;i++){
    const s = document.createElement('div');
    s.className = 'star';
    const size = rand(4,10);
    s.style.width = s.style.height = size + 'px';
    s.style.left = (rand(6,94)) + '%';
    s.style.top = (rand(40,84)) + '%';
    s.style.background = Math.random() < 0.6 ? 'rgba(255,230,250,0.95)' : 'rgba(255,245,190,0.95)';
    s.style.animationDuration = (1.8 + Math.random()*1.2) + 's';
    starsLayer.appendChild(s);
    // åœ¨åŠ¨ç”»ç»“æŸåç§»é™¤è¯¥ starï¼ˆä¸ overlay ä¸€èµ·ï¼‰
    setTimeout(()=>{ if(s.parentNode) s.parentNode.removeChild(s); }, CONFIG.introDuration + 300);
  }

  // æ·¡å‡ºé®ç½©ï¼ˆä½¿ç”»é¢ä»æš—åˆ°äº®ï¼‰
  overlay.animate([{opacity:1},{opacity:0}],{duration:CONFIG.introDuration,fill:'forwards',easing:'ease-out'});
  setTimeout(()=>{ if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, CONFIG.introDuration + 80);

  // å¼€å§‹æ¸¸æˆå¾ªç¯ï¼ˆå»¶è¿Ÿä¸ç‰¹æ•ˆé•¿åº¦ä¸€è‡´ï¼‰
  setTimeout(()=>{
    // å¯åŠ¨å®é™…ç”Ÿæˆå’Œå¾ªç¯
    if(spawnTimer) clearInterval(spawnTimer); // é˜²æ­¢é‡å¤
    spawnTimer = setInterval(spawnCoin, CONFIG.spawnInterval);
    startGameLoops();
    running = true;
  }, CONFIG.introDuration);
}

 /* ========== å¯¹è¯è§¦å‘å™¨ï¼ˆç»‘å®šåˆ°è¿›åº¦æ»¡ï¼‰ ========== */   
/* ========== å¯¹è¯è§¦å‘å™¨ ========== */
function triggerDialogue() {
  if (dialogVisible) return;
  dialogVisible = true;

  // è§’è‰²ï¼špic1 = è§å°äº”ï¼Œpic2 = å…”å­å°å§
  const pick = Math.random() < 0.5 ? 'pic1' : 'pic2';
  const conf = DIALOGUES[pick];   

  /* -------- å¤„ç†å›¾ç‰‡è½®æ’­æ±  -------- */
  const poolName = pick + 'Pool';      
  const fileList = CONFIG[pick + 'Files'];

  if (!window[poolName] || window[poolName].length === 0)
    window[poolName] = [...fileList];

  const index = Math.floor(Math.random() * window[poolName].length);
  const chosenFile = window[poolName].splice(index, 1)[0];

  dialogPic.src = CONFIG.imagesPath + chosenFile;

  /* -------- é€‰æ‹©å°è¯ï¼ˆå›¾ç‰‡ç»‘å®šä¼˜å…ˆï¼‰ -------- */
  const prev = dialogLine.dataset.prev || "";
  const fileName = chosenFile;
  let nextLine = "";

  if (PHOTO_DIALOGUES[fileName]) {
    nextLine = PHOTO_DIALOGUES[fileName]; // å›¾ç‰‡ä¸“å±å°è¯
  } else {
    // è§’è‰²éšæœºå°è¯
    nextLine = conf.lines[Math.floor(Math.random() * conf.lines.length)];

    if (conf.lines.length > 1) {
      let tries = 0;
      while (nextLine === prev && tries++ < 6) {
        nextLine = conf.lines[Math.floor(Math.random() * conf.lines.length)];
      }
    }
  }

 dialogLine.textContent = "";
typeWriter(nextLine);
  dialogLine.dataset.prev = nextLine;

  /* -------- æ ·å¼ï¼ˆåå­—é‡‘è‰²ï¼›å°è¯æŒ‰è§’è‰²å˜è‰²ï¼‰ -------- */
  dialogName.textContent = conf.name;
  dialogName.style.color = "#FFD700"; // é‡‘è‰²åå­—

  if (pick === 'pic1') {
    dialogLine.style.color = "#00FF9C"; // ç¿ ç»¿ï¼ˆè§å°äº”ï¼‰
    dialogBox.style.background = "rgba(128,0,0,0.35)";
  } else {
    dialogLine.style.color = "#e64a1c"; // é…’çº¢ï¼ˆå…”å­å°å§ï¼‰
    dialogBox.style.background = "rgba(0,255,128,0.35)";
  }
function typeWriter(text) {
  let i = 0;
  dialogLine.textContent = "";
  const speed = 30;

  function typing() {
    if (i < text.length) {
      dialogLine.textContent += text.charAt(i);
      i++;
      requestAnimationFrame(typing);
    }
  }
  typing();
}
  /* -------- æ˜¾ç¤ºå¯¹è¯æ¡† -------- */
  dialogBox.classList.add('show');
  dialogBox.style.bottom = (H - basket.y + 20) + 'px';

  setTimeout(() => {
    dialogBox.classList.remove('show');
    dialogVisible = false;
  }, 3000);
}

/* ========== é¡µé¢äº¤äº’ï¼šstart æŒ‰é’®ç»‘å®šï¼ˆå¿…é¡»çš„ç”¨æˆ·äº¤äº’ï¼Œå…¼å®¹ iOSï¼‰ ========== */
startBtn.addEventListener('click', ()=>{
  // éšè— start è¦†ç›–ï¼ˆè§†è§‰ä¸Šå…ˆéšè—ï¼‰
  startOverlay.style.display = 'none';
  // æ’­æ”¾å¼€åœºç‰¹æ•ˆå¹¶åœ¨å…¶åå¯åŠ¨æ¸¸æˆå¾ªç¯
  playIntroEffectAndStart();
  spawnTimer = setInterval(spawnCoin, CONFIG.spawnInterval);
});

/* ========== çª—å£è°ƒæ•´æ—¶è‡ªé€‚åº” ========== */
window.addEventListener('resize', ()=>{
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  // ä¿®æ­£ç¯®å­ x é¿å…å‡ºç•Œ
  basket.x = clamp(basket.x, 8, W - basket.w - 8);
});

/* ========== æ•è·ç‚¹å‡»é‡‘å¸ï¼ˆæ”¯æŒé¼ æ ‡ç‚¹å‡»æ”¶é›†ï¼‰ ========== */
canvas.addEventListener('click', (e)=>{
  // ç‚¹å‡»ç›´æ¥æ£€æµ‹é™„è¿‘é‡‘å¸
  const rect = canvas.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;
  for(let i = coins.length-1; i>=0; i--){
    const c = coins[i];
    const dx = cx - (c.x + c.size/2);
    const dy = cy - (c.y + c.size/2);
    if(Math.sqrt(dx*dx + dy*dy) < c.size){
      // ç›´æ¥æ”¶å–
      coins.splice(i,1);
      onCoinCollected(cx, cy);
      break;
    }
  }
});

/* ========== åˆå§‹åŒ–ç»˜åˆ¶å¾ªç¯ï¼ˆç”»é¢ä¸ä¼šé»‘å±ï¼‰ ========== */
/* draw() å·²ç»åœ¨é¡¶éƒ¨å®šä¹‰ï¼Œä¼šè¢« startGameLoops å¯åŠ¨ã€‚æˆ‘ä»¬æå‰ç»˜åˆ¶ä¸€æ¬¡é™æ€ç”»é¢é¿å…æ‰“å¼€æ—¶é»‘å±æ„Ÿ */
(function initialPaint(){
  ctx.clearRect(0,0,W,H);
  // ç”»ä¸€ä¸ªæ·¡è‰²æ¸å˜ä½œä¸ºå ä½ï¼ˆé¿å…çº¯é»‘ï¼‰
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'rgba(20,10,40,0.35)');
  g.addColorStop(1,'rgba(3,1,9,0.55)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // åˆå§‹ç»˜åˆ¶ç¯®å­å ä½
  if(basket.img){ ctx.drawImage(basket.img, basket.x, basket.y, basket.w, basket.h); }
  else{
    ctx.fillStyle = 'rgba(255,192,203,0.9)';
    ctx.fillRect(basket.x, basket.y, basket.w, basket.h*0.6);
  }
})();

/* ========== é˜²æ­¢å†…å­˜æ³„æ¼ï¼šå¯åœ¨æ­¤å¤„æ·»åŠ åœæ­¢å‡½æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰ ========== */
/* function stopGame() { clearInterval(spawnTimer); clearInterval(logicTimer); cancelAnimationFrame(animReq); } */

</script>
</body>
</html>